From fb32f48bb36a4ac3338461a6b1d6ac7065e7b5f6 Mon Sep 17 00:00:00 2001
From: Simon Pilgrim <llvm-dev@redking.me.uk>
Date: Mon, 8 Sep 2025 17:41:12 +0100
Subject: [PATCH] [llvm-mca][x86] Sync resource tests using generic base
 references

Some of the targets isa test coverage seems to have bitrotted or is just missing - resync with the generic reference code
---
 .../llvm-mca/X86/Znver2/resources-cmpxchg.s   |  8 +-
 .../llvm-mca/X86/Znver3/resources-cmpxchg.s   |  8 +-
 .../llvm-mca/X86/Znver4/resources-mwaitx.s    | 51 ++++++++++
 .../tools/llvm-mca/X86/Znver4/resources-sha.s | 93 +++++++++++++++++++
 .../llvm-mca/X86/Znver4/resources-sse4a.s     | 65 +++++++++++++
 5 files changed, 223 insertions(+), 2 deletions(-)
 create mode 100644 llvm/test/tools/llvm-mca/X86/Znver4/resources-mwaitx.s
 create mode 100644 llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s
 create mode 100644 llvm/test/tools/llvm-mca/X86/Znver4/resources-sse4a.s

diff --git a/llvm/test/tools/llvm-mca/X86/Znver2/resources-cmpxchg.s b/llvm/test/tools/llvm-mca/X86/Znver2/resources-cmpxchg.s
index 35492c3edf3a1..8765dbd37e8b7 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver2/resources-cmpxchg.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver2/resources-cmpxchg.s
@@ -3,6 +3,8 @@
 
 cmpxchg8b  (%rax)
 cmpxchg16b (%rax)
+lock cmpxchg8b  (%rax)
+lock cmpxchg16b (%rax)
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -15,6 +17,8 @@ cmpxchg16b (%rax)
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
 # CHECK-NEXT:  18     1     0.33    *      *            cmpxchg8b	(%rax)
 # CHECK-NEXT:  1      100   0.25    *      *            cmpxchg16b	(%rax)
+# CHECK-NEXT:  18     1     0.33    *      *            lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  1      100   0.25    *      *            lock		cmpxchg16b	(%rax)
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn2AGU0
@@ -33,9 +37,11 @@ cmpxchg16b (%rax)
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]
-# CHECK-NEXT: 0.33   0.33   0.33   0.25   0.25   0.25   0.25    -      -      -      -      -      -
+# CHECK-NEXT: 0.67   0.67   0.67   0.50   0.50   0.50   0.50    -      -      -      -      -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]   Instructions:
 # CHECK-NEXT: 0.33   0.33   0.33   0.25   0.25   0.25   0.25    -      -      -      -      -      -     cmpxchg8b	(%rax)
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg16b	(%rax)
+# CHECK-NEXT: 0.33   0.33   0.33   0.25   0.25   0.25   0.25    -      -      -      -      -      -     lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg16b	(%rax)
diff --git a/llvm/test/tools/llvm-mca/X86/Znver3/resources-cmpxchg.s b/llvm/test/tools/llvm-mca/X86/Znver3/resources-cmpxchg.s
index 9ab877636b29a..1667171148a3b 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver3/resources-cmpxchg.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver3/resources-cmpxchg.s
@@ -3,6 +3,8 @@
 
 cmpxchg8b  (%rax)
 cmpxchg16b (%rax)
+lock cmpxchg8b  (%rax)
+lock cmpxchg16b (%rax)
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -15,6 +17,8 @@ cmpxchg16b (%rax)
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
 # CHECK-NEXT:  19     3     6.00    *      *            cmpxchg8b	(%rax)
 # CHECK-NEXT:  28     4     14.75   *      *            cmpxchg16b	(%rax)
+# CHECK-NEXT:  19     3     6.00    *      *            lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  28     4     14.75   *      *            lock		cmpxchg16b	(%rax)
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn3AGU0
@@ -43,9 +47,11 @@ cmpxchg16b (%rax)
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -     20.75  20.75  20.75  20.75   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -
+# CHECK-NEXT:  -      -      -     41.50  41.50  41.50  41.50   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
 # CHECK-NEXT:  -      -      -     6.00   6.00   6.00   6.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg8b	(%rax)
 # CHECK-NEXT:  -      -      -     14.75  14.75  14.75  14.75   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg16b	(%rax)
+# CHECK-NEXT:  -      -      -     6.00   6.00   6.00   6.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  -      -      -     14.75  14.75  14.75  14.75   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg16b	(%rax)
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-mwaitx.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-mwaitx.s
new file mode 100644
index 0000000000000..f42a35e5d3ce0
--- /dev/null
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-mwaitx.s
@@ -0,0 +1,51 @@
+# NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
+# RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=znver4 -instruction-tables < %s | FileCheck %s
+
+monitorx
+mwaitx
+
+# CHECK:      Instruction Info:
+# CHECK-NEXT: [1]: #uOps
+# CHECK-NEXT: [2]: Latency
+# CHECK-NEXT: [3]: RThroughput
+# CHECK-NEXT: [4]: MayLoad
+# CHECK-NEXT: [5]: MayStore
+# CHECK-NEXT: [6]: HasSideEffects (U)
+
+# CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
+# CHECK-NEXT:  100    100   25.00                 U     monitorx
+# CHECK-NEXT:  100    100   25.00                 U     mwaitx
+
+# CHECK:      Resources:
+# CHECK-NEXT: [0]   - Zn4AGU0
+# CHECK-NEXT: [1]   - Zn4AGU1
+# CHECK-NEXT: [2]   - Zn4AGU2
+# CHECK-NEXT: [3]   - Zn4ALU0
+# CHECK-NEXT: [4]   - Zn4ALU1
+# CHECK-NEXT: [5]   - Zn4ALU2
+# CHECK-NEXT: [6]   - Zn4ALU3
+# CHECK-NEXT: [7]   - Zn4BRU1
+# CHECK-NEXT: [8]   - Zn4FP0
+# CHECK-NEXT: [9]   - Zn4FP1
+# CHECK-NEXT: [10]  - Zn4FP2
+# CHECK-NEXT: [11]  - Zn4FP3
+# CHECK-NEXT: [12.0] - Zn4FP45
+# CHECK-NEXT: [12.1] - Zn4FP45
+# CHECK-NEXT: [13]  - Zn4FPSt
+# CHECK-NEXT: [14.0] - Zn4LSU
+# CHECK-NEXT: [14.1] - Zn4LSU
+# CHECK-NEXT: [14.2] - Zn4LSU
+# CHECK-NEXT: [15.0] - Zn4Load
+# CHECK-NEXT: [15.1] - Zn4Load
+# CHECK-NEXT: [15.2] - Zn4Load
+# CHECK-NEXT: [16.0] - Zn4Store
+# CHECK-NEXT: [16.1] - Zn4Store
+
+# CHECK:      Resource pressure per iteration:
+# CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
+# CHECK-NEXT:  -      -      -     50.00  50.00  50.00  50.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -
+
+# CHECK:      Resource pressure by instruction:
+# CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
+# CHECK-NEXT:  -      -      -     25.00  25.00  25.00  25.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     monitorx
+# CHECK-NEXT:  -      -      -     25.00  25.00  25.00  25.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     mwaitx
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s
new file mode 100644
index 0000000000000..553466c35c9fe
--- /dev/null
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s
@@ -0,0 +1,93 @@
+# NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
+# RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=znver4 -instruction-tables < %s | FileCheck %s
+
+sha1msg1    %xmm0, %xmm2
+sha1msg1    (%rax), %xmm2
+
+sha1msg2    %xmm0, %xmm2
+sha1msg2    (%rax), %xmm2
+
+sha1nexte   %xmm0, %xmm2
+sha1nexte   (%rax), %xmm2
+
+sha1rnds4   $3, %xmm0, %xmm2
+sha1rnds4   $3, (%rax), %xmm2
+
+sha256msg1  %xmm0, %xmm2
+sha256msg1  (%rax), %xmm2
+
+sha256msg2  %xmm0, %xmm2
+sha256msg2  (%rax), %xmm2
+
+sha256rnds2 %xmm0, %xmm2
+sha256rnds2 (%rax), %xmm2
+
+# CHECK:      Instruction Info:
+# CHECK-NEXT: [1]: #uOps
+# CHECK-NEXT: [2]: Latency
+# CHECK-NEXT: [3]: RThroughput
+# CHECK-NEXT: [4]: MayLoad
+# CHECK-NEXT: [5]: MayStore
+# CHECK-NEXT: [6]: HasSideEffects (U)
+
+# CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
+# CHECK-NEXT:  2      2     0.50                        sha1msg1	%xmm0, %xmm2
+# CHECK-NEXT:  2      6     0.50    *                   sha1msg1	(%rax), %xmm2
+# CHECK-NEXT:  1      1     0.50                        sha1msg2	%xmm0, %xmm2
+# CHECK-NEXT:  1      5     0.50    *                   sha1msg2	(%rax), %xmm2
+# CHECK-NEXT:  1      1     0.50                        sha1nexte	%xmm0, %xmm2
+# CHECK-NEXT:  1      5     0.50    *                   sha1nexte	(%rax), %xmm2
+# CHECK-NEXT:  1      6     2.00                        sha1rnds4	$3, %xmm0, %xmm2
+# CHECK-NEXT:  1      10    0.50    *                   sha1rnds4	$3, (%rax), %xmm2
+# CHECK-NEXT:  2      2     0.75                        sha256msg1	%xmm0, %xmm2
+# CHECK-NEXT:  2      6     0.75    *                   sha256msg1	(%rax), %xmm2
+# CHECK-NEXT:  4      3     2.00                        sha256msg2	%xmm0, %xmm2
+# CHECK-NEXT:  5      7     2.00    *                   sha256msg2	(%rax), %xmm2
+# CHECK-NEXT:  1      4     2.00                        sha256rnds2	%xmm0, %xmm0, %xmm2
+# CHECK-NEXT:  1      10    0.50    *                   sha256rnds2	%xmm0, (%rax), %xmm2
+
+# CHECK:      Resources:
+# CHECK-NEXT: [0]   - Zn4AGU0
+# CHECK-NEXT: [1]   - Zn4AGU1
+# CHECK-NEXT: [2]   - Zn4AGU2
+# CHECK-NEXT: [3]   - Zn4ALU0
+# CHECK-NEXT: [4]   - Zn4ALU1
+# CHECK-NEXT: [5]   - Zn4ALU2
+# CHECK-NEXT: [6]   - Zn4ALU3
+# CHECK-NEXT: [7]   - Zn4BRU1
+# CHECK-NEXT: [8]   - Zn4FP0
+# CHECK-NEXT: [9]   - Zn4FP1
+# CHECK-NEXT: [10]  - Zn4FP2
+# CHECK-NEXT: [11]  - Zn4FP3
+# CHECK-NEXT: [12.0] - Zn4FP45
+# CHECK-NEXT: [12.1] - Zn4FP45
+# CHECK-NEXT: [13]  - Zn4FPSt
+# CHECK-NEXT: [14.0] - Zn4LSU
+# CHECK-NEXT: [14.1] - Zn4LSU
+# CHECK-NEXT: [14.2] - Zn4LSU
+# CHECK-NEXT: [15.0] - Zn4Load
+# CHECK-NEXT: [15.1] - Zn4Load
+# CHECK-NEXT: [15.2] - Zn4Load
+# CHECK-NEXT: [16.0] - Zn4Store
+# CHECK-NEXT: [16.1] - Zn4Store
+
+# CHECK:      Resource pressure per iteration:
+# CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
+# CHECK-NEXT: 1.67   1.67   1.67    -      -      -      -      -     13.50  12.50  12.50  13.50  1.00   1.00    -     2.33   2.33   2.33   2.33   2.33   2.33    -      -
+
+# CHECK:      Resource pressure by instruction:
+# CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50   0.50   0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     sha1msg1	%xmm0, %xmm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -     0.50   0.50   0.50   0.50    -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha1msg1	(%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50   0.50   0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     sha1msg2	%xmm0, %xmm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -     0.50   0.50   0.50   0.50    -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha1msg2	(%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50   0.50   0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     sha1nexte	%xmm0, %xmm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -     0.50   0.50   0.50   0.50    -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha1nexte	(%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00   2.00    -      -      -      -      -      -      -      -      -      -      -     sha1rnds4	$3, %xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha1rnds4	$3, (%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.75   0.75   0.75   0.75    -      -      -      -      -      -      -      -      -      -      -     sha256msg1	%xmm0, %xmm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -     0.75   0.75   0.75   0.75    -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha256msg1	(%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00   2.00    -      -      -      -      -      -      -      -      -      -      -     sha256msg2	%xmm0, %xmm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -     2.00   2.00   2.00   2.00    -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha256msg2	(%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00   2.00    -      -      -      -      -      -      -      -      -      -      -     sha256rnds2	%xmm0, %xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     sha256rnds2	%xmm0, (%rax), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse4a.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse4a.s
new file mode 100644
index 0000000000000..36f7604d5efac
--- /dev/null
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse4a.s
@@ -0,0 +1,65 @@
+# NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
+# RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=znver4 -instruction-tables < %s | FileCheck %s
+
+extrq       %xmm0, %xmm2
+extrq       $22, $2, %xmm2
+
+insertq     %xmm0, %xmm2
+insertq     $22, $22, %xmm0, %xmm2
+
+movntsd     %xmm0, (%rax)
+movntss     %xmm0, (%rax)
+
+# CHECK:      Instruction Info:
+# CHECK-NEXT: [1]: #uOps
+# CHECK-NEXT: [2]: Latency
+# CHECK-NEXT: [3]: RThroughput
+# CHECK-NEXT: [4]: MayLoad
+# CHECK-NEXT: [5]: MayStore
+# CHECK-NEXT: [6]: HasSideEffects (U)
+
+# CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
+# CHECK-NEXT:  1      3     0.50                        extrq	%xmm0, %xmm2
+# CHECK-NEXT:  2      3     0.50                        extrq	$22, $2, %xmm2
+# CHECK-NEXT:  1      3     0.50                        insertq	%xmm0, %xmm2
+# CHECK-NEXT:  2      3     0.50                        insertq	$22, $22, %xmm0, %xmm2
+# CHECK-NEXT:  1      1     1.00           *            movntsd	%xmm0, (%rax)
+# CHECK-NEXT:  1      1     1.00           *            movntss	%xmm0, (%rax)
+
+# CHECK:      Resources:
+# CHECK-NEXT: [0]   - Zn4AGU0
+# CHECK-NEXT: [1]   - Zn4AGU1
+# CHECK-NEXT: [2]   - Zn4AGU2
+# CHECK-NEXT: [3]   - Zn4ALU0
+# CHECK-NEXT: [4]   - Zn4ALU1
+# CHECK-NEXT: [5]   - Zn4ALU2
+# CHECK-NEXT: [6]   - Zn4ALU3
+# CHECK-NEXT: [7]   - Zn4BRU1
+# CHECK-NEXT: [8]   - Zn4FP0
+# CHECK-NEXT: [9]   - Zn4FP1
+# CHECK-NEXT: [10]  - Zn4FP2
+# CHECK-NEXT: [11]  - Zn4FP3
+# CHECK-NEXT: [12.0] - Zn4FP45
+# CHECK-NEXT: [12.1] - Zn4FP45
+# CHECK-NEXT: [13]  - Zn4FPSt
+# CHECK-NEXT: [14.0] - Zn4LSU
+# CHECK-NEXT: [14.1] - Zn4LSU
+# CHECK-NEXT: [14.2] - Zn4LSU
+# CHECK-NEXT: [15.0] - Zn4Load
+# CHECK-NEXT: [15.1] - Zn4Load
+# CHECK-NEXT: [15.2] - Zn4Load
+# CHECK-NEXT: [16.0] - Zn4Store
+# CHECK-NEXT: [16.1] - Zn4Store
+
+# CHECK:      Resource pressure per iteration:
+# CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     2.00   2.00    -     3.00   3.00   2.00   0.67   0.67   0.67    -      -      -     1.00   1.00
+
+# CHECK:      Resource pressure by instruction:
+# CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -      -      -      -      -      -      -      -      -     extrq	%xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -      -      -      -      -      -      -      -      -     extrq	$22, $2, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -      -      -      -      -      -      -      -      -     insertq	%xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -      -      -      -      -      -      -      -      -     insertq	$22, $22, %xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -     0.50   0.50   1.00   0.33   0.33   0.33    -      -      -     0.50   0.50   movntsd	%xmm0, (%rax)
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -     0.50   0.50   1.00   0.33   0.33   0.33    -      -      -     0.50   0.50   movntss	%xmm0, (%rax)
From 78b239d0cd7315efa073f680cd8bf01b498b2b60 Mon Sep 17 00:00:00 2001
From: Simon Pilgrim <llvm-dev@redking.me.uk>
Date: Tue, 9 Sep 2025 10:11:10 +0100
Subject: [PATCH] [X86] Ensure models use vector load latency for vector loads

Noticed while addressing #146564 - some of the znver3/4 overrides for vector ops were using the scalar load latencies by mistake
---
 llvm/lib/Target/X86/X86ScheduleZnver3.td      | 20 +++++++++----------
 llvm/lib/Target/X86/X86ScheduleZnver4.td      | 20 +++++++++----------
 .../llvm-mca/X86/Znver3/resources-avx1.s      |  6 +++---
 .../llvm-mca/X86/Znver3/resources-avx2.s      | 10 +++++-----
 .../tools/llvm-mca/X86/Znver3/resources-sha.s | 10 +++++-----
 .../llvm-mca/X86/Znver4/resources-avx1.s      |  6 +++---
 .../llvm-mca/X86/Znver4/resources-avx2.s      | 10 +++++-----
 .../tools/llvm-mca/X86/Znver4/resources-sha.s | 10 +++++-----
 8 files changed, 46 insertions(+), 46 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver3.td b/llvm/lib/Target/X86/X86ScheduleZnver3.td
index 9e271c1ee3709..044b77f7aacf4 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver3.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver3.td
@@ -992,14 +992,14 @@ def Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr : SchedWriteRes<[Zn3FPFMisc0]> {
 def : InstRW<[Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr], (instrs VEXTRACTF128rri, VEXTRACTI128rri)>;
 
 def Zn3WriteVEXTRACTI128mr : SchedWriteRes<[Zn3FPFMisc0, Zn3FPSt, Zn3Store]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
   let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = !add(Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr.NumMicroOps, 1);
 }
 def : InstRW<[Zn3WriteVEXTRACTI128mr], (instrs VEXTRACTI128mri, VEXTRACTF128mri)>;
 
 def Zn3WriteVINSERTF128rmr : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPFMisc0]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
   let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = !add(Zn3WriteVEXTRACTF128rr_VEXTRACTI128rr.NumMicroOps, 0);
 }
@@ -1221,7 +1221,7 @@ def Zn3WriteSHA1MSG1rr : SchedWriteRes<[Zn3FPU0123]> {
 def : InstRW<[Zn3WriteSHA1MSG1rr], (instrs SHA1MSG1rr)>;
 
 def Zn3WriteSHA1MSG1rm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPU0123]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteSHA1MSG1rr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteSHA1MSG1rr.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn3WriteSHA1MSG1rr.NumMicroOps, 0);
 }
@@ -1235,7 +1235,7 @@ def Zn3WriteSHA1MSG2rr_SHA1NEXTErr : SchedWriteRes<[Zn3FPU0123]> {
 def : InstRW<[Zn3WriteSHA1MSG2rr_SHA1NEXTErr], (instrs SHA1MSG2rr, SHA1NEXTErr)>;
 
 def Zn3Writerm_SHA1MSG2rm_SHA1NEXTErm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPU0123]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteSHA1MSG2rr_SHA1NEXTErr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteSHA1MSG2rr_SHA1NEXTErr.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn3WriteSHA1MSG2rr_SHA1NEXTErr.NumMicroOps, 0);
 }
@@ -1249,7 +1249,7 @@ def Zn3WriteSHA256MSG1rr : SchedWriteRes<[Zn3FPU0123]> {
 def : InstRW<[Zn3WriteSHA256MSG1rr], (instrs SHA256MSG1rr)>;
 
 def Zn3Writerm_SHA256MSG1rm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPU0123]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteSHA256MSG1rr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteSHA256MSG1rr.Latency);
   let ReleaseAtCycles = [1, 1, 3];
   let NumMicroOps = !add(Zn3WriteSHA256MSG1rr.NumMicroOps, 0);
 }
@@ -1263,7 +1263,7 @@ def Zn3WriteSHA256MSG2rr : SchedWriteRes<[Zn3FPU0123]> {
 def : InstRW<[Zn3WriteSHA256MSG2rr], (instrs SHA256MSG2rr)>;
 
 def Zn3WriteSHA256MSG2rm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPU0123]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteSHA256MSG2rr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteSHA256MSG2rr.Latency);
   let ReleaseAtCycles = [1, 1, 8];
   let NumMicroOps = !add(Zn3WriteSHA256MSG2rr.NumMicroOps, 1);
 }
@@ -1338,14 +1338,14 @@ def Zn3WriteVPERM2I128rr_VPERM2F128rr : SchedWriteRes<[Zn3FPVShuf]> {
 def : InstRW<[Zn3WriteVPERM2I128rr_VPERM2F128rr], (instrs VPERM2I128rri, VPERM2F128rri)>;
 
 def Zn3WriteVPERM2F128rm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPVShuf]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteVPERM2I128rr_VPERM2F128rr.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteVPERM2I128rr_VPERM2F128rr.Latency);
   let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = !add(Zn3WriteVPERM2I128rr_VPERM2F128rr.NumMicroOps, 0);
 }
 def : InstRW<[Zn3WriteVPERM2F128rm], (instrs VPERM2F128rmi)>;
 
 def Zn3WriteVPERMPSYrm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPVShuf]> {
-  let Latency = !add(Znver3Model.LoadLatency, 7);
+  let Latency = !add(Znver3Model.VecLoadLatency, 7);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = 3;
 }
@@ -1359,14 +1359,14 @@ def Zn3WriteVPERMYri : SchedWriteRes<[Zn3FPVShuf]> {
 def : InstRW<[Zn3WriteVPERMYri], (instrs VPERMPDYri, VPERMQYri)>;
 
 def Zn3WriteVPERMPDYmi : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPVShuf]> {
-  let Latency = !add(Znver3Model.LoadLatency, Zn3WriteVPERMYri.Latency);
+  let Latency = !add(Znver3Model.VecLoadLatency, Zn3WriteVPERMYri.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn3WriteVPERMYri.NumMicroOps, 1);
 }
 def : InstRW<[Zn3WriteVPERMPDYmi], (instrs VPERMPDYmi)>;
 
 def Zn3WriteVPERMDYm : SchedWriteRes<[Zn3AGU012, Zn3Load, Zn3FPVShuf]> {
-  let Latency = !add(Znver3Model.LoadLatency, 5);
+  let Latency = !add(Znver3Model.VecLoadLatency, 5);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = 2;
 }
diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 74d916d41f831..f4b8f8927b1b5 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1005,14 +1005,14 @@ def Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr : SchedWriteRes<[Zn4FPFMisc0]> {
 def : InstRW<[Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr], (instrs VEXTRACTF128rri, VEXTRACTI128rri)>;
 
 def Zn4WriteVEXTRACTI128mr : SchedWriteRes<[Zn4FPFMisc0, Zn4FPSt, Zn4Store]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
   let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = !add(Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr.NumMicroOps, 1);
 }
 def : InstRW<[Zn4WriteVEXTRACTI128mr], (instrs VEXTRACTI128mri, VEXTRACTF128mri)>;
 
 def Zn4WriteVINSERTF128rmr : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPFMisc0]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr.Latency);
   let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = !add(Zn4WriteVEXTRACTF128rr_VEXTRACTI128rr.NumMicroOps, 0);
 }
@@ -1262,7 +1262,7 @@ def Zn4WriteSHA1MSG1rr : SchedWriteRes<[Zn4FPU0123]> {
 def : InstRW<[Zn4WriteSHA1MSG1rr], (instrs SHA1MSG1rr)>;
 
 def Zn4WriteSHA1MSG1rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPU0123]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteSHA1MSG1rr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteSHA1MSG1rr.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn4WriteSHA1MSG1rr.NumMicroOps, 0);
 }
@@ -1276,7 +1276,7 @@ def Zn4WriteSHA1MSG2rr_SHA1NEXTErr : SchedWriteRes<[Zn4FPU0123]> {
 def : InstRW<[Zn4WriteSHA1MSG2rr_SHA1NEXTErr], (instrs SHA1MSG2rr, SHA1NEXTErr)>;
 
 def Zn4Writerm_SHA1MSG2rm_SHA1NEXTErm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPU0123]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteSHA1MSG2rr_SHA1NEXTErr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteSHA1MSG2rr_SHA1NEXTErr.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn4WriteSHA1MSG2rr_SHA1NEXTErr.NumMicroOps, 0);
 }
@@ -1290,7 +1290,7 @@ def Zn4WriteSHA256MSG1rr : SchedWriteRes<[Zn4FPU0123]> {
 def : InstRW<[Zn4WriteSHA256MSG1rr], (instrs SHA256MSG1rr)>;
 
 def Zn4Writerm_SHA256MSG1rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPU0123]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteSHA256MSG1rr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteSHA256MSG1rr.Latency);
   let ReleaseAtCycles = [1, 1, 3];
   let NumMicroOps = !add(Zn4WriteSHA256MSG1rr.NumMicroOps, 0);
 }
@@ -1304,7 +1304,7 @@ def Zn4WriteSHA256MSG2rr : SchedWriteRes<[Zn4FPU0123]> {
 def : InstRW<[Zn4WriteSHA256MSG2rr], (instrs SHA256MSG2rr)>;
 
 def Zn4WriteSHA256MSG2rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPU0123]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteSHA256MSG2rr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteSHA256MSG2rr.Latency);
   let ReleaseAtCycles = [1, 1, 8];
   let NumMicroOps = !add(Zn4WriteSHA256MSG2rr.NumMicroOps, 1);
 }
@@ -1379,7 +1379,7 @@ def Zn4WriteVPERM2I128rr_VPERM2F128rr : SchedWriteRes<[Zn4FPVShuf]> {
 def : InstRW<[Zn4WriteVPERM2I128rr_VPERM2F128rr], (instrs VPERM2I128rri, VPERM2F128rri)>;
 
 def Zn4WriteVPERM2F128rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteVPERM2I128rr_VPERM2F128rr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERM2I128rr_VPERM2F128rr.Latency);
   let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = !add(Zn4WriteVPERM2I128rr_VPERM2F128rr.NumMicroOps, 0);
 }
@@ -1393,7 +1393,7 @@ def Zn4WriteVPERMPSYrr : SchedWriteRes<[Zn4FPVShuf]> {
 def : InstRW<[Zn4WriteVPERMPSYrr], (instrs VPERMPSYrr)>;
 
 def Zn4WriteVPERMPSYrm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteVPERMPSYrr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMPSYrr.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn4WriteVPERMPSYrr.NumMicroOps, 1);
 }
@@ -1407,7 +1407,7 @@ def Zn4WriteVPERMYri : SchedWriteRes<[Zn4FPVShuf]> {
 def : InstRW<[Zn4WriteVPERMYri], (instrs VPERMPDYri, VPERMQYri)>;
 
 def Zn4WriteVPERMPDYmi : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteVPERMYri.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMYri.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn4WriteVPERMYri.NumMicroOps, 1);
 }
@@ -1421,7 +1421,7 @@ def Zn4WriteVPERMDYrr : SchedWriteRes<[Zn4FPVShuf]> {
 def : InstRW<[Zn4WriteVPERMDYrr], (instrs VPERMDYrr)>;
 
 def Zn4WriteVPERMYm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
-  let Latency = !add(Znver4Model.LoadLatency, Zn4WriteVPERMDYrr.Latency);
+  let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMDYrr.Latency);
   let ReleaseAtCycles = [1, 1, 2];
   let NumMicroOps = !add(Zn4WriteVPERMDYrr.NumMicroOps, 0);
 }
diff --git a/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx1.s b/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx1.s
index 4f0b4843d1704..0abf8ad61a4a0 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx1.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx1.s
@@ -1193,7 +1193,7 @@ vzeroupper
 # CHECK-NEXT:  7      15    4.00                        vdpps	$22, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  8      22    4.00    *                   vdpps	$22, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      4     1.00                        vextractf128	$1, %ymm0, %xmm2
-# CHECK-NEXT:  2      8     1.00           *            vextractf128	$1, %ymm0, (%rax)
+# CHECK-NEXT:  2      11    1.00           *            vextractf128	$1, %ymm0, (%rax)
 # CHECK-NEXT:  2      1     1.00                        vextractps	$1, %xmm0, %ecx
 # CHECK-NEXT:  2      2     1.00           *            vextractps	$1, %xmm0, (%rax)
 # CHECK-NEXT:  4      6     2.00                        vhaddpd	%xmm0, %xmm1, %xmm2
@@ -1213,7 +1213,7 @@ vzeroupper
 # CHECK-NEXT:  3      6     2.00                        vhsubps	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  4      13    2.00    *                   vhsubps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      2     1.00                        vinsertf128	$1, %xmm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      8     1.00    *                   vinsertf128	$1, (%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      11    1.00    *                   vinsertf128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.50                        vinsertps	$1, %xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vinsertps	$1, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vlddqu	(%rax), %xmm2
@@ -1430,7 +1430,7 @@ vzeroupper
 # CHECK-NEXT:  3      6     2.00                        vpcmpistrm	$1, %xmm0, %xmm2
 # CHECK-NEXT:  4      13    2.00    *                   vpcmpistrm	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      3     1.00                        vperm2f128	$1, %ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      7     1.00    *                   vperm2f128	$1, (%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      10    1.00    *                   vperm2f128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.50                        vpermilpd	$1, %xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpermilpd	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      3     0.50                        vpermilpd	%xmm0, %xmm1, %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx2.s b/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx2.s
index 1a8b9e2de1d8e..bc504285a5814 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx2.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver3/resources-avx2.s
@@ -464,7 +464,7 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      2     1.00                        vbroadcastsd	%xmm0, %ymm0
 # CHECK-NEXT:  1      2     1.00                        vbroadcastss	%xmm0, %ymm0
 # CHECK-NEXT:  1      4     1.00                        vextracti128	$1, %ymm0, %xmm2
-# CHECK-NEXT:  2      8     1.00           *            vextracti128	$1, %ymm0, (%rax)
+# CHECK-NEXT:  2      11    1.00           *            vextracti128	$1, %ymm0, (%rax)
 # CHECK-NEXT:  1      5     0.33    *                   vgatherdpd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT:  1      5     0.33    *                   vgatherdpd	%ymm0, (%rax,%xmm1,2), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vgatherdps	%xmm0, (%rax,%xmm1,2), %xmm2
@@ -561,13 +561,13 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      3     1.00                        vperm2i128	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      9     1.00    *                   vperm2i128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  2      5     1.00                        vpermd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      9     2.00    *                   vpermd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  2      12    2.00    *                   vpermd	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  2      6     1.00                        vpermpd	$1, %ymm0, %ymm2
-# CHECK-NEXT:  3      10    2.00    *                   vpermpd	$1, (%rax), %ymm2
+# CHECK-NEXT:  3      13    2.00    *                   vpermpd	$1, (%rax), %ymm2
 # CHECK-NEXT:  2      7     1.00                        vpermps	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  3      11    2.00    *                   vpermps	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  3      14    2.00    *                   vpermps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  2      6     1.00                        vpermq	$1, %ymm0, %ymm2
-# CHECK-NEXT:  2      9     2.00    *                   vpermq	$1, (%rax), %ymm2
+# CHECK-NEXT:  2      12    2.00    *                   vpermq	$1, (%rax), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%ymm0, (%rax,%ymm1,2), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdq	%xmm0, (%rax,%xmm1,2), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver3/resources-sha.s b/llvm/test/tools/llvm-mca/X86/Znver3/resources-sha.s
index e6d5ab90a2acc..a9827788de39a 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver3/resources-sha.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver3/resources-sha.s
@@ -32,17 +32,17 @@ sha256rnds2 (%rax), %xmm2
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
 # CHECK-NEXT:  2      2     0.50                        sha1msg1	%xmm0, %xmm2
-# CHECK-NEXT:  2      6     0.50    *                   sha1msg1	(%rax), %xmm2
+# CHECK-NEXT:  2      9     0.50    *                   sha1msg1	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.50                        sha1msg2	%xmm0, %xmm2
-# CHECK-NEXT:  1      5     0.50    *                   sha1msg2	(%rax), %xmm2
+# CHECK-NEXT:  1      8     0.50    *                   sha1msg2	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.50                        sha1nexte	%xmm0, %xmm2
-# CHECK-NEXT:  1      5     0.50    *                   sha1nexte	(%rax), %xmm2
+# CHECK-NEXT:  1      8     0.50    *                   sha1nexte	(%rax), %xmm2
 # CHECK-NEXT:  1      6     2.00                        sha1rnds4	$3, %xmm0, %xmm2
 # CHECK-NEXT:  1      10    0.50    *                   sha1rnds4	$3, (%rax), %xmm2
 # CHECK-NEXT:  2      2     0.75                        sha256msg1	%xmm0, %xmm2
-# CHECK-NEXT:  2      6     0.75    *                   sha256msg1	(%rax), %xmm2
+# CHECK-NEXT:  2      9     0.75    *                   sha256msg1	(%rax), %xmm2
 # CHECK-NEXT:  4      3     2.00                        sha256msg2	%xmm0, %xmm2
-# CHECK-NEXT:  5      7     2.00    *                   sha256msg2	(%rax), %xmm2
+# CHECK-NEXT:  5      10    2.00    *                   sha256msg2	(%rax), %xmm2
 # CHECK-NEXT:  1      4     2.00                        sha256rnds2	%xmm0, %xmm0, %xmm2
 # CHECK-NEXT:  1      10    0.50    *                   sha256rnds2	%xmm0, (%rax), %xmm2
 
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
index 1b2735a9cdde8..9b721c933ab51 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
@@ -1193,7 +1193,7 @@ vzeroupper
 # CHECK-NEXT:  7      11    4.00                        vdpps	$22, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  8      18    4.00    *                   vdpps	$22, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      4     1.00                        vextractf128	$1, %ymm0, %xmm2
-# CHECK-NEXT:  2      8     1.00           *            vextractf128	$1, %ymm0, (%rax)
+# CHECK-NEXT:  2      11    1.00           *            vextractf128	$1, %ymm0, (%rax)
 # CHECK-NEXT:  2      1     1.00                        vextractps	$1, %xmm0, %ecx
 # CHECK-NEXT:  2      2     1.00           *            vextractps	$1, %xmm0, (%rax)
 # CHECK-NEXT:  3      4     2.00                        vhaddpd	%xmm0, %xmm1, %xmm2
@@ -1213,7 +1213,7 @@ vzeroupper
 # CHECK-NEXT:  3      4     2.00                        vhsubps	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  4      11    2.00    *                   vhsubps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      2     1.00                        vinsertf128	$1, %xmm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      8     1.00    *                   vinsertf128	$1, (%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      11    1.00    *                   vinsertf128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.50                        vinsertps	$1, %xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vinsertps	$1, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vlddqu	(%rax), %xmm2
@@ -1430,7 +1430,7 @@ vzeroupper
 # CHECK-NEXT:  3      6     2.00                        vpcmpistrm	$1, %xmm0, %xmm2
 # CHECK-NEXT:  4      13    2.00    *                   vpcmpistrm	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      3     1.00                        vperm2f128	$1, %ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      7     1.00    *                   vperm2f128	$1, (%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      10    1.00    *                   vperm2f128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.50                        vpermilpd	$1, %xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpermilpd	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      3     0.50                        vpermilpd	%xmm0, %xmm1, %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
index 0ad14688d0b7f..25e367c96e44b 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
@@ -464,7 +464,7 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      2     1.00                        vbroadcastsd	%xmm0, %ymm0
 # CHECK-NEXT:  1      2     1.00                        vbroadcastss	%xmm0, %ymm0
 # CHECK-NEXT:  1      4     1.00                        vextracti128	$1, %ymm0, %xmm2
-# CHECK-NEXT:  2      8     1.00           *            vextracti128	$1, %ymm0, (%rax)
+# CHECK-NEXT:  2      11    1.00           *            vextracti128	$1, %ymm0, (%rax)
 # CHECK-NEXT:  1      5     0.33    *                   vgatherdpd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT:  1      5     0.33    *                   vgatherdpd	%ymm0, (%rax,%xmm1,2), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vgatherdps	%xmm0, (%rax,%xmm1,2), %xmm2
@@ -561,13 +561,13 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      3     1.00                        vperm2i128	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     1.00    *                   vperm2i128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  2      5     1.00                        vpermd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      9     2.00    *                   vpermd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  2      12    2.00    *                   vpermd	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  2      6     1.00                        vpermpd	$1, %ymm0, %ymm2
-# CHECK-NEXT:  3      10    2.00    *                   vpermpd	$1, (%rax), %ymm2
+# CHECK-NEXT:  3      13    2.00    *                   vpermpd	$1, (%rax), %ymm2
 # CHECK-NEXT:  2      7     1.00                        vpermps	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  3      11    2.00    *                   vpermps	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  3      14    2.00    *                   vpermps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  2      6     1.00                        vpermq	$1, %ymm0, %ymm2
-# CHECK-NEXT:  2      9     2.00    *                   vpermq	$1, (%rax), %ymm2
+# CHECK-NEXT:  2      12    2.00    *                   vpermq	$1, (%rax), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%ymm0, (%rax,%ymm1,2), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdq	%xmm0, (%rax,%xmm1,2), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s
index 553466c35c9fe..77f91ba16efcd 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sha.s
@@ -32,17 +32,17 @@ sha256rnds2 (%rax), %xmm2
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
 # CHECK-NEXT:  2      2     0.50                        sha1msg1	%xmm0, %xmm2
-# CHECK-NEXT:  2      6     0.50    *                   sha1msg1	(%rax), %xmm2
+# CHECK-NEXT:  2      9     0.50    *                   sha1msg1	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.50                        sha1msg2	%xmm0, %xmm2
-# CHECK-NEXT:  1      5     0.50    *                   sha1msg2	(%rax), %xmm2
+# CHECK-NEXT:  1      8     0.50    *                   sha1msg2	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.50                        sha1nexte	%xmm0, %xmm2
-# CHECK-NEXT:  1      5     0.50    *                   sha1nexte	(%rax), %xmm2
+# CHECK-NEXT:  1      8     0.50    *                   sha1nexte	(%rax), %xmm2
 # CHECK-NEXT:  1      6     2.00                        sha1rnds4	$3, %xmm0, %xmm2
 # CHECK-NEXT:  1      10    0.50    *                   sha1rnds4	$3, (%rax), %xmm2
 # CHECK-NEXT:  2      2     0.75                        sha256msg1	%xmm0, %xmm2
-# CHECK-NEXT:  2      6     0.75    *                   sha256msg1	(%rax), %xmm2
+# CHECK-NEXT:  2      9     0.75    *                   sha256msg1	(%rax), %xmm2
 # CHECK-NEXT:  4      3     2.00                        sha256msg2	%xmm0, %xmm2
-# CHECK-NEXT:  5      7     2.00    *                   sha256msg2	(%rax), %xmm2
+# CHECK-NEXT:  5      10    2.00    *                   sha256msg2	(%rax), %xmm2
 # CHECK-NEXT:  1      4     2.00                        sha256rnds2	%xmm0, %xmm0, %xmm2
 # CHECK-NEXT:  1      10    0.50    *                   sha256rnds2	%xmm0, (%rax), %xmm2
 
From 4ae7b58c02a81085f2fc6d287dbae3c7c5b4a5a1 Mon Sep 17 00:00:00 2001
From: Simon Pilgrim <llvm-dev@redking.me.uk>
Date: Wed, 10 Sep 2025 15:24:08 +0100
Subject: [PATCH] [X86] Fix throughput typo in XMM/YMM PACK/PALIGNR schedule
 classes

Only the ZMM PACK/PALIGNR instructions are half-rate on znver4 - confirmed with AMD SOG, uops.info and Agner

Noticed because comparing costs table shuffle costs vs llvm-mca costs kept giving weird numbers if I tested it on znver4 vs x86-64-v4

It looks like there's other znver4 overrides that make this mistake but many of these need cleaning up to use the (currently unused) default classes properly
---
 llvm/lib/Target/X86/X86ScheduleZnver4.td      |  38 ++++--
 .../llvm-mca/X86/Znver4/resources-avx1.s      |  22 ++--
 .../llvm-mca/X86/Znver4/resources-avx2.s      |  10 +-
 .../X86/Znver4/resources-avx512bwvl.s         | 122 +++++++++---------
 .../llvm-mca/X86/Znver4/resources-sse2.s      |  14 +-
 .../llvm-mca/X86/Znver4/resources-sse41.s     |   6 +-
 .../llvm-mca/X86/Znver4/resources-ssse3.s     |   6 +-
 7 files changed, 117 insertions(+), 101 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index f4b8f8927b1b5..a93c7e3a82f17 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1534,9 +1534,9 @@ def Zn4WriteVFIXUPIMMPDZrr_VRANGESDrr : SchedWriteRes<[Zn4FPFMisc01]> {
   let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVFIXUPIMMPDZrr_VRANGESDrr], (instregex
-	"VFIXUPIMM(S|P)(S|D)(Z|Z128|Z256?)rrik", "VFIXUPIMM(S|P)(S|D)(Z?|Z128?|Z256?)rrikz", 
+        "VFIXUPIMM(S|P)(S|D)(Z|Z128|Z256?)rrik", "VFIXUPIMM(S|P)(S|D)(Z?|Z128?|Z256?)rrikz", 
         "VFIXUPIMM(S|P)(S|D)(Z128|Z256?)rri",  "VRANGE(S|P)(S|D)(Z?|Z128?|Z256?)rri(b?)",
-	"VRANGE(S|P)(S|D)(Z|Z128|Z256?)rri(b?)k","VRANGE(S|P)(S|D)(Z?|Z128?|Z256?)rri(b?)kz"
+        "VRANGE(S|P)(S|D)(Z|Z128|Z256?)rri(b?)k","VRANGE(S|P)(S|D)(Z?|Z128?|Z256?)rri(b?)kz"
 	)>;
 
 // SCALE & REDUCE instructions
@@ -1567,7 +1567,7 @@ def Zn4WriteBUSDr_VPMADDr: SchedWriteRes<[Zn4FPFMisc01]> {
   let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteBUSDr_VPMADDr], (instregex
-	"VPDP(BU|WS)(S|P)(S|D|DS)(Z|Z128|Z256)(r|rk|rkz)",
+        "VPDP(BU|WS)(S|P)(S|D|DS)(Z|Z128|Z256)(r|rk|rkz)",
         "VPMADD52(H|L)UQ(Z|Z128|Z256)(r|rk|rkz)"
 	)>;
 
@@ -1586,7 +1586,7 @@ def : InstRW<[Zn4WriteSHIFTrr], (instregex
         "(V?)P(ROL|ROR)(D|Q|VD|VQ)(Z?|Z128?|Z256?)(rr|rrk|rrkz)",
         "(V?)P(ROL|ROR)(D|Q|VD|VQ)(Z256?)(ri|rik|rikz)",
         "(V?)P(ROL|ROR)(D|Q)(Z?|Z128?)(ri|rik|rikz)",
-	"VPSHUFBITQMBZ128rr", "VFMSUB231SSZrkz_Int"
+        "VPSHUFBITQMBZ128rr", "VFMSUB231SSZrkz_Int"
 	)>;
 
 def Zn4WriteSHIFTri: SchedWriteRes<[Zn4FPFMisc01]> {
@@ -1598,24 +1598,40 @@ def : InstRW<[Zn4WriteSHIFTri], (instregex
         "VP(SLL|SRL|SRA)(D|Q|W)(Z|Z128|Z256?)(ri|rik|rikz)"
 	)>;
 
-// ALIGN Instructions
-def Zn4WriteALIGN: SchedWriteRes<[Zn4FPFMisc12]> {
+// ALIGNR Instructions
+def Zn4WriteALIGNR: SchedWriteRes<[Zn4FPFMisc12]> {
+  let Latency = 2;
+  let ReleaseAtCycles = [1];
+  let NumMicroOps = 1;
+}
+def : InstRW<[Zn4WriteALIGNR], (instregex
+        "(V?)PALIGNR(Y?|Z128?|Z256?)(rri|rrik|rrikz)"
+	)>;
+def Zn4WriteALIGNRZ: SchedWriteRes<[Zn4FPFMisc12]> {
   let Latency = 2;
   let ReleaseAtCycles = [2];
   let NumMicroOps = 1;
 }
-def : InstRW<[Zn4WriteALIGN], (instregex
-        "(V?)PALIGNR(Z?|Z128?|Z256?)(rri|rrik|rrikz)"
+def : InstRW<[Zn4WriteALIGNRZ], (instregex
+        "(V?)PALIGNRZ(rri|rrik|rrikz)"
 	)>;
 
-//PACK Instructions
+// PACK Instructions
 def Zn4WritePACK: SchedWriteRes<[Zn4FPFMisc12]> {
   let Latency = 2;
-  let ReleaseAtCycles = [2];
+  let ReleaseAtCycles = [1];
   let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WritePACK], (instregex
-        "(V?)PACK(SS|US)(DW|WB)(Z?|Z128?|Z256?)(rr|rrk|rrkz)"
+        "(V?)PACK(SS|US)(DW|WB)(Y?|Z128?|Z256?)(rr|rrk|rrkz)"
+	)>;
+def Zn4WritePACKZ: SchedWriteRes<[Zn4FPFMisc12]> {
+  let Latency = 2;
+  let ReleaseAtCycles = [2];
+  let NumMicroOps = 1;
+}
+def : InstRW<[Zn4WritePACKZ], (instregex
+        "(V?)PACK(SS|US)(DW|WB)Z(rr|rrk|rrkz)"
 	)>;
 
 // MAX and MIN Instructions
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
index 9b721c933ab51..1ffe53366fdb0 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
@@ -1365,13 +1365,13 @@ vzeroupper
 # CHECK-NEXT:  1      8     0.50    *                   vpabsd	(%rax), %xmm2
 # CHECK-NEXT:  1      2     1.00                        vpabsw	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpabsw	(%rax), %xmm2
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpaddb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpaddb	(%rax), %xmm1, %xmm2
@@ -1389,7 +1389,7 @@ vzeroupper
 # CHECK-NEXT:  1      8     0.50    *                   vpaddusw	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpaddw	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpaddw	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpand	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpand	(%rax), %xmm1, %xmm2
@@ -1749,7 +1749,7 @@ vzeroupper
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 1.33   1.33   1.33   16.50  16.50  16.50  16.50   -     205.25 396.08 270.58 158.08 208.50 208.50 65.00  119.67 119.67 119.67 107.00 107.00 107.00 19.00  19.00
+# CHECK-NEXT: 1.33   1.33   1.33   16.50  16.50  16.50  16.50   -     205.25 393.58 268.08 158.08 208.50 208.50 65.00  119.67 119.67 119.67 107.00 107.00 107.00 19.00  19.00
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -2088,13 +2088,13 @@ vzeroupper
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpabsd	(%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpabsw	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpabsw	(%rax), %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpaddb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpaddb	(%rax), %xmm1, %xmm2
@@ -2112,7 +2112,7 @@ vzeroupper
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpaddusw	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpaddw	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpaddw	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpand	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpand	(%rax), %xmm1, %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
index 25e367c96e44b..6dc5bacde9059 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
@@ -484,13 +484,13 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpabsd	(%rax), %ymm2
 # CHECK-NEXT:  1      1     0.50                        vpabsw	%ymm0, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpabsw	(%rax), %ymm2
-# CHECK-NEXT:  1      1     0.50                        vpackssdw	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      1     0.50                        vpacksswb	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      1     0.50                        vpackusdw	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      1     0.50                        vpackuswb	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.25                        vpaddb	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpaddb	(%rax), %ymm1, %ymm2
@@ -508,7 +508,7 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpaddusw	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.25                        vpaddw	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpaddw	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      1     0.50                        vpalignr	$1, %ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.25                        vpand	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpand	(%rax), %ymm1, %ymm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512bwvl.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512bwvl.s
index a298dd69ee9b3..79f2cb4b7ab82 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512bwvl.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512bwvl.s
@@ -1166,53 +1166,53 @@ vpunpcklwd         (%rax), %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpabsw	(%rax), %ymm19 {%k1}
 # CHECK-NEXT:  1      1     0.25                        vpabsw	%ymm16, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpabsw	(%rax), %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpackssdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpackssdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpackssdw	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpacksswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpacksswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpacksswb	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpackusdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpackusdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpackusdw	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpackuswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpackuswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpackuswb	(%rax), %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      1     0.25                        vpaddb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpaddb	(%rax), %xmm17, %xmm19
@@ -1286,17 +1286,17 @@ vpunpcklwd         (%rax), %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpaddw	(%rax), %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  1      1     0.25                        vpaddw	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpaddw	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %xmm17, %xmm19
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %ymm17, %ymm19
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  1      2     1.00                        vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  1      2     0.50                        vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   vpalignr	$1, (%rax), %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      2     1.00                        vpavgb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   vpavgb	(%rax), %xmm17, %xmm19
@@ -2048,7 +2048,7 @@ vpunpcklwd         (%rax), %ymm17, %ymm19 {z}{k1}
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -     4.00   4.00   4.00   4.00    -     233.00 411.50 300.50 140.00 226.00 226.00 8.00   150.67 150.67 150.67 148.00 148.00 148.00 4.00   4.00
+# CHECK-NEXT:  -      -      -     4.00   4.00   4.00   4.00    -     233.00 396.50 285.50 140.00 226.00 226.00 8.00   150.67 150.67 150.67 148.00 148.00 148.00 4.00   4.00
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -2120,53 +2120,53 @@ vpunpcklwd         (%rax), %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpabsw	(%rax), %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpabsw	%ymm16, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpabsw	(%rax), %ymm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackssdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackssdw	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpacksswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpacksswb	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackusdw	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackusdw	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %ymm17, %ymm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpackuswb	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpackuswb	(%rax), %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpaddb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpaddb	(%rax), %xmm17, %xmm19
@@ -2240,17 +2240,17 @@ vpunpcklwd         (%rax), %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpaddw	(%rax), %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpaddw	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpaddw	(%rax), %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %xmm17, %xmm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %ymm17, %ymm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %ymm17, %ymm19 {%k1}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1} {z}
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     vpalignr	$1, %ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpalignr	$1, (%rax), %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpavgb	%xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpavgb	(%rax), %xmm17, %xmm19
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse2.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse2.s
index dde829373465b..f9f02465bc7d5 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse2.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse2.s
@@ -516,11 +516,11 @@ xorpd       (%rax), %xmm2
 # CHECK-NEXT:  1      10    0.50    *                   mulsd	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.25                        orpd	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   orpd	(%rax), %xmm2
-# CHECK-NEXT:  1      2     1.00                        packssdw	%xmm0, %xmm2
+# CHECK-NEXT:  1      2     0.50                        packssdw	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   packssdw	(%rax), %xmm2
-# CHECK-NEXT:  1      2     1.00                        packsswb	%xmm0, %xmm2
+# CHECK-NEXT:  1      2     0.50                        packsswb	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   packsswb	(%rax), %xmm2
-# CHECK-NEXT:  1      2     1.00                        packuswb	%xmm0, %xmm2
+# CHECK-NEXT:  1      2     0.50                        packuswb	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   packuswb	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.25                        paddb	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   paddb	(%rax), %xmm2
@@ -702,7 +702,7 @@ xorpd       (%rax), %xmm2
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 1.00   1.00   1.00   25.00  25.00  25.00  25.00   -     58.25  140.25 81.25  53.25  72.00  72.00  12.00  54.67  54.67  54.67  39.33  39.33  39.33  8.00   8.00
+# CHECK-NEXT: 1.00   1.00   1.00   25.00  25.00  25.00  25.00   -     58.25  138.75 79.75  53.25  72.00  72.00  12.00  54.67  54.67  54.67  39.33  39.33  39.33  8.00   8.00
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -815,11 +815,11 @@ xorpd       (%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50   0.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     mulsd	(%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     orpd	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     orpd	(%rax), %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     packssdw	%xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     packssdw	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     packssdw	(%rax), %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     packsswb	%xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     packsswb	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     packsswb	(%rax), %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     packuswb	%xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     packuswb	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     packuswb	(%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     paddb	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     paddb	(%rax), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse41.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse41.s
index b0321c13f48c5..7f5c50c8b93ab 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse41.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse41.s
@@ -174,7 +174,7 @@ roundss     $1, (%rax), %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   movntdqa	(%rax), %xmm2
 # CHECK-NEXT:  4      4     2.00                        mpsadbw	$1, %xmm0, %xmm2
 # CHECK-NEXT:  6      11    2.00    *                   mpsadbw	$1, (%rax), %xmm2
-# CHECK-NEXT:  1      2     1.00                        packusdw	%xmm0, %xmm2
+# CHECK-NEXT:  1      2     0.50                        packusdw	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   packusdw	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.50                        pblendvb	%xmm0, %xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   pblendvb	%xmm0, (%rax), %xmm2
@@ -279,7 +279,7 @@ roundss     $1, (%rax), %xmm2
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     31.00  43.50  28.50  16.00  35.50  35.50  7.00   16.33  16.33  16.33  14.67  14.67  14.67  2.50   2.50
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     31.00  43.00  28.00  16.00  35.50  35.50  7.00   16.33  16.33  16.33  14.67  14.67  14.67  2.50   2.50
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -302,7 +302,7 @@ roundss     $1, (%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     movntdqa	(%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00   2.00    -      -      -      -      -      -      -      -      -      -      -     mpsadbw	$1, %xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00   2.00   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     mpsadbw	$1, (%rax), %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     packusdw	%xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     packusdw	%xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     packusdw	(%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50    -      -      -      -      -      -      -      -      -      -      -     pblendvb	%xmm0, %xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     pblendvb	%xmm0, (%rax), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-ssse3.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-ssse3.s
index 173c72171aafe..2feee84efa8ec 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-ssse3.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-ssse3.s
@@ -120,7 +120,7 @@ psignw      (%rax), %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   pabsw	(%rax), %xmm2
 # CHECK-NEXT:  1      1     0.50                        palignr	$1, %mm0, %mm2
 # CHECK-NEXT:  1      8     0.50    *                   palignr	$1, (%rax), %mm2
-# CHECK-NEXT:  1      2     1.00                        palignr	$1, %xmm0, %xmm2
+# CHECK-NEXT:  1      2     0.50                        palignr	$1, %xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   palignr	$1, (%rax), %xmm2
 # CHECK-NEXT:  3      2     2.00                        phaddd	%mm0, %mm2
 # CHECK-NEXT:  4      9     2.00    *                   phaddd	(%rax), %mm2
@@ -198,7 +198,7 @@ psignw      (%rax), %xmm2
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     62.50  15.00  9.00   8.50   16.00  16.00   -     10.67  10.67  10.67  10.67  10.67  10.67   -      -
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     62.50  14.50  8.50   8.50   16.00  16.00   -     10.67  10.67  10.67  10.67  10.67  10.67   -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -216,7 +216,7 @@ psignw      (%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     pabsw	(%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     palignr	$1, %mm0, %mm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     palignr	$1, (%rax), %mm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     palignr	$1, %xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     palignr	$1, %xmm0, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     palignr	$1, (%rax), %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -     phaddd	%mm0, %mm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00    -      -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     phaddd	(%rax), %mm2
From f90e82679f7e9265a9f17dbbba3b2e51355457c4 Mon Sep 17 00:00:00 2001
From: Simon Pilgrim <llvm-dev@redking.me.uk>
Date: Wed, 10 Sep 2025 17:30:45 +0100
Subject: [PATCH 1/3] [llvm-mca][x86] Ensure avxvnni tests actually test the
 avxvnni instructions

Noticed while checking #97271 - we weren't actually testing the vex variants of the vnni instructions in the avxvnni mca tests

Fixing this causes the znver4 results to change, because it turns out we didn't have consistent instruction naming for teeh avx and avx512 variants, breaking the regex matching

So add the missing reg operand to the avx512 vnni instruction signatures to match avx vnni
---
 llvm/lib/Target/X86/X86InstrAVX512.td         |  18 +-
 llvm/lib/Target/X86/X86InstrInfo.cpp          | 168 +++++++++---------
 llvm/lib/Target/X86/X86ScheduleZnver4.td      |   2 +-
 .../X86/AlderlakeP/resources-avxvnni.s        |  96 +++++-----
 .../llvm-mca/X86/Generic/resources-avxvnni.s  |  96 +++++-----
 .../X86/LunarlakeP/resources-avxvnni.s        |  96 +++++-----
 .../X86/SapphireRapids/resources-avxvnni.s    |  96 +++++-----
 .../llvm-mca/X86/Znver4/resources-avxvnni.s   |  96 +++++-----
 8 files changed, 334 insertions(+), 334 deletions(-)

diff --git a/llvm/lib/Target/X86/X86InstrAVX512.td b/llvm/lib/Target/X86/X86InstrAVX512.td
index 3401f6f04800e..b8f299965faa3 100644
--- a/llvm/lib/Target/X86/X86InstrAVX512.td
+++ b/llvm/lib/Target/X86/X86InstrAVX512.td
@@ -12404,14 +12404,14 @@ multiclass VNNI_rmb<bits<8> Op, string OpStr, SDNode OpNode,
                     X86FoldableSchedWrite sched, X86VectorVTInfo VTI,
                     bit IsCommutable> {
   let ExeDomain = VTI.ExeDomain in {
-  defm r  :   AVX512_maskable_3src<Op, MRMSrcReg, VTI, (outs VTI.RC:$dst),
+  defm rr  :  AVX512_maskable_3src<Op, MRMSrcReg, VTI, (outs VTI.RC:$dst),
                                    (ins VTI.RC:$src2, VTI.RC:$src3), OpStr,
                                    "$src3, $src2", "$src2, $src3",
                                    (VTI.VT (OpNode VTI.RC:$src1,
                                             VTI.RC:$src2, VTI.RC:$src3)),
                                    IsCommutable, IsCommutable>,
                                    EVEX, VVVV, T8, Sched<[sched]>;
-  defm m  :   AVX512_maskable_3src<Op, MRMSrcMem, VTI, (outs VTI.RC:$dst),
+  defm rm  :  AVX512_maskable_3src<Op, MRMSrcMem, VTI, (outs VTI.RC:$dst),
                                    (ins VTI.RC:$src2, VTI.MemOp:$src3), OpStr,
                                    "$src3, $src2", "$src2, $src3",
                                    (VTI.VT (OpNode VTI.RC:$src1, VTI.RC:$src2,
@@ -12419,7 +12419,7 @@ multiclass VNNI_rmb<bits<8> Op, string OpStr, SDNode OpNode,
                                    EVEX, VVVV, EVEX_CD8<32, CD8VF>, T8,
                                    Sched<[sched.Folded, sched.ReadAfterFold,
                                           sched.ReadAfterFold]>;
-  defm mb :   AVX512_maskable_3src<Op, MRMSrcMem, VTI, (outs VTI.RC:$dst),
+  defm rmb :  AVX512_maskable_3src<Op, MRMSrcMem, VTI, (outs VTI.RC:$dst),
                                    (ins VTI.RC:$src2, VTI.ScalarMemOp:$src3),
                                    OpStr, "${src3}"#VTI.BroadcastStr#", $src2",
                                    "$src2, ${src3}"#VTI.BroadcastStr,
@@ -12459,24 +12459,24 @@ defm VPDPWSSDS  : VNNI_common<0x53, "vpdpwssds", X86Vpdpwssds, SchedWriteVecIMul
 let Predicates = [HasVNNI] in {
   def : Pat<(v16i32 (add VR512:$src1,
                          (X86vpmaddwd_su VR512:$src2, VR512:$src3))),
-            (VPDPWSSDZr VR512:$src1, VR512:$src2, VR512:$src3)>;
+            (VPDPWSSDZrr VR512:$src1, VR512:$src2, VR512:$src3)>;
   def : Pat<(v16i32 (add VR512:$src1,
                          (X86vpmaddwd_su VR512:$src2, (load addr:$src3)))),
-            (VPDPWSSDZm VR512:$src1, VR512:$src2, addr:$src3)>;
+            (VPDPWSSDZrm VR512:$src1, VR512:$src2, addr:$src3)>;
 }
 let Predicates = [HasVNNI,HasVLX] in {
   def : Pat<(v8i32 (add VR256X:$src1,
                         (X86vpmaddwd_su VR256X:$src2, VR256X:$src3))),
-            (VPDPWSSDZ256r VR256X:$src1, VR256X:$src2, VR256X:$src3)>;
+            (VPDPWSSDZ256rr VR256X:$src1, VR256X:$src2, VR256X:$src3)>;
   def : Pat<(v8i32 (add VR256X:$src1,
                         (X86vpmaddwd_su VR256X:$src2, (load addr:$src3)))),
-            (VPDPWSSDZ256m VR256X:$src1, VR256X:$src2, addr:$src3)>;
+            (VPDPWSSDZ256rm VR256X:$src1, VR256X:$src2, addr:$src3)>;
   def : Pat<(v4i32 (add VR128X:$src1,
                         (X86vpmaddwd_su VR128X:$src2, VR128X:$src3))),
-            (VPDPWSSDZ128r VR128X:$src1, VR128X:$src2, VR128X:$src3)>;
+            (VPDPWSSDZ128rr VR128X:$src1, VR128X:$src2, VR128X:$src3)>;
   def : Pat<(v4i32 (add VR128X:$src1,
                         (X86vpmaddwd_su VR128X:$src2, (load addr:$src3)))),
-            (VPDPWSSDZ128m VR128X:$src1, VR128X:$src2, addr:$src3)>;
+            (VPDPWSSDZ128rm VR128X:$src1, VR128X:$src2, addr:$src3)>;
 }
 
 //===----------------------------------------------------------------------===//
diff --git a/llvm/lib/Target/X86/X86InstrInfo.cpp b/llvm/lib/Target/X86/X86InstrInfo.cpp
index a68edf4d2b7ee..1f6915929646a 100644
--- a/llvm/lib/Target/X86/X86InstrInfo.cpp
+++ b/llvm/lib/Target/X86/X86InstrInfo.cpp
@@ -2939,78 +2939,78 @@ bool X86InstrInfo::findCommutedOpIndices(const MachineInstr &MI,
   case X86::VPDPBUUDSYrr:
   case X86::VPDPBUUDrr:
   case X86::VPDPBUUDYrr:
-  case X86::VPDPBSSDSZ128r:
-  case X86::VPDPBSSDSZ128rk:
-  case X86::VPDPBSSDSZ128rkz:
-  case X86::VPDPBSSDSZ256r:
-  case X86::VPDPBSSDSZ256rk:
-  case X86::VPDPBSSDSZ256rkz:
-  case X86::VPDPBSSDSZr:
-  case X86::VPDPBSSDSZrk:
-  case X86::VPDPBSSDSZrkz:
-  case X86::VPDPBSSDZ128r:
-  case X86::VPDPBSSDZ128rk:
-  case X86::VPDPBSSDZ128rkz:
-  case X86::VPDPBSSDZ256r:
-  case X86::VPDPBSSDZ256rk:
-  case X86::VPDPBSSDZ256rkz:
-  case X86::VPDPBSSDZr:
-  case X86::VPDPBSSDZrk:
-  case X86::VPDPBSSDZrkz:
-  case X86::VPDPBUUDSZ128r:
-  case X86::VPDPBUUDSZ128rk:
-  case X86::VPDPBUUDSZ128rkz:
-  case X86::VPDPBUUDSZ256r:
-  case X86::VPDPBUUDSZ256rk:
-  case X86::VPDPBUUDSZ256rkz:
-  case X86::VPDPBUUDSZr:
-  case X86::VPDPBUUDSZrk:
-  case X86::VPDPBUUDSZrkz:
-  case X86::VPDPBUUDZ128r:
-  case X86::VPDPBUUDZ128rk:
-  case X86::VPDPBUUDZ128rkz:
-  case X86::VPDPBUUDZ256r:
-  case X86::VPDPBUUDZ256rk:
-  case X86::VPDPBUUDZ256rkz:
-  case X86::VPDPBUUDZr:
-  case X86::VPDPBUUDZrk:
-  case X86::VPDPBUUDZrkz:
-  case X86::VPDPWSSDZ128r:
-  case X86::VPDPWSSDZ128rk:
-  case X86::VPDPWSSDZ128rkz:
-  case X86::VPDPWSSDZ256r:
-  case X86::VPDPWSSDZ256rk:
-  case X86::VPDPWSSDZ256rkz:
-  case X86::VPDPWSSDZr:
-  case X86::VPDPWSSDZrk:
-  case X86::VPDPWSSDZrkz:
-  case X86::VPDPWSSDSZ128r:
-  case X86::VPDPWSSDSZ128rk:
-  case X86::VPDPWSSDSZ128rkz:
-  case X86::VPDPWSSDSZ256r:
-  case X86::VPDPWSSDSZ256rk:
-  case X86::VPDPWSSDSZ256rkz:
-  case X86::VPDPWSSDSZr:
-  case X86::VPDPWSSDSZrk:
-  case X86::VPDPWSSDSZrkz:
-  case X86::VPDPWUUDZ128r:
-  case X86::VPDPWUUDZ128rk:
-  case X86::VPDPWUUDZ128rkz:
-  case X86::VPDPWUUDZ256r:
-  case X86::VPDPWUUDZ256rk:
-  case X86::VPDPWUUDZ256rkz:
-  case X86::VPDPWUUDZr:
-  case X86::VPDPWUUDZrk:
-  case X86::VPDPWUUDZrkz:
-  case X86::VPDPWUUDSZ128r:
-  case X86::VPDPWUUDSZ128rk:
-  case X86::VPDPWUUDSZ128rkz:
-  case X86::VPDPWUUDSZ256r:
-  case X86::VPDPWUUDSZ256rk:
-  case X86::VPDPWUUDSZ256rkz:
-  case X86::VPDPWUUDSZr:
-  case X86::VPDPWUUDSZrk:
-  case X86::VPDPWUUDSZrkz:
+  case X86::VPDPBSSDSZ128rr:
+  case X86::VPDPBSSDSZ128rrk:
+  case X86::VPDPBSSDSZ128rrkz:
+  case X86::VPDPBSSDSZ256rr:
+  case X86::VPDPBSSDSZ256rrk:
+  case X86::VPDPBSSDSZ256rrkz:
+  case X86::VPDPBSSDSZrr:
+  case X86::VPDPBSSDSZrrk:
+  case X86::VPDPBSSDSZrrkz:
+  case X86::VPDPBSSDZ128rr:
+  case X86::VPDPBSSDZ128rrk:
+  case X86::VPDPBSSDZ128rrkz:
+  case X86::VPDPBSSDZ256rr:
+  case X86::VPDPBSSDZ256rrk:
+  case X86::VPDPBSSDZ256rrkz:
+  case X86::VPDPBSSDZrr:
+  case X86::VPDPBSSDZrrk:
+  case X86::VPDPBSSDZrrkz:
+  case X86::VPDPBUUDSZ128rr:
+  case X86::VPDPBUUDSZ128rrk:
+  case X86::VPDPBUUDSZ128rrkz:
+  case X86::VPDPBUUDSZ256rr:
+  case X86::VPDPBUUDSZ256rrk:
+  case X86::VPDPBUUDSZ256rrkz:
+  case X86::VPDPBUUDSZrr:
+  case X86::VPDPBUUDSZrrk:
+  case X86::VPDPBUUDSZrrkz:
+  case X86::VPDPBUUDZ128rr:
+  case X86::VPDPBUUDZ128rrk:
+  case X86::VPDPBUUDZ128rrkz:
+  case X86::VPDPBUUDZ256rr:
+  case X86::VPDPBUUDZ256rrk:
+  case X86::VPDPBUUDZ256rrkz:
+  case X86::VPDPBUUDZrr:
+  case X86::VPDPBUUDZrrk:
+  case X86::VPDPBUUDZrrkz:
+  case X86::VPDPWSSDZ128rr:
+  case X86::VPDPWSSDZ128rrk:
+  case X86::VPDPWSSDZ128rrkz:
+  case X86::VPDPWSSDZ256rr:
+  case X86::VPDPWSSDZ256rrk:
+  case X86::VPDPWSSDZ256rrkz:
+  case X86::VPDPWSSDZrr:
+  case X86::VPDPWSSDZrrk:
+  case X86::VPDPWSSDZrrkz:
+  case X86::VPDPWSSDSZ128rr:
+  case X86::VPDPWSSDSZ128rrk:
+  case X86::VPDPWSSDSZ128rrkz:
+  case X86::VPDPWSSDSZ256rr:
+  case X86::VPDPWSSDSZ256rrk:
+  case X86::VPDPWSSDSZ256rrkz:
+  case X86::VPDPWSSDSZrr:
+  case X86::VPDPWSSDSZrrk:
+  case X86::VPDPWSSDSZrrkz:
+  case X86::VPDPWUUDZ128rr:
+  case X86::VPDPWUUDZ128rrk:
+  case X86::VPDPWUUDZ128rrkz:
+  case X86::VPDPWUUDZ256rr:
+  case X86::VPDPWUUDZ256rrk:
+  case X86::VPDPWUUDZ256rrkz:
+  case X86::VPDPWUUDZrr:
+  case X86::VPDPWUUDZrrk:
+  case X86::VPDPWUUDZrrkz:
+  case X86::VPDPWUUDSZ128rr:
+  case X86::VPDPWUUDSZ128rrk:
+  case X86::VPDPWUUDSZ128rrkz:
+  case X86::VPDPWUUDSZ256rr:
+  case X86::VPDPWUUDSZ256rrk:
+  case X86::VPDPWUUDSZ256rrkz:
+  case X86::VPDPWUUDSZrr:
+  case X86::VPDPWUUDSZrrk:
+  case X86::VPDPWUUDSZrrkz:
   case X86::VPMADD52HUQrr:
   case X86::VPMADD52HUQYrr:
   case X86::VPMADD52HUQZ128r:
@@ -10822,12 +10822,12 @@ bool X86InstrInfo::getMachineCombinerPatterns(
     }
     break;
   }
-  case X86::VPDPWSSDZ128r:
-  case X86::VPDPWSSDZ128m:
-  case X86::VPDPWSSDZ256r:
-  case X86::VPDPWSSDZ256m:
-  case X86::VPDPWSSDZr:
-  case X86::VPDPWSSDZm: {
+  case X86::VPDPWSSDZ128rr:
+  case X86::VPDPWSSDZ128rm:
+  case X86::VPDPWSSDZ256rr:
+  case X86::VPDPWSSDZ256rm:
+  case X86::VPDPWSSDZrr:
+  case X86::VPDPWSSDZrm: {
    if (Subtarget.hasBWI() && !Subtarget.hasFastDPWSSD()) {
      Patterns.push_back(X86MachineCombinerPattern::DPWSSD);
      return true;
@@ -10866,11 +10866,11 @@ genAlternativeDpCodeSequence(MachineInstr &Root, const TargetInstrInfo &TII,
     MaddOpc = X86::VPMADDWDrm;
     AddOpc = X86::VPADDDrr;
     break;
-  case X86::VPDPWSSDZ128r:
+  case X86::VPDPWSSDZ128rr:
     MaddOpc = X86::VPMADDWDZ128rr;
     AddOpc = X86::VPADDDZ128rr;
     break;
-  case X86::VPDPWSSDZ128m:
+  case X86::VPDPWSSDZ128rm:
     MaddOpc = X86::VPMADDWDZ128rm;
     AddOpc = X86::VPADDDZ128rr;
     break;
@@ -10886,11 +10886,11 @@ genAlternativeDpCodeSequence(MachineInstr &Root, const TargetInstrInfo &TII,
     MaddOpc = X86::VPMADDWDYrm;
     AddOpc = X86::VPADDDYrr;
     break;
-  case X86::VPDPWSSDZ256r:
+  case X86::VPDPWSSDZ256rr:
     MaddOpc = X86::VPMADDWDZ256rr;
     AddOpc = X86::VPADDDZ256rr;
     break;
-  case X86::VPDPWSSDZ256m:
+  case X86::VPDPWSSDZ256rm:
     MaddOpc = X86::VPMADDWDZ256rm;
     AddOpc = X86::VPADDDZ256rr;
     break;
@@ -10898,11 +10898,11 @@ genAlternativeDpCodeSequence(MachineInstr &Root, const TargetInstrInfo &TII,
   // -->
   // vpmaddwd zmm3,zmm3,zmm1
   // vpaddd zmm2,zmm2,zmm3
-  case X86::VPDPWSSDZr:
+  case X86::VPDPWSSDZrr:
     MaddOpc = X86::VPMADDWDZrr;
     AddOpc = X86::VPADDDZrr;
     break;
-  case X86::VPDPWSSDZm:
+  case X86::VPDPWSSDZrm:
     MaddOpc = X86::VPMADDWDZrm;
     AddOpc = X86::VPADDDZrr;
     break;
diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index a93c7e3a82f17..cc300548a50e6 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1567,7 +1567,7 @@ def Zn4WriteBUSDr_VPMADDr: SchedWriteRes<[Zn4FPFMisc01]> {
   let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteBUSDr_VPMADDr], (instregex
-        "VPDP(BU|WS)(S|P)(S|D|DS)(Z|Z128|Z256)(r|rk|rkz)",
+        "VPDP(BU|WS)(S|P)(S|D|DS)(Z?|Z128?|Z256?|Y?)r(r|rk|rkz)",
         "VPMADD52(H|L)UQ(Z|Z128|Z256)(r|rk|rkz)"
 	)>;
 
diff --git a/llvm/test/tools/llvm-mca/X86/AlderlakeP/resources-avxvnni.s b/llvm/test/tools/llvm-mca/X86/AlderlakeP/resources-avxvnni.s
index 8152d18f56c30..4b73a7fc0e8b8 100644
--- a/llvm/test/tools/llvm-mca/X86/AlderlakeP/resources-avxvnni.s
+++ b/llvm/test/tools/llvm-mca/X86/AlderlakeP/resources-avxvnni.s
@@ -1,29 +1,29 @@
 # NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
 # RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=alderlake -instruction-tables < %s | FileCheck %s
 
-vpdpbusd    %xmm0, %xmm1, %xmm2
-vpdpbusd    (%rax), %xmm1, %xmm2
+{vex} vpdpbusd    %xmm0, %xmm1, %xmm2
+{vex} vpdpbusd    (%rax), %xmm1, %xmm2
 
-vpdpbusd    %ymm0, %ymm1, %ymm2
-vpdpbusd    (%rax), %ymm1, %ymm2
+{vex} vpdpbusd    %ymm0, %ymm1, %ymm2
+{vex} vpdpbusd    (%rax), %ymm1, %ymm2
 
-vpdpbusds   %xmm0, %xmm1, %xmm2
-vpdpbusds   (%rax), %xmm1, %xmm2
+{vex} vpdpbusds   %xmm0, %xmm1, %xmm2
+{vex} vpdpbusds   (%rax), %xmm1, %xmm2
 
-vpdpbusds   %ymm0, %ymm1, %ymm2
-vpdpbusds   (%rax), %ymm1, %ymm2
+{vex} vpdpbusds   %ymm0, %ymm1, %ymm2
+{vex} vpdpbusds   (%rax), %ymm1, %ymm2
 
-vpdpwssd    %xmm0, %xmm1, %xmm2
-vpdpwssd    (%rax), %xmm1, %xmm2
+{vex} vpdpwssd    %xmm0, %xmm1, %xmm2
+{vex} vpdpwssd    (%rax), %xmm1, %xmm2
 
-vpdpwssd    %ymm0, %ymm1, %ymm2
-vpdpwssd    (%rax), %ymm1, %ymm2
+{vex} vpdpwssd    %ymm0, %ymm1, %ymm2
+{vex} vpdpwssd    (%rax), %ymm1, %ymm2
 
-vpdpwssds   %xmm0, %xmm1, %xmm2
-vpdpwssds   (%rax), %xmm1, %xmm2
+{vex} vpdpwssds   %xmm0, %xmm1, %xmm2
+{vex} vpdpwssds   (%rax), %xmm1, %xmm2
 
-vpdpwssds   %ymm0, %ymm1, %ymm2
-vpdpwssds   (%rax), %ymm1, %ymm2
+{vex} vpdpwssds   %ymm0, %ymm1, %ymm2
+{vex} vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -34,22 +34,22 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  1      5     0.50                        vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     0.50                        vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - ADLPPort00
@@ -72,19 +72,19 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]   Instructions:
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
diff --git a/llvm/test/tools/llvm-mca/X86/Generic/resources-avxvnni.s b/llvm/test/tools/llvm-mca/X86/Generic/resources-avxvnni.s
index cb1f166e41d78..386be1795b0c5 100644
--- a/llvm/test/tools/llvm-mca/X86/Generic/resources-avxvnni.s
+++ b/llvm/test/tools/llvm-mca/X86/Generic/resources-avxvnni.s
@@ -1,29 +1,29 @@
 # NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
 # RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=x86-64 -instruction-tables < %s | FileCheck %s
 
-vpdpbusd    %xmm0, %xmm1, %xmm2
-vpdpbusd    (%rax), %xmm1, %xmm2
+{vex} vpdpbusd    %xmm0, %xmm1, %xmm2
+{vex} vpdpbusd    (%rax), %xmm1, %xmm2
 
-vpdpbusd    %ymm0, %ymm1, %ymm2
-vpdpbusd    (%rax), %ymm1, %ymm2
+{vex} vpdpbusd    %ymm0, %ymm1, %ymm2
+{vex} vpdpbusd    (%rax), %ymm1, %ymm2
 
-vpdpbusds   %xmm0, %xmm1, %xmm2
-vpdpbusds   (%rax), %xmm1, %xmm2
+{vex} vpdpbusds   %xmm0, %xmm1, %xmm2
+{vex} vpdpbusds   (%rax), %xmm1, %xmm2
 
-vpdpbusds   %ymm0, %ymm1, %ymm2
-vpdpbusds   (%rax), %ymm1, %ymm2
+{vex} vpdpbusds   %ymm0, %ymm1, %ymm2
+{vex} vpdpbusds   (%rax), %ymm1, %ymm2
 
-vpdpwssd    %xmm0, %xmm1, %xmm2
-vpdpwssd    (%rax), %xmm1, %xmm2
+{vex} vpdpwssd    %xmm0, %xmm1, %xmm2
+{vex} vpdpwssd    (%rax), %xmm1, %xmm2
 
-vpdpwssd    %ymm0, %ymm1, %ymm2
-vpdpwssd    (%rax), %ymm1, %ymm2
+{vex} vpdpwssd    %ymm0, %ymm1, %ymm2
+{vex} vpdpwssd    (%rax), %ymm1, %ymm2
 
-vpdpwssds   %xmm0, %xmm1, %xmm2
-vpdpwssds   (%rax), %xmm1, %xmm2
+{vex} vpdpwssds   %xmm0, %xmm1, %xmm2
+{vex} vpdpwssds   (%rax), %xmm1, %xmm2
 
-vpdpwssds   %ymm0, %ymm1, %ymm2
-vpdpwssds   (%rax), %ymm1, %ymm2
+{vex} vpdpwssds   %ymm0, %ymm1, %ymm2
+{vex} vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -34,22 +34,22 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  1      5     1.00                        vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      11    1.00    *                   vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     1.00                        vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      12    1.00    *                   vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     1.00                        vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      11    1.00    *                   vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     1.00                        vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      12    1.00    *                   vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     1.00                        vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      11    1.00    *                   vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     1.00                        vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      12    1.00    *                   vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     1.00                        vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      11    1.00    *                   vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     1.00                        vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      12    1.00    *                   vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      11    1.00    *                   {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      12    1.00    *                   {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      11    1.00    *                   {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      12    1.00    *                   {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      11    1.00    *                   {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      12    1.00    *                   {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      11    1.00    *                   {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     1.00                        {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      12    1.00    *                   {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - SBDivider
@@ -67,19 +67,19 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6.0]  [6.1]  Instructions:
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -     1.00    -      -      -      -      -     {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -     1.00    -      -      -     0.50   0.50   {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
diff --git a/llvm/test/tools/llvm-mca/X86/LunarlakeP/resources-avxvnni.s b/llvm/test/tools/llvm-mca/X86/LunarlakeP/resources-avxvnni.s
index 38d9959675f1b..5356019bbddec 100644
--- a/llvm/test/tools/llvm-mca/X86/LunarlakeP/resources-avxvnni.s
+++ b/llvm/test/tools/llvm-mca/X86/LunarlakeP/resources-avxvnni.s
@@ -1,29 +1,29 @@
 # NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
 # RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=lunarlake -instruction-tables < %s | FileCheck %s
 
-vpdpbusd    %xmm0, %xmm1, %xmm2
-vpdpbusd    (%rax), %xmm1, %xmm2
+{vex} vpdpbusd    %xmm0, %xmm1, %xmm2
+{vex} vpdpbusd    (%rax), %xmm1, %xmm2
 
-vpdpbusd    %ymm0, %ymm1, %ymm2
-vpdpbusd    (%rax), %ymm1, %ymm2
+{vex} vpdpbusd    %ymm0, %ymm1, %ymm2
+{vex} vpdpbusd    (%rax), %ymm1, %ymm2
 
-vpdpbusds   %xmm0, %xmm1, %xmm2
-vpdpbusds   (%rax), %xmm1, %xmm2
+{vex} vpdpbusds   %xmm0, %xmm1, %xmm2
+{vex} vpdpbusds   (%rax), %xmm1, %xmm2
 
-vpdpbusds   %ymm0, %ymm1, %ymm2
-vpdpbusds   (%rax), %ymm1, %ymm2
+{vex} vpdpbusds   %ymm0, %ymm1, %ymm2
+{vex} vpdpbusds   (%rax), %ymm1, %ymm2
 
-vpdpwssd    %xmm0, %xmm1, %xmm2
-vpdpwssd    (%rax), %xmm1, %xmm2
+{vex} vpdpwssd    %xmm0, %xmm1, %xmm2
+{vex} vpdpwssd    (%rax), %xmm1, %xmm2
 
-vpdpwssd    %ymm0, %ymm1, %ymm2
-vpdpwssd    (%rax), %ymm1, %ymm2
+{vex} vpdpwssd    %ymm0, %ymm1, %ymm2
+{vex} vpdpwssd    (%rax), %ymm1, %ymm2
 
-vpdpwssds   %xmm0, %xmm1, %xmm2
-vpdpwssds   (%rax), %xmm1, %xmm2
+{vex} vpdpwssds   %xmm0, %xmm1, %xmm2
+{vex} vpdpwssds   (%rax), %xmm1, %xmm2
 
-vpdpwssds   %ymm0, %ymm1, %ymm2
-vpdpwssds   (%rax), %ymm1, %ymm2
+{vex} vpdpwssds   %ymm0, %ymm1, %ymm2
+{vex} vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -34,22 +34,22 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  1      4     2.00                        vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    2.00    *                   vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      11    2.33    *                   vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      4     2.00                        vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    2.00    *                   vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      11    2.33    *                   vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    2.00    *                   vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      11    2.33    *                   vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    2.00    *                   vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      11    2.33    *                   vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    2.00    *                   {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      11    2.33    *                   {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    2.00    *                   {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      11    2.33    *                   {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    2.00    *                   {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      11    2.33    *                   {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    2.00    *                   {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      11    2.33    *                   {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - LNLPPort00
@@ -78,19 +78,19 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]   [13]   [14]   [15]   [16]   [17]   [18]   Instructions:
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00   2.00    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.33   2.33   2.33    -      -      -      -     2.00   2.00    -      -     {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
diff --git a/llvm/test/tools/llvm-mca/X86/SapphireRapids/resources-avxvnni.s b/llvm/test/tools/llvm-mca/X86/SapphireRapids/resources-avxvnni.s
index 2b64fedbd1f4e..0abd4b888a173 100644
--- a/llvm/test/tools/llvm-mca/X86/SapphireRapids/resources-avxvnni.s
+++ b/llvm/test/tools/llvm-mca/X86/SapphireRapids/resources-avxvnni.s
@@ -1,29 +1,29 @@
 # NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
 # RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=sapphirerapids -instruction-tables < %s | FileCheck %s
 
-vpdpbusd    %xmm0, %xmm1, %xmm2
-vpdpbusd    (%rax), %xmm1, %xmm2
+{vex} vpdpbusd    %xmm0, %xmm1, %xmm2
+{vex} vpdpbusd    (%rax), %xmm1, %xmm2
 
-vpdpbusd    %ymm0, %ymm1, %ymm2
-vpdpbusd    (%rax), %ymm1, %ymm2
+{vex} vpdpbusd    %ymm0, %ymm1, %ymm2
+{vex} vpdpbusd    (%rax), %ymm1, %ymm2
 
-vpdpbusds   %xmm0, %xmm1, %xmm2
-vpdpbusds   (%rax), %xmm1, %xmm2
+{vex} vpdpbusds   %xmm0, %xmm1, %xmm2
+{vex} vpdpbusds   (%rax), %xmm1, %xmm2
 
-vpdpbusds   %ymm0, %ymm1, %ymm2
-vpdpbusds   (%rax), %ymm1, %ymm2
+{vex} vpdpbusds   %ymm0, %ymm1, %ymm2
+{vex} vpdpbusds   (%rax), %ymm1, %ymm2
 
-vpdpwssd    %xmm0, %xmm1, %xmm2
-vpdpwssd    (%rax), %xmm1, %xmm2
+{vex} vpdpwssd    %xmm0, %xmm1, %xmm2
+{vex} vpdpwssd    (%rax), %xmm1, %xmm2
 
-vpdpwssd    %ymm0, %ymm1, %ymm2
-vpdpwssd    (%rax), %ymm1, %ymm2
+{vex} vpdpwssd    %ymm0, %ymm1, %ymm2
+{vex} vpdpwssd    (%rax), %ymm1, %ymm2
 
-vpdpwssds   %xmm0, %xmm1, %xmm2
-vpdpwssds   (%rax), %xmm1, %xmm2
+{vex} vpdpwssds   %xmm0, %xmm1, %xmm2
+{vex} vpdpwssds   (%rax), %xmm1, %xmm2
 
-vpdpwssds   %ymm0, %ymm1, %ymm2
-vpdpwssds   (%rax), %ymm1, %ymm2
+{vex} vpdpwssds   %ymm0, %ymm1, %ymm2
+{vex} vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -34,22 +34,22 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  1      5     0.50                        vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     0.50                        vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      5     0.50                        vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      13    0.50    *                   vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      5     0.50                        {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  2      13    0.50    *                   {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - SPRPort00
@@ -72,19 +72,19 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12]   Instructions:
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT: 0.50   0.50    -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT: 0.50   0.50   0.33   0.33    -      -      -      -      -      -     0.33    -      -     {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avxvnni.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avxvnni.s
index f0d426dbd3a63..8ff3d111fa601 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avxvnni.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avxvnni.s
@@ -1,29 +1,29 @@
 # NOTE: Assertions have been autogenerated by utils/update_mca_test_checks.py
 # RUN: llvm-mca -mtriple=x86_64-unknown-unknown -mcpu=znver4 -instruction-tables < %s | FileCheck %s
 
-vpdpbusd    %xmm0, %xmm1, %xmm2
-vpdpbusd    (%rax), %xmm1, %xmm2
+{vex} vpdpbusd    %xmm0, %xmm1, %xmm2
+{vex} vpdpbusd    (%rax), %xmm1, %xmm2
 
-vpdpbusd    %ymm0, %ymm1, %ymm2
-vpdpbusd    (%rax), %ymm1, %ymm2
+{vex} vpdpbusd    %ymm0, %ymm1, %ymm2
+{vex} vpdpbusd    (%rax), %ymm1, %ymm2
 
-vpdpbusds   %xmm0, %xmm1, %xmm2
-vpdpbusds   (%rax), %xmm1, %xmm2
+{vex} vpdpbusds   %xmm0, %xmm1, %xmm2
+{vex} vpdpbusds   (%rax), %xmm1, %xmm2
 
-vpdpbusds   %ymm0, %ymm1, %ymm2
-vpdpbusds   (%rax), %ymm1, %ymm2
+{vex} vpdpbusds   %ymm0, %ymm1, %ymm2
+{vex} vpdpbusds   (%rax), %ymm1, %ymm2
 
-vpdpwssd    %xmm0, %xmm1, %xmm2
-vpdpwssd    (%rax), %xmm1, %xmm2
+{vex} vpdpwssd    %xmm0, %xmm1, %xmm2
+{vex} vpdpwssd    (%rax), %xmm1, %xmm2
 
-vpdpwssd    %ymm0, %ymm1, %ymm2
-vpdpwssd    (%rax), %ymm1, %ymm2
+{vex} vpdpwssd    %ymm0, %ymm1, %ymm2
+{vex} vpdpwssd    (%rax), %ymm1, %ymm2
 
-vpdpwssds   %xmm0, %xmm1, %xmm2
-vpdpwssds   (%rax), %xmm1, %xmm2
+{vex} vpdpwssds   %xmm0, %xmm1, %xmm2
+{vex} vpdpwssds   (%rax), %xmm1, %xmm2
 
-vpdpwssds   %ymm0, %ymm1, %ymm2
-vpdpwssds   (%rax), %ymm1, %ymm2
+{vex} vpdpwssds   %ymm0, %ymm1, %ymm2
+{vex} vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Instruction Info:
 # CHECK-NEXT: [1]: #uOps
@@ -34,22 +34,22 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  1      4     2.00                        vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      4     2.00                        vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  1      4     2.00                        vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      10    0.50    *                   vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  1      4     2.00                        {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      10    0.50    *                   {vex}	vpdpwssds	(%rax), %ymm1, %ymm2
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -82,19 +82,19 @@ vpdpwssds   (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpbusd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpbusd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpbusd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpbusd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpbusds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpbusds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpbusds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpbusds	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpwssd	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpwssd	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpwssd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpwssd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpwssds	%xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpwssds	(%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpdpwssds	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpdpwssds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpbusd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpbusd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpbusds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpbusds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpbusds	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssd	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpwssd	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpwssd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssds	%xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpwssds	(%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     {vex}	vpdpwssds	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     {vex}	vpdpwssds	(%rax), %ymm1, %ymm2

From b62ca9b1ebe1d8156dddf37866d555c5837aa464 Mon Sep 17 00:00:00 2001
From: Simon Pilgrim <llvm-dev@redking.me.uk>
Date: Wed, 10 Sep 2025 17:49:34 +0100
Subject: [PATCH 2/3] clang-format

---
 llvm/lib/Target/X86/X86InstrInfo.cpp | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/llvm/lib/Target/X86/X86InstrInfo.cpp b/llvm/lib/Target/X86/X86InstrInfo.cpp
index 1f6915929646a..f109e29c0bff0 100644
--- a/llvm/lib/Target/X86/X86InstrInfo.cpp
+++ b/llvm/lib/Target/X86/X86InstrInfo.cpp
@@ -10828,9 +10828,9 @@ bool X86InstrInfo::getMachineCombinerPatterns(
   case X86::VPDPWSSDZ256rm:
   case X86::VPDPWSSDZrr:
   case X86::VPDPWSSDZrm: {
-   if (Subtarget.hasBWI() && !Subtarget.hasFastDPWSSD()) {
-     Patterns.push_back(X86MachineCombinerPattern::DPWSSD);
-     return true;
+    if (Subtarget.hasBWI() && !Subtarget.hasFastDPWSSD()) {
+      Patterns.push_back(X86MachineCombinerPattern::DPWSSD);
+      return true;
     }
     break;
   }

From 516e8dfc42b22688d7def04235f6fae0bddf7fba Mon Sep 17 00:00:00 2001
From: Simon Pilgrim <llvm-dev@redking.me.uk>
Date: Wed, 10 Sep 2025 18:47:55 +0100
Subject: [PATCH 3/3] tablegen test fixes

---
 llvm/test/TableGen/x86-fold-tables.inc   | 576 +++++++++++------------
 llvm/test/TableGen/x86-instr-mapping.inc | 128 ++---
 2 files changed, 352 insertions(+), 352 deletions(-)

diff --git a/llvm/test/TableGen/x86-fold-tables.inc b/llvm/test/TableGen/x86-fold-tables.inc
index 9a5ed0452d08a..5601aebdf0426 100644
--- a/llvm/test/TableGen/x86-fold-tables.inc
+++ b/llvm/test/TableGen/x86-fold-tables.inc
@@ -5365,84 +5365,84 @@ static const X86FoldTableEntry Table3[] = {
   {X86::VPCONFLICTQZ256rrk, X86::VPCONFLICTQZ256rmk, 0},
   {X86::VPCONFLICTQZrrk, X86::VPCONFLICTQZrmk, 0},
   {X86::VPDPBSSDSYrr, X86::VPDPBSSDSYrm, 0},
-  {X86::VPDPBSSDSZ128r, X86::VPDPBSSDSZ128m, 0},
-  {X86::VPDPBSSDSZ256r, X86::VPDPBSSDSZ256m, 0},
-  {X86::VPDPBSSDSZr, X86::VPDPBSSDSZm, 0},
+  {X86::VPDPBSSDSZ128rr, X86::VPDPBSSDSZ128rm, 0},
+  {X86::VPDPBSSDSZ256rr, X86::VPDPBSSDSZ256rm, 0},
+  {X86::VPDPBSSDSZrr, X86::VPDPBSSDSZrm, 0},
   {X86::VPDPBSSDSrr, X86::VPDPBSSDSrm, 0},
   {X86::VPDPBSSDYrr, X86::VPDPBSSDYrm, 0},
-  {X86::VPDPBSSDZ128r, X86::VPDPBSSDZ128m, 0},
-  {X86::VPDPBSSDZ256r, X86::VPDPBSSDZ256m, 0},
-  {X86::VPDPBSSDZr, X86::VPDPBSSDZm, 0},
+  {X86::VPDPBSSDZ128rr, X86::VPDPBSSDZ128rm, 0},
+  {X86::VPDPBSSDZ256rr, X86::VPDPBSSDZ256rm, 0},
+  {X86::VPDPBSSDZrr, X86::VPDPBSSDZrm, 0},
   {X86::VPDPBSSDrr, X86::VPDPBSSDrm, 0},
   {X86::VPDPBSUDSYrr, X86::VPDPBSUDSYrm, 0},
-  {X86::VPDPBSUDSZ128r, X86::VPDPBSUDSZ128m, 0},
-  {X86::VPDPBSUDSZ256r, X86::VPDPBSUDSZ256m, 0},
-  {X86::VPDPBSUDSZr, X86::VPDPBSUDSZm, 0},
+  {X86::VPDPBSUDSZ128rr, X86::VPDPBSUDSZ128rm, 0},
+  {X86::VPDPBSUDSZ256rr, X86::VPDPBSUDSZ256rm, 0},
+  {X86::VPDPBSUDSZrr, X86::VPDPBSUDSZrm, 0},
   {X86::VPDPBSUDSrr, X86::VPDPBSUDSrm, 0},
   {X86::VPDPBSUDYrr, X86::VPDPBSUDYrm, 0},
-  {X86::VPDPBSUDZ128r, X86::VPDPBSUDZ128m, 0},
-  {X86::VPDPBSUDZ256r, X86::VPDPBSUDZ256m, 0},
-  {X86::VPDPBSUDZr, X86::VPDPBSUDZm, 0},
+  {X86::VPDPBSUDZ128rr, X86::VPDPBSUDZ128rm, 0},
+  {X86::VPDPBSUDZ256rr, X86::VPDPBSUDZ256rm, 0},
+  {X86::VPDPBSUDZrr, X86::VPDPBSUDZrm, 0},
   {X86::VPDPBSUDrr, X86::VPDPBSUDrm, 0},
   {X86::VPDPBUSDSYrr, X86::VPDPBUSDSYrm, 0},
-  {X86::VPDPBUSDSZ128r, X86::VPDPBUSDSZ128m, 0},
-  {X86::VPDPBUSDSZ256r, X86::VPDPBUSDSZ256m, 0},
-  {X86::VPDPBUSDSZr, X86::VPDPBUSDSZm, 0},
+  {X86::VPDPBUSDSZ128rr, X86::VPDPBUSDSZ128rm, 0},
+  {X86::VPDPBUSDSZ256rr, X86::VPDPBUSDSZ256rm, 0},
+  {X86::VPDPBUSDSZrr, X86::VPDPBUSDSZrm, 0},
   {X86::VPDPBUSDSrr, X86::VPDPBUSDSrm, 0},
   {X86::VPDPBUSDYrr, X86::VPDPBUSDYrm, 0},
-  {X86::VPDPBUSDZ128r, X86::VPDPBUSDZ128m, 0},
-  {X86::VPDPBUSDZ256r, X86::VPDPBUSDZ256m, 0},
-  {X86::VPDPBUSDZr, X86::VPDPBUSDZm, 0},
+  {X86::VPDPBUSDZ128rr, X86::VPDPBUSDZ128rm, 0},
+  {X86::VPDPBUSDZ256rr, X86::VPDPBUSDZ256rm, 0},
+  {X86::VPDPBUSDZrr, X86::VPDPBUSDZrm, 0},
   {X86::VPDPBUSDrr, X86::VPDPBUSDrm, 0},
   {X86::VPDPBUUDSYrr, X86::VPDPBUUDSYrm, 0},
-  {X86::VPDPBUUDSZ128r, X86::VPDPBUUDSZ128m, 0},
-  {X86::VPDPBUUDSZ256r, X86::VPDPBUUDSZ256m, 0},
-  {X86::VPDPBUUDSZr, X86::VPDPBUUDSZm, 0},
+  {X86::VPDPBUUDSZ128rr, X86::VPDPBUUDSZ128rm, 0},
+  {X86::VPDPBUUDSZ256rr, X86::VPDPBUUDSZ256rm, 0},
+  {X86::VPDPBUUDSZrr, X86::VPDPBUUDSZrm, 0},
   {X86::VPDPBUUDSrr, X86::VPDPBUUDSrm, 0},
   {X86::VPDPBUUDYrr, X86::VPDPBUUDYrm, 0},
-  {X86::VPDPBUUDZ128r, X86::VPDPBUUDZ128m, 0},
-  {X86::VPDPBUUDZ256r, X86::VPDPBUUDZ256m, 0},
-  {X86::VPDPBUUDZr, X86::VPDPBUUDZm, 0},
+  {X86::VPDPBUUDZ128rr, X86::VPDPBUUDZ128rm, 0},
+  {X86::VPDPBUUDZ256rr, X86::VPDPBUUDZ256rm, 0},
+  {X86::VPDPBUUDZrr, X86::VPDPBUUDZrm, 0},
   {X86::VPDPBUUDrr, X86::VPDPBUUDrm, 0},
   {X86::VPDPWSSDSYrr, X86::VPDPWSSDSYrm, 0},
-  {X86::VPDPWSSDSZ128r, X86::VPDPWSSDSZ128m, 0},
-  {X86::VPDPWSSDSZ256r, X86::VPDPWSSDSZ256m, 0},
-  {X86::VPDPWSSDSZr, X86::VPDPWSSDSZm, 0},
+  {X86::VPDPWSSDSZ128rr, X86::VPDPWSSDSZ128rm, 0},
+  {X86::VPDPWSSDSZ256rr, X86::VPDPWSSDSZ256rm, 0},
+  {X86::VPDPWSSDSZrr, X86::VPDPWSSDSZrm, 0},
   {X86::VPDPWSSDSrr, X86::VPDPWSSDSrm, 0},
   {X86::VPDPWSSDYrr, X86::VPDPWSSDYrm, 0},
-  {X86::VPDPWSSDZ128r, X86::VPDPWSSDZ128m, 0},
-  {X86::VPDPWSSDZ256r, X86::VPDPWSSDZ256m, 0},
-  {X86::VPDPWSSDZr, X86::VPDPWSSDZm, 0},
+  {X86::VPDPWSSDZ128rr, X86::VPDPWSSDZ128rm, 0},
+  {X86::VPDPWSSDZ256rr, X86::VPDPWSSDZ256rm, 0},
+  {X86::VPDPWSSDZrr, X86::VPDPWSSDZrm, 0},
   {X86::VPDPWSSDrr, X86::VPDPWSSDrm, 0},
   {X86::VPDPWSUDSYrr, X86::VPDPWSUDSYrm, 0},
-  {X86::VPDPWSUDSZ128r, X86::VPDPWSUDSZ128m, 0},
-  {X86::VPDPWSUDSZ256r, X86::VPDPWSUDSZ256m, 0},
-  {X86::VPDPWSUDSZr, X86::VPDPWSUDSZm, 0},
+  {X86::VPDPWSUDSZ128rr, X86::VPDPWSUDSZ128rm, 0},
+  {X86::VPDPWSUDSZ256rr, X86::VPDPWSUDSZ256rm, 0},
+  {X86::VPDPWSUDSZrr, X86::VPDPWSUDSZrm, 0},
   {X86::VPDPWSUDSrr, X86::VPDPWSUDSrm, 0},
   {X86::VPDPWSUDYrr, X86::VPDPWSUDYrm, 0},
-  {X86::VPDPWSUDZ128r, X86::VPDPWSUDZ128m, 0},
-  {X86::VPDPWSUDZ256r, X86::VPDPWSUDZ256m, 0},
-  {X86::VPDPWSUDZr, X86::VPDPWSUDZm, 0},
+  {X86::VPDPWSUDZ128rr, X86::VPDPWSUDZ128rm, 0},
+  {X86::VPDPWSUDZ256rr, X86::VPDPWSUDZ256rm, 0},
+  {X86::VPDPWSUDZrr, X86::VPDPWSUDZrm, 0},
   {X86::VPDPWSUDrr, X86::VPDPWSUDrm, 0},
   {X86::VPDPWUSDSYrr, X86::VPDPWUSDSYrm, 0},
-  {X86::VPDPWUSDSZ128r, X86::VPDPWUSDSZ128m, 0},
-  {X86::VPDPWUSDSZ256r, X86::VPDPWUSDSZ256m, 0},
-  {X86::VPDPWUSDSZr, X86::VPDPWUSDSZm, 0},
+  {X86::VPDPWUSDSZ128rr, X86::VPDPWUSDSZ128rm, 0},
+  {X86::VPDPWUSDSZ256rr, X86::VPDPWUSDSZ256rm, 0},
+  {X86::VPDPWUSDSZrr, X86::VPDPWUSDSZrm, 0},
   {X86::VPDPWUSDSrr, X86::VPDPWUSDSrm, 0},
   {X86::VPDPWUSDYrr, X86::VPDPWUSDYrm, 0},
-  {X86::VPDPWUSDZ128r, X86::VPDPWUSDZ128m, 0},
-  {X86::VPDPWUSDZ256r, X86::VPDPWUSDZ256m, 0},
-  {X86::VPDPWUSDZr, X86::VPDPWUSDZm, 0},
+  {X86::VPDPWUSDZ128rr, X86::VPDPWUSDZ128rm, 0},
+  {X86::VPDPWUSDZ256rr, X86::VPDPWUSDZ256rm, 0},
+  {X86::VPDPWUSDZrr, X86::VPDPWUSDZrm, 0},
   {X86::VPDPWUSDrr, X86::VPDPWUSDrm, 0},
   {X86::VPDPWUUDSYrr, X86::VPDPWUUDSYrm, 0},
-  {X86::VPDPWUUDSZ128r, X86::VPDPWUUDSZ128m, 0},
-  {X86::VPDPWUUDSZ256r, X86::VPDPWUUDSZ256m, 0},
-  {X86::VPDPWUUDSZr, X86::VPDPWUUDSZm, 0},
+  {X86::VPDPWUUDSZ128rr, X86::VPDPWUUDSZ128rm, 0},
+  {X86::VPDPWUUDSZ256rr, X86::VPDPWUUDSZ256rm, 0},
+  {X86::VPDPWUUDSZrr, X86::VPDPWUUDSZrm, 0},
   {X86::VPDPWUUDSrr, X86::VPDPWUUDSrm, 0},
   {X86::VPDPWUUDYrr, X86::VPDPWUUDYrm, 0},
-  {X86::VPDPWUUDZ128r, X86::VPDPWUUDZ128m, 0},
-  {X86::VPDPWUUDZ256r, X86::VPDPWUUDZ256m, 0},
-  {X86::VPDPWUUDZr, X86::VPDPWUUDZm, 0},
+  {X86::VPDPWUUDZ128rr, X86::VPDPWUUDZ128rm, 0},
+  {X86::VPDPWUUDZ256rr, X86::VPDPWUUDZ256rm, 0},
+  {X86::VPDPWUUDZrr, X86::VPDPWUUDZrm, 0},
   {X86::VPDPWUUDrr, X86::VPDPWUUDrm, 0},
   {X86::VPERMBZ128rrkz, X86::VPERMBZ128rmkz, 0},
   {X86::VPERMBZ256rrkz, X86::VPERMBZ256rmkz, 0},
@@ -6855,102 +6855,102 @@ static const X86FoldTableEntry Table4[] = {
   {X86::VPAVGWZ128rrk, X86::VPAVGWZ128rmk, 0},
   {X86::VPAVGWZ256rrk, X86::VPAVGWZ256rmk, 0},
   {X86::VPAVGWZrrk, X86::VPAVGWZrmk, 0},
-  {X86::VPDPBSSDSZ128rk, X86::VPDPBSSDSZ128mk, 0},
-  {X86::VPDPBSSDSZ128rkz, X86::VPDPBSSDSZ128mkz, 0},
-  {X86::VPDPBSSDSZ256rk, X86::VPDPBSSDSZ256mk, 0},
-  {X86::VPDPBSSDSZ256rkz, X86::VPDPBSSDSZ256mkz, 0},
-  {X86::VPDPBSSDSZrk, X86::VPDPBSSDSZmk, 0},
-  {X86::VPDPBSSDSZrkz, X86::VPDPBSSDSZmkz, 0},
-  {X86::VPDPBSSDZ128rk, X86::VPDPBSSDZ128mk, 0},
-  {X86::VPDPBSSDZ128rkz, X86::VPDPBSSDZ128mkz, 0},
-  {X86::VPDPBSSDZ256rk, X86::VPDPBSSDZ256mk, 0},
-  {X86::VPDPBSSDZ256rkz, X86::VPDPBSSDZ256mkz, 0},
-  {X86::VPDPBSSDZrk, X86::VPDPBSSDZmk, 0},
-  {X86::VPDPBSSDZrkz, X86::VPDPBSSDZmkz, 0},
-  {X86::VPDPBSUDSZ128rk, X86::VPDPBSUDSZ128mk, 0},
-  {X86::VPDPBSUDSZ128rkz, X86::VPDPBSUDSZ128mkz, 0},
-  {X86::VPDPBSUDSZ256rk, X86::VPDPBSUDSZ256mk, 0},
-  {X86::VPDPBSUDSZ256rkz, X86::VPDPBSUDSZ256mkz, 0},
-  {X86::VPDPBSUDSZrk, X86::VPDPBSUDSZmk, 0},
-  {X86::VPDPBSUDSZrkz, X86::VPDPBSUDSZmkz, 0},
-  {X86::VPDPBSUDZ128rk, X86::VPDPBSUDZ128mk, 0},
-  {X86::VPDPBSUDZ128rkz, X86::VPDPBSUDZ128mkz, 0},
-  {X86::VPDPBSUDZ256rk, X86::VPDPBSUDZ256mk, 0},
-  {X86::VPDPBSUDZ256rkz, X86::VPDPBSUDZ256mkz, 0},
-  {X86::VPDPBSUDZrk, X86::VPDPBSUDZmk, 0},
-  {X86::VPDPBSUDZrkz, X86::VPDPBSUDZmkz, 0},
-  {X86::VPDPBUSDSZ128rk, X86::VPDPBUSDSZ128mk, 0},
-  {X86::VPDPBUSDSZ128rkz, X86::VPDPBUSDSZ128mkz, 0},
-  {X86::VPDPBUSDSZ256rk, X86::VPDPBUSDSZ256mk, 0},
-  {X86::VPDPBUSDSZ256rkz, X86::VPDPBUSDSZ256mkz, 0},
-  {X86::VPDPBUSDSZrk, X86::VPDPBUSDSZmk, 0},
-  {X86::VPDPBUSDSZrkz, X86::VPDPBUSDSZmkz, 0},
-  {X86::VPDPBUSDZ128rk, X86::VPDPBUSDZ128mk, 0},
-  {X86::VPDPBUSDZ128rkz, X86::VPDPBUSDZ128mkz, 0},
-  {X86::VPDPBUSDZ256rk, X86::VPDPBUSDZ256mk, 0},
-  {X86::VPDPBUSDZ256rkz, X86::VPDPBUSDZ256mkz, 0},
-  {X86::VPDPBUSDZrk, X86::VPDPBUSDZmk, 0},
-  {X86::VPDPBUSDZrkz, X86::VPDPBUSDZmkz, 0},
-  {X86::VPDPBUUDSZ128rk, X86::VPDPBUUDSZ128mk, 0},
-  {X86::VPDPBUUDSZ128rkz, X86::VPDPBUUDSZ128mkz, 0},
-  {X86::VPDPBUUDSZ256rk, X86::VPDPBUUDSZ256mk, 0},
-  {X86::VPDPBUUDSZ256rkz, X86::VPDPBUUDSZ256mkz, 0},
-  {X86::VPDPBUUDSZrk, X86::VPDPBUUDSZmk, 0},
-  {X86::VPDPBUUDSZrkz, X86::VPDPBUUDSZmkz, 0},
-  {X86::VPDPBUUDZ128rk, X86::VPDPBUUDZ128mk, 0},
-  {X86::VPDPBUUDZ128rkz, X86::VPDPBUUDZ128mkz, 0},
-  {X86::VPDPBUUDZ256rk, X86::VPDPBUUDZ256mk, 0},
-  {X86::VPDPBUUDZ256rkz, X86::VPDPBUUDZ256mkz, 0},
-  {X86::VPDPBUUDZrk, X86::VPDPBUUDZmk, 0},
-  {X86::VPDPBUUDZrkz, X86::VPDPBUUDZmkz, 0},
-  {X86::VPDPWSSDSZ128rk, X86::VPDPWSSDSZ128mk, 0},
-  {X86::VPDPWSSDSZ128rkz, X86::VPDPWSSDSZ128mkz, 0},
-  {X86::VPDPWSSDSZ256rk, X86::VPDPWSSDSZ256mk, 0},
-  {X86::VPDPWSSDSZ256rkz, X86::VPDPWSSDSZ256mkz, 0},
-  {X86::VPDPWSSDSZrk, X86::VPDPWSSDSZmk, 0},
-  {X86::VPDPWSSDSZrkz, X86::VPDPWSSDSZmkz, 0},
-  {X86::VPDPWSSDZ128rk, X86::VPDPWSSDZ128mk, 0},
-  {X86::VPDPWSSDZ128rkz, X86::VPDPWSSDZ128mkz, 0},
-  {X86::VPDPWSSDZ256rk, X86::VPDPWSSDZ256mk, 0},
-  {X86::VPDPWSSDZ256rkz, X86::VPDPWSSDZ256mkz, 0},
-  {X86::VPDPWSSDZrk, X86::VPDPWSSDZmk, 0},
-  {X86::VPDPWSSDZrkz, X86::VPDPWSSDZmkz, 0},
-  {X86::VPDPWSUDSZ128rk, X86::VPDPWSUDSZ128mk, 0},
-  {X86::VPDPWSUDSZ128rkz, X86::VPDPWSUDSZ128mkz, 0},
-  {X86::VPDPWSUDSZ256rk, X86::VPDPWSUDSZ256mk, 0},
-  {X86::VPDPWSUDSZ256rkz, X86::VPDPWSUDSZ256mkz, 0},
-  {X86::VPDPWSUDSZrk, X86::VPDPWSUDSZmk, 0},
-  {X86::VPDPWSUDSZrkz, X86::VPDPWSUDSZmkz, 0},
-  {X86::VPDPWSUDZ128rk, X86::VPDPWSUDZ128mk, 0},
-  {X86::VPDPWSUDZ128rkz, X86::VPDPWSUDZ128mkz, 0},
-  {X86::VPDPWSUDZ256rk, X86::VPDPWSUDZ256mk, 0},
-  {X86::VPDPWSUDZ256rkz, X86::VPDPWSUDZ256mkz, 0},
-  {X86::VPDPWSUDZrk, X86::VPDPWSUDZmk, 0},
-  {X86::VPDPWSUDZrkz, X86::VPDPWSUDZmkz, 0},
-  {X86::VPDPWUSDSZ128rk, X86::VPDPWUSDSZ128mk, 0},
-  {X86::VPDPWUSDSZ128rkz, X86::VPDPWUSDSZ128mkz, 0},
-  {X86::VPDPWUSDSZ256rk, X86::VPDPWUSDSZ256mk, 0},
-  {X86::VPDPWUSDSZ256rkz, X86::VPDPWUSDSZ256mkz, 0},
-  {X86::VPDPWUSDSZrk, X86::VPDPWUSDSZmk, 0},
-  {X86::VPDPWUSDSZrkz, X86::VPDPWUSDSZmkz, 0},
-  {X86::VPDPWUSDZ128rk, X86::VPDPWUSDZ128mk, 0},
-  {X86::VPDPWUSDZ128rkz, X86::VPDPWUSDZ128mkz, 0},
-  {X86::VPDPWUSDZ256rk, X86::VPDPWUSDZ256mk, 0},
-  {X86::VPDPWUSDZ256rkz, X86::VPDPWUSDZ256mkz, 0},
-  {X86::VPDPWUSDZrk, X86::VPDPWUSDZmk, 0},
-  {X86::VPDPWUSDZrkz, X86::VPDPWUSDZmkz, 0},
-  {X86::VPDPWUUDSZ128rk, X86::VPDPWUUDSZ128mk, 0},
-  {X86::VPDPWUUDSZ128rkz, X86::VPDPWUUDSZ128mkz, 0},
-  {X86::VPDPWUUDSZ256rk, X86::VPDPWUUDSZ256mk, 0},
-  {X86::VPDPWUUDSZ256rkz, X86::VPDPWUUDSZ256mkz, 0},
-  {X86::VPDPWUUDSZrk, X86::VPDPWUUDSZmk, 0},
-  {X86::VPDPWUUDSZrkz, X86::VPDPWUUDSZmkz, 0},
-  {X86::VPDPWUUDZ128rk, X86::VPDPWUUDZ128mk, 0},
-  {X86::VPDPWUUDZ128rkz, X86::VPDPWUUDZ128mkz, 0},
-  {X86::VPDPWUUDZ256rk, X86::VPDPWUUDZ256mk, 0},
-  {X86::VPDPWUUDZ256rkz, X86::VPDPWUUDZ256mkz, 0},
-  {X86::VPDPWUUDZrk, X86::VPDPWUUDZmk, 0},
-  {X86::VPDPWUUDZrkz, X86::VPDPWUUDZmkz, 0},
+  {X86::VPDPBSSDSZ128rrk, X86::VPDPBSSDSZ128rmk, 0},
+  {X86::VPDPBSSDSZ128rrkz, X86::VPDPBSSDSZ128rmkz, 0},
+  {X86::VPDPBSSDSZ256rrk, X86::VPDPBSSDSZ256rmk, 0},
+  {X86::VPDPBSSDSZ256rrkz, X86::VPDPBSSDSZ256rmkz, 0},
+  {X86::VPDPBSSDSZrrk, X86::VPDPBSSDSZrmk, 0},
+  {X86::VPDPBSSDSZrrkz, X86::VPDPBSSDSZrmkz, 0},
+  {X86::VPDPBSSDZ128rrk, X86::VPDPBSSDZ128rmk, 0},
+  {X86::VPDPBSSDZ128rrkz, X86::VPDPBSSDZ128rmkz, 0},
+  {X86::VPDPBSSDZ256rrk, X86::VPDPBSSDZ256rmk, 0},
+  {X86::VPDPBSSDZ256rrkz, X86::VPDPBSSDZ256rmkz, 0},
+  {X86::VPDPBSSDZrrk, X86::VPDPBSSDZrmk, 0},
+  {X86::VPDPBSSDZrrkz, X86::VPDPBSSDZrmkz, 0},
+  {X86::VPDPBSUDSZ128rrk, X86::VPDPBSUDSZ128rmk, 0},
+  {X86::VPDPBSUDSZ128rrkz, X86::VPDPBSUDSZ128rmkz, 0},
+  {X86::VPDPBSUDSZ256rrk, X86::VPDPBSUDSZ256rmk, 0},
+  {X86::VPDPBSUDSZ256rrkz, X86::VPDPBSUDSZ256rmkz, 0},
+  {X86::VPDPBSUDSZrrk, X86::VPDPBSUDSZrmk, 0},
+  {X86::VPDPBSUDSZrrkz, X86::VPDPBSUDSZrmkz, 0},
+  {X86::VPDPBSUDZ128rrk, X86::VPDPBSUDZ128rmk, 0},
+  {X86::VPDPBSUDZ128rrkz, X86::VPDPBSUDZ128rmkz, 0},
+  {X86::VPDPBSUDZ256rrk, X86::VPDPBSUDZ256rmk, 0},
+  {X86::VPDPBSUDZ256rrkz, X86::VPDPBSUDZ256rmkz, 0},
+  {X86::VPDPBSUDZrrk, X86::VPDPBSUDZrmk, 0},
+  {X86::VPDPBSUDZrrkz, X86::VPDPBSUDZrmkz, 0},
+  {X86::VPDPBUSDSZ128rrk, X86::VPDPBUSDSZ128rmk, 0},
+  {X86::VPDPBUSDSZ128rrkz, X86::VPDPBUSDSZ128rmkz, 0},
+  {X86::VPDPBUSDSZ256rrk, X86::VPDPBUSDSZ256rmk, 0},
+  {X86::VPDPBUSDSZ256rrkz, X86::VPDPBUSDSZ256rmkz, 0},
+  {X86::VPDPBUSDSZrrk, X86::VPDPBUSDSZrmk, 0},
+  {X86::VPDPBUSDSZrrkz, X86::VPDPBUSDSZrmkz, 0},
+  {X86::VPDPBUSDZ128rrk, X86::VPDPBUSDZ128rmk, 0},
+  {X86::VPDPBUSDZ128rrkz, X86::VPDPBUSDZ128rmkz, 0},
+  {X86::VPDPBUSDZ256rrk, X86::VPDPBUSDZ256rmk, 0},
+  {X86::VPDPBUSDZ256rrkz, X86::VPDPBUSDZ256rmkz, 0},
+  {X86::VPDPBUSDZrrk, X86::VPDPBUSDZrmk, 0},
+  {X86::VPDPBUSDZrrkz, X86::VPDPBUSDZrmkz, 0},
+  {X86::VPDPBUUDSZ128rrk, X86::VPDPBUUDSZ128rmk, 0},
+  {X86::VPDPBUUDSZ128rrkz, X86::VPDPBUUDSZ128rmkz, 0},
+  {X86::VPDPBUUDSZ256rrk, X86::VPDPBUUDSZ256rmk, 0},
+  {X86::VPDPBUUDSZ256rrkz, X86::VPDPBUUDSZ256rmkz, 0},
+  {X86::VPDPBUUDSZrrk, X86::VPDPBUUDSZrmk, 0},
+  {X86::VPDPBUUDSZrrkz, X86::VPDPBUUDSZrmkz, 0},
+  {X86::VPDPBUUDZ128rrk, X86::VPDPBUUDZ128rmk, 0},
+  {X86::VPDPBUUDZ128rrkz, X86::VPDPBUUDZ128rmkz, 0},
+  {X86::VPDPBUUDZ256rrk, X86::VPDPBUUDZ256rmk, 0},
+  {X86::VPDPBUUDZ256rrkz, X86::VPDPBUUDZ256rmkz, 0},
+  {X86::VPDPBUUDZrrk, X86::VPDPBUUDZrmk, 0},
+  {X86::VPDPBUUDZrrkz, X86::VPDPBUUDZrmkz, 0},
+  {X86::VPDPWSSDSZ128rrk, X86::VPDPWSSDSZ128rmk, 0},
+  {X86::VPDPWSSDSZ128rrkz, X86::VPDPWSSDSZ128rmkz, 0},
+  {X86::VPDPWSSDSZ256rrk, X86::VPDPWSSDSZ256rmk, 0},
+  {X86::VPDPWSSDSZ256rrkz, X86::VPDPWSSDSZ256rmkz, 0},
+  {X86::VPDPWSSDSZrrk, X86::VPDPWSSDSZrmk, 0},
+  {X86::VPDPWSSDSZrrkz, X86::VPDPWSSDSZrmkz, 0},
+  {X86::VPDPWSSDZ128rrk, X86::VPDPWSSDZ128rmk, 0},
+  {X86::VPDPWSSDZ128rrkz, X86::VPDPWSSDZ128rmkz, 0},
+  {X86::VPDPWSSDZ256rrk, X86::VPDPWSSDZ256rmk, 0},
+  {X86::VPDPWSSDZ256rrkz, X86::VPDPWSSDZ256rmkz, 0},
+  {X86::VPDPWSSDZrrk, X86::VPDPWSSDZrmk, 0},
+  {X86::VPDPWSSDZrrkz, X86::VPDPWSSDZrmkz, 0},
+  {X86::VPDPWSUDSZ128rrk, X86::VPDPWSUDSZ128rmk, 0},
+  {X86::VPDPWSUDSZ128rrkz, X86::VPDPWSUDSZ128rmkz, 0},
+  {X86::VPDPWSUDSZ256rrk, X86::VPDPWSUDSZ256rmk, 0},
+  {X86::VPDPWSUDSZ256rrkz, X86::VPDPWSUDSZ256rmkz, 0},
+  {X86::VPDPWSUDSZrrk, X86::VPDPWSUDSZrmk, 0},
+  {X86::VPDPWSUDSZrrkz, X86::VPDPWSUDSZrmkz, 0},
+  {X86::VPDPWSUDZ128rrk, X86::VPDPWSUDZ128rmk, 0},
+  {X86::VPDPWSUDZ128rrkz, X86::VPDPWSUDZ128rmkz, 0},
+  {X86::VPDPWSUDZ256rrk, X86::VPDPWSUDZ256rmk, 0},
+  {X86::VPDPWSUDZ256rrkz, X86::VPDPWSUDZ256rmkz, 0},
+  {X86::VPDPWSUDZrrk, X86::VPDPWSUDZrmk, 0},
+  {X86::VPDPWSUDZrrkz, X86::VPDPWSUDZrmkz, 0},
+  {X86::VPDPWUSDSZ128rrk, X86::VPDPWUSDSZ128rmk, 0},
+  {X86::VPDPWUSDSZ128rrkz, X86::VPDPWUSDSZ128rmkz, 0},
+  {X86::VPDPWUSDSZ256rrk, X86::VPDPWUSDSZ256rmk, 0},
+  {X86::VPDPWUSDSZ256rrkz, X86::VPDPWUSDSZ256rmkz, 0},
+  {X86::VPDPWUSDSZrrk, X86::VPDPWUSDSZrmk, 0},
+  {X86::VPDPWUSDSZrrkz, X86::VPDPWUSDSZrmkz, 0},
+  {X86::VPDPWUSDZ128rrk, X86::VPDPWUSDZ128rmk, 0},
+  {X86::VPDPWUSDZ128rrkz, X86::VPDPWUSDZ128rmkz, 0},
+  {X86::VPDPWUSDZ256rrk, X86::VPDPWUSDZ256rmk, 0},
+  {X86::VPDPWUSDZ256rrkz, X86::VPDPWUSDZ256rmkz, 0},
+  {X86::VPDPWUSDZrrk, X86::VPDPWUSDZrmk, 0},
+  {X86::VPDPWUSDZrrkz, X86::VPDPWUSDZrmkz, 0},
+  {X86::VPDPWUUDSZ128rrk, X86::VPDPWUUDSZ128rmk, 0},
+  {X86::VPDPWUUDSZ128rrkz, X86::VPDPWUUDSZ128rmkz, 0},
+  {X86::VPDPWUUDSZ256rrk, X86::VPDPWUUDSZ256rmk, 0},
+  {X86::VPDPWUUDSZ256rrkz, X86::VPDPWUUDSZ256rmkz, 0},
+  {X86::VPDPWUUDSZrrk, X86::VPDPWUUDSZrmk, 0},
+  {X86::VPDPWUUDSZrrkz, X86::VPDPWUUDSZrmkz, 0},
+  {X86::VPDPWUUDZ128rrk, X86::VPDPWUUDZ128rmk, 0},
+  {X86::VPDPWUUDZ128rrkz, X86::VPDPWUUDZ128rmkz, 0},
+  {X86::VPDPWUUDZ256rrk, X86::VPDPWUUDZ256rmk, 0},
+  {X86::VPDPWUUDZ256rrkz, X86::VPDPWUUDZ256rmkz, 0},
+  {X86::VPDPWUUDZrrk, X86::VPDPWUUDZrmk, 0},
+  {X86::VPDPWUUDZrrkz, X86::VPDPWUUDZrmkz, 0},
   {X86::VPERMBZ128rrk, X86::VPERMBZ128rmk, 0},
   {X86::VPERMBZ256rrk, X86::VPERMBZ256rmk, 0},
   {X86::VPERMBZrrk, X86::VPERMBZrmk, 0},
@@ -9339,54 +9339,54 @@ static const X86FoldTableEntry BroadcastTable3[] = {
   {X86::VPCONFLICTQZ128rrk, X86::VPCONFLICTQZ128rmbk, TB_BCAST_Q},
   {X86::VPCONFLICTQZ256rrk, X86::VPCONFLICTQZ256rmbk, TB_BCAST_Q},
   {X86::VPCONFLICTQZrrk, X86::VPCONFLICTQZrmbk, TB_BCAST_Q},
-  {X86::VPDPBSSDSZ128r, X86::VPDPBSSDSZ128mb, TB_BCAST_D},
-  {X86::VPDPBSSDSZ256r, X86::VPDPBSSDSZ256mb, TB_BCAST_D},
-  {X86::VPDPBSSDSZr, X86::VPDPBSSDSZmb, TB_BCAST_D},
-  {X86::VPDPBSSDZ128r, X86::VPDPBSSDZ128mb, TB_BCAST_D},
-  {X86::VPDPBSSDZ256r, X86::VPDPBSSDZ256mb, TB_BCAST_D},
-  {X86::VPDPBSSDZr, X86::VPDPBSSDZmb, TB_BCAST_D},
-  {X86::VPDPBSUDSZ128r, X86::VPDPBSUDSZ128mb, TB_BCAST_D},
-  {X86::VPDPBSUDSZ256r, X86::VPDPBSUDSZ256mb, TB_BCAST_D},
-  {X86::VPDPBSUDSZr, X86::VPDPBSUDSZmb, TB_BCAST_D},
-  {X86::VPDPBSUDZ128r, X86::VPDPBSUDZ128mb, TB_BCAST_D},
-  {X86::VPDPBSUDZ256r, X86::VPDPBSUDZ256mb, TB_BCAST_D},
-  {X86::VPDPBSUDZr, X86::VPDPBSUDZmb, TB_BCAST_D},
-  {X86::VPDPBUSDSZ128r, X86::VPDPBUSDSZ128mb, TB_BCAST_D},
-  {X86::VPDPBUSDSZ256r, X86::VPDPBUSDSZ256mb, TB_BCAST_D},
-  {X86::VPDPBUSDSZr, X86::VPDPBUSDSZmb, TB_BCAST_D},
-  {X86::VPDPBUSDZ128r, X86::VPDPBUSDZ128mb, TB_BCAST_D},
-  {X86::VPDPBUSDZ256r, X86::VPDPBUSDZ256mb, TB_BCAST_D},
-  {X86::VPDPBUSDZr, X86::VPDPBUSDZmb, TB_BCAST_D},
-  {X86::VPDPBUUDSZ128r, X86::VPDPBUUDSZ128mb, TB_BCAST_D},
-  {X86::VPDPBUUDSZ256r, X86::VPDPBUUDSZ256mb, TB_BCAST_D},
-  {X86::VPDPBUUDSZr, X86::VPDPBUUDSZmb, TB_BCAST_D},
-  {X86::VPDPBUUDZ128r, X86::VPDPBUUDZ128mb, TB_BCAST_D},
-  {X86::VPDPBUUDZ256r, X86::VPDPBUUDZ256mb, TB_BCAST_D},
-  {X86::VPDPBUUDZr, X86::VPDPBUUDZmb, TB_BCAST_D},
-  {X86::VPDPWSSDSZ128r, X86::VPDPWSSDSZ128mb, TB_BCAST_D},
-  {X86::VPDPWSSDSZ256r, X86::VPDPWSSDSZ256mb, TB_BCAST_D},
-  {X86::VPDPWSSDSZr, X86::VPDPWSSDSZmb, TB_BCAST_D},
-  {X86::VPDPWSSDZ128r, X86::VPDPWSSDZ128mb, TB_BCAST_D},
-  {X86::VPDPWSSDZ256r, X86::VPDPWSSDZ256mb, TB_BCAST_D},
-  {X86::VPDPWSSDZr, X86::VPDPWSSDZmb, TB_BCAST_D},
-  {X86::VPDPWSUDSZ128r, X86::VPDPWSUDSZ128mb, TB_BCAST_D},
-  {X86::VPDPWSUDSZ256r, X86::VPDPWSUDSZ256mb, TB_BCAST_D},
-  {X86::VPDPWSUDSZr, X86::VPDPWSUDSZmb, TB_BCAST_D},
-  {X86::VPDPWSUDZ128r, X86::VPDPWSUDZ128mb, TB_BCAST_D},
-  {X86::VPDPWSUDZ256r, X86::VPDPWSUDZ256mb, TB_BCAST_D},
-  {X86::VPDPWSUDZr, X86::VPDPWSUDZmb, TB_BCAST_D},
-  {X86::VPDPWUSDSZ128r, X86::VPDPWUSDSZ128mb, TB_BCAST_D},
-  {X86::VPDPWUSDSZ256r, X86::VPDPWUSDSZ256mb, TB_BCAST_D},
-  {X86::VPDPWUSDSZr, X86::VPDPWUSDSZmb, TB_BCAST_D},
-  {X86::VPDPWUSDZ128r, X86::VPDPWUSDZ128mb, TB_BCAST_D},
-  {X86::VPDPWUSDZ256r, X86::VPDPWUSDZ256mb, TB_BCAST_D},
-  {X86::VPDPWUSDZr, X86::VPDPWUSDZmb, TB_BCAST_D},
-  {X86::VPDPWUUDSZ128r, X86::VPDPWUUDSZ128mb, TB_BCAST_D},
-  {X86::VPDPWUUDSZ256r, X86::VPDPWUUDSZ256mb, TB_BCAST_D},
-  {X86::VPDPWUUDSZr, X86::VPDPWUUDSZmb, TB_BCAST_D},
-  {X86::VPDPWUUDZ128r, X86::VPDPWUUDZ128mb, TB_BCAST_D},
-  {X86::VPDPWUUDZ256r, X86::VPDPWUUDZ256mb, TB_BCAST_D},
-  {X86::VPDPWUUDZr, X86::VPDPWUUDZmb, TB_BCAST_D},
+  {X86::VPDPBSSDSZ128rr, X86::VPDPBSSDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPBSSDSZ256rr, X86::VPDPBSSDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPBSSDSZrr, X86::VPDPBSSDSZrmb, TB_BCAST_D},
+  {X86::VPDPBSSDZ128rr, X86::VPDPBSSDZ128rmb, TB_BCAST_D},
+  {X86::VPDPBSSDZ256rr, X86::VPDPBSSDZ256rmb, TB_BCAST_D},
+  {X86::VPDPBSSDZrr, X86::VPDPBSSDZrmb, TB_BCAST_D},
+  {X86::VPDPBSUDSZ128rr, X86::VPDPBSUDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPBSUDSZ256rr, X86::VPDPBSUDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPBSUDSZrr, X86::VPDPBSUDSZrmb, TB_BCAST_D},
+  {X86::VPDPBSUDZ128rr, X86::VPDPBSUDZ128rmb, TB_BCAST_D},
+  {X86::VPDPBSUDZ256rr, X86::VPDPBSUDZ256rmb, TB_BCAST_D},
+  {X86::VPDPBSUDZrr, X86::VPDPBSUDZrmb, TB_BCAST_D},
+  {X86::VPDPBUSDSZ128rr, X86::VPDPBUSDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPBUSDSZ256rr, X86::VPDPBUSDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPBUSDSZrr, X86::VPDPBUSDSZrmb, TB_BCAST_D},
+  {X86::VPDPBUSDZ128rr, X86::VPDPBUSDZ128rmb, TB_BCAST_D},
+  {X86::VPDPBUSDZ256rr, X86::VPDPBUSDZ256rmb, TB_BCAST_D},
+  {X86::VPDPBUSDZrr, X86::VPDPBUSDZrmb, TB_BCAST_D},
+  {X86::VPDPBUUDSZ128rr, X86::VPDPBUUDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPBUUDSZ256rr, X86::VPDPBUUDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPBUUDSZrr, X86::VPDPBUUDSZrmb, TB_BCAST_D},
+  {X86::VPDPBUUDZ128rr, X86::VPDPBUUDZ128rmb, TB_BCAST_D},
+  {X86::VPDPBUUDZ256rr, X86::VPDPBUUDZ256rmb, TB_BCAST_D},
+  {X86::VPDPBUUDZrr, X86::VPDPBUUDZrmb, TB_BCAST_D},
+  {X86::VPDPWSSDSZ128rr, X86::VPDPWSSDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPWSSDSZ256rr, X86::VPDPWSSDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPWSSDSZrr, X86::VPDPWSSDSZrmb, TB_BCAST_D},
+  {X86::VPDPWSSDZ128rr, X86::VPDPWSSDZ128rmb, TB_BCAST_D},
+  {X86::VPDPWSSDZ256rr, X86::VPDPWSSDZ256rmb, TB_BCAST_D},
+  {X86::VPDPWSSDZrr, X86::VPDPWSSDZrmb, TB_BCAST_D},
+  {X86::VPDPWSUDSZ128rr, X86::VPDPWSUDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPWSUDSZ256rr, X86::VPDPWSUDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPWSUDSZrr, X86::VPDPWSUDSZrmb, TB_BCAST_D},
+  {X86::VPDPWSUDZ128rr, X86::VPDPWSUDZ128rmb, TB_BCAST_D},
+  {X86::VPDPWSUDZ256rr, X86::VPDPWSUDZ256rmb, TB_BCAST_D},
+  {X86::VPDPWSUDZrr, X86::VPDPWSUDZrmb, TB_BCAST_D},
+  {X86::VPDPWUSDSZ128rr, X86::VPDPWUSDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPWUSDSZ256rr, X86::VPDPWUSDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPWUSDSZrr, X86::VPDPWUSDSZrmb, TB_BCAST_D},
+  {X86::VPDPWUSDZ128rr, X86::VPDPWUSDZ128rmb, TB_BCAST_D},
+  {X86::VPDPWUSDZ256rr, X86::VPDPWUSDZ256rmb, TB_BCAST_D},
+  {X86::VPDPWUSDZrr, X86::VPDPWUSDZrmb, TB_BCAST_D},
+  {X86::VPDPWUUDSZ128rr, X86::VPDPWUUDSZ128rmb, TB_BCAST_D},
+  {X86::VPDPWUUDSZ256rr, X86::VPDPWUUDSZ256rmb, TB_BCAST_D},
+  {X86::VPDPWUUDSZrr, X86::VPDPWUUDSZrmb, TB_BCAST_D},
+  {X86::VPDPWUUDZ128rr, X86::VPDPWUUDZ128rmb, TB_BCAST_D},
+  {X86::VPDPWUUDZ256rr, X86::VPDPWUUDZ256rmb, TB_BCAST_D},
+  {X86::VPDPWUUDZrr, X86::VPDPWUUDZrmb, TB_BCAST_D},
   {X86::VPERMDZ256rrkz, X86::VPERMDZ256rmbkz, TB_BCAST_D},
   {X86::VPERMDZrrkz, X86::VPERMDZrmbkz, TB_BCAST_D},
   {X86::VPERMI2DZ128rr, X86::VPERMI2DZ128rmb, TB_BCAST_D},
@@ -10368,102 +10368,102 @@ static const X86FoldTableEntry BroadcastTable4[] = {
   {X86::VPANDQZ128rrk, X86::VPANDQZ128rmbk, TB_BCAST_Q},
   {X86::VPANDQZ256rrk, X86::VPANDQZ256rmbk, TB_BCAST_Q},
   {X86::VPANDQZrrk, X86::VPANDQZrmbk, TB_BCAST_Q},
-  {X86::VPDPBSSDSZ128rk, X86::VPDPBSSDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPBSSDSZ128rkz, X86::VPDPBSSDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBSSDSZ256rk, X86::VPDPBSSDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPBSSDSZ256rkz, X86::VPDPBSSDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBSSDSZrk, X86::VPDPBSSDSZmbk, TB_BCAST_D},
-  {X86::VPDPBSSDSZrkz, X86::VPDPBSSDSZmbkz, TB_BCAST_D},
-  {X86::VPDPBSSDZ128rk, X86::VPDPBSSDZ128mbk, TB_BCAST_D},
-  {X86::VPDPBSSDZ128rkz, X86::VPDPBSSDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBSSDZ256rk, X86::VPDPBSSDZ256mbk, TB_BCAST_D},
-  {X86::VPDPBSSDZ256rkz, X86::VPDPBSSDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBSSDZrk, X86::VPDPBSSDZmbk, TB_BCAST_D},
-  {X86::VPDPBSSDZrkz, X86::VPDPBSSDZmbkz, TB_BCAST_D},
-  {X86::VPDPBSUDSZ128rk, X86::VPDPBSUDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPBSUDSZ128rkz, X86::VPDPBSUDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBSUDSZ256rk, X86::VPDPBSUDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPBSUDSZ256rkz, X86::VPDPBSUDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBSUDSZrk, X86::VPDPBSUDSZmbk, TB_BCAST_D},
-  {X86::VPDPBSUDSZrkz, X86::VPDPBSUDSZmbkz, TB_BCAST_D},
-  {X86::VPDPBSUDZ128rk, X86::VPDPBSUDZ128mbk, TB_BCAST_D},
-  {X86::VPDPBSUDZ128rkz, X86::VPDPBSUDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBSUDZ256rk, X86::VPDPBSUDZ256mbk, TB_BCAST_D},
-  {X86::VPDPBSUDZ256rkz, X86::VPDPBSUDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBSUDZrk, X86::VPDPBSUDZmbk, TB_BCAST_D},
-  {X86::VPDPBSUDZrkz, X86::VPDPBSUDZmbkz, TB_BCAST_D},
-  {X86::VPDPBUSDSZ128rk, X86::VPDPBUSDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPBUSDSZ128rkz, X86::VPDPBUSDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBUSDSZ256rk, X86::VPDPBUSDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPBUSDSZ256rkz, X86::VPDPBUSDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBUSDSZrk, X86::VPDPBUSDSZmbk, TB_BCAST_D},
-  {X86::VPDPBUSDSZrkz, X86::VPDPBUSDSZmbkz, TB_BCAST_D},
-  {X86::VPDPBUSDZ128rk, X86::VPDPBUSDZ128mbk, TB_BCAST_D},
-  {X86::VPDPBUSDZ128rkz, X86::VPDPBUSDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBUSDZ256rk, X86::VPDPBUSDZ256mbk, TB_BCAST_D},
-  {X86::VPDPBUSDZ256rkz, X86::VPDPBUSDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBUSDZrk, X86::VPDPBUSDZmbk, TB_BCAST_D},
-  {X86::VPDPBUSDZrkz, X86::VPDPBUSDZmbkz, TB_BCAST_D},
-  {X86::VPDPBUUDSZ128rk, X86::VPDPBUUDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPBUUDSZ128rkz, X86::VPDPBUUDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBUUDSZ256rk, X86::VPDPBUUDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPBUUDSZ256rkz, X86::VPDPBUUDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBUUDSZrk, X86::VPDPBUUDSZmbk, TB_BCAST_D},
-  {X86::VPDPBUUDSZrkz, X86::VPDPBUUDSZmbkz, TB_BCAST_D},
-  {X86::VPDPBUUDZ128rk, X86::VPDPBUUDZ128mbk, TB_BCAST_D},
-  {X86::VPDPBUUDZ128rkz, X86::VPDPBUUDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPBUUDZ256rk, X86::VPDPBUUDZ256mbk, TB_BCAST_D},
-  {X86::VPDPBUUDZ256rkz, X86::VPDPBUUDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPBUUDZrk, X86::VPDPBUUDZmbk, TB_BCAST_D},
-  {X86::VPDPBUUDZrkz, X86::VPDPBUUDZmbkz, TB_BCAST_D},
-  {X86::VPDPWSSDSZ128rk, X86::VPDPWSSDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPWSSDSZ128rkz, X86::VPDPWSSDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWSSDSZ256rk, X86::VPDPWSSDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPWSSDSZ256rkz, X86::VPDPWSSDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWSSDSZrk, X86::VPDPWSSDSZmbk, TB_BCAST_D},
-  {X86::VPDPWSSDSZrkz, X86::VPDPWSSDSZmbkz, TB_BCAST_D},
-  {X86::VPDPWSSDZ128rk, X86::VPDPWSSDZ128mbk, TB_BCAST_D},
-  {X86::VPDPWSSDZ128rkz, X86::VPDPWSSDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWSSDZ256rk, X86::VPDPWSSDZ256mbk, TB_BCAST_D},
-  {X86::VPDPWSSDZ256rkz, X86::VPDPWSSDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWSSDZrk, X86::VPDPWSSDZmbk, TB_BCAST_D},
-  {X86::VPDPWSSDZrkz, X86::VPDPWSSDZmbkz, TB_BCAST_D},
-  {X86::VPDPWSUDSZ128rk, X86::VPDPWSUDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPWSUDSZ128rkz, X86::VPDPWSUDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWSUDSZ256rk, X86::VPDPWSUDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPWSUDSZ256rkz, X86::VPDPWSUDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWSUDSZrk, X86::VPDPWSUDSZmbk, TB_BCAST_D},
-  {X86::VPDPWSUDSZrkz, X86::VPDPWSUDSZmbkz, TB_BCAST_D},
-  {X86::VPDPWSUDZ128rk, X86::VPDPWSUDZ128mbk, TB_BCAST_D},
-  {X86::VPDPWSUDZ128rkz, X86::VPDPWSUDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWSUDZ256rk, X86::VPDPWSUDZ256mbk, TB_BCAST_D},
-  {X86::VPDPWSUDZ256rkz, X86::VPDPWSUDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWSUDZrk, X86::VPDPWSUDZmbk, TB_BCAST_D},
-  {X86::VPDPWSUDZrkz, X86::VPDPWSUDZmbkz, TB_BCAST_D},
-  {X86::VPDPWUSDSZ128rk, X86::VPDPWUSDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPWUSDSZ128rkz, X86::VPDPWUSDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWUSDSZ256rk, X86::VPDPWUSDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPWUSDSZ256rkz, X86::VPDPWUSDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWUSDSZrk, X86::VPDPWUSDSZmbk, TB_BCAST_D},
-  {X86::VPDPWUSDSZrkz, X86::VPDPWUSDSZmbkz, TB_BCAST_D},
-  {X86::VPDPWUSDZ128rk, X86::VPDPWUSDZ128mbk, TB_BCAST_D},
-  {X86::VPDPWUSDZ128rkz, X86::VPDPWUSDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWUSDZ256rk, X86::VPDPWUSDZ256mbk, TB_BCAST_D},
-  {X86::VPDPWUSDZ256rkz, X86::VPDPWUSDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWUSDZrk, X86::VPDPWUSDZmbk, TB_BCAST_D},
-  {X86::VPDPWUSDZrkz, X86::VPDPWUSDZmbkz, TB_BCAST_D},
-  {X86::VPDPWUUDSZ128rk, X86::VPDPWUUDSZ128mbk, TB_BCAST_D},
-  {X86::VPDPWUUDSZ128rkz, X86::VPDPWUUDSZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWUUDSZ256rk, X86::VPDPWUUDSZ256mbk, TB_BCAST_D},
-  {X86::VPDPWUUDSZ256rkz, X86::VPDPWUUDSZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWUUDSZrk, X86::VPDPWUUDSZmbk, TB_BCAST_D},
-  {X86::VPDPWUUDSZrkz, X86::VPDPWUUDSZmbkz, TB_BCAST_D},
-  {X86::VPDPWUUDZ128rk, X86::VPDPWUUDZ128mbk, TB_BCAST_D},
-  {X86::VPDPWUUDZ128rkz, X86::VPDPWUUDZ128mbkz, TB_BCAST_D},
-  {X86::VPDPWUUDZ256rk, X86::VPDPWUUDZ256mbk, TB_BCAST_D},
-  {X86::VPDPWUUDZ256rkz, X86::VPDPWUUDZ256mbkz, TB_BCAST_D},
-  {X86::VPDPWUUDZrk, X86::VPDPWUUDZmbk, TB_BCAST_D},
-  {X86::VPDPWUUDZrkz, X86::VPDPWUUDZmbkz, TB_BCAST_D},
+  {X86::VPDPBSSDSZ128rrk, X86::VPDPBSSDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBSSDSZ128rrkz, X86::VPDPBSSDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBSSDSZ256rrk, X86::VPDPBSSDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBSSDSZ256rrkz, X86::VPDPBSSDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBSSDSZrrk, X86::VPDPBSSDSZrmbk, TB_BCAST_D},
+  {X86::VPDPBSSDSZrrkz, X86::VPDPBSSDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPBSSDZ128rrk, X86::VPDPBSSDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBSSDZ128rrkz, X86::VPDPBSSDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBSSDZ256rrk, X86::VPDPBSSDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBSSDZ256rrkz, X86::VPDPBSSDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBSSDZrrk, X86::VPDPBSSDZrmbk, TB_BCAST_D},
+  {X86::VPDPBSSDZrrkz, X86::VPDPBSSDZrmbkz, TB_BCAST_D},
+  {X86::VPDPBSUDSZ128rrk, X86::VPDPBSUDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBSUDSZ128rrkz, X86::VPDPBSUDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBSUDSZ256rrk, X86::VPDPBSUDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBSUDSZ256rrkz, X86::VPDPBSUDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBSUDSZrrk, X86::VPDPBSUDSZrmbk, TB_BCAST_D},
+  {X86::VPDPBSUDSZrrkz, X86::VPDPBSUDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPBSUDZ128rrk, X86::VPDPBSUDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBSUDZ128rrkz, X86::VPDPBSUDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBSUDZ256rrk, X86::VPDPBSUDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBSUDZ256rrkz, X86::VPDPBSUDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBSUDZrrk, X86::VPDPBSUDZrmbk, TB_BCAST_D},
+  {X86::VPDPBSUDZrrkz, X86::VPDPBSUDZrmbkz, TB_BCAST_D},
+  {X86::VPDPBUSDSZ128rrk, X86::VPDPBUSDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBUSDSZ128rrkz, X86::VPDPBUSDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBUSDSZ256rrk, X86::VPDPBUSDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBUSDSZ256rrkz, X86::VPDPBUSDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBUSDSZrrk, X86::VPDPBUSDSZrmbk, TB_BCAST_D},
+  {X86::VPDPBUSDSZrrkz, X86::VPDPBUSDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPBUSDZ128rrk, X86::VPDPBUSDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBUSDZ128rrkz, X86::VPDPBUSDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBUSDZ256rrk, X86::VPDPBUSDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBUSDZ256rrkz, X86::VPDPBUSDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBUSDZrrk, X86::VPDPBUSDZrmbk, TB_BCAST_D},
+  {X86::VPDPBUSDZrrkz, X86::VPDPBUSDZrmbkz, TB_BCAST_D},
+  {X86::VPDPBUUDSZ128rrk, X86::VPDPBUUDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBUUDSZ128rrkz, X86::VPDPBUUDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBUUDSZ256rrk, X86::VPDPBUUDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBUUDSZ256rrkz, X86::VPDPBUUDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBUUDSZrrk, X86::VPDPBUUDSZrmbk, TB_BCAST_D},
+  {X86::VPDPBUUDSZrrkz, X86::VPDPBUUDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPBUUDZ128rrk, X86::VPDPBUUDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPBUUDZ128rrkz, X86::VPDPBUUDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPBUUDZ256rrk, X86::VPDPBUUDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPBUUDZ256rrkz, X86::VPDPBUUDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPBUUDZrrk, X86::VPDPBUUDZrmbk, TB_BCAST_D},
+  {X86::VPDPBUUDZrrkz, X86::VPDPBUUDZrmbkz, TB_BCAST_D},
+  {X86::VPDPWSSDSZ128rrk, X86::VPDPWSSDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWSSDSZ128rrkz, X86::VPDPWSSDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWSSDSZ256rrk, X86::VPDPWSSDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWSSDSZ256rrkz, X86::VPDPWSSDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWSSDSZrrk, X86::VPDPWSSDSZrmbk, TB_BCAST_D},
+  {X86::VPDPWSSDSZrrkz, X86::VPDPWSSDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPWSSDZ128rrk, X86::VPDPWSSDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWSSDZ128rrkz, X86::VPDPWSSDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWSSDZ256rrk, X86::VPDPWSSDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWSSDZ256rrkz, X86::VPDPWSSDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWSSDZrrk, X86::VPDPWSSDZrmbk, TB_BCAST_D},
+  {X86::VPDPWSSDZrrkz, X86::VPDPWSSDZrmbkz, TB_BCAST_D},
+  {X86::VPDPWSUDSZ128rrk, X86::VPDPWSUDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWSUDSZ128rrkz, X86::VPDPWSUDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWSUDSZ256rrk, X86::VPDPWSUDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWSUDSZ256rrkz, X86::VPDPWSUDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWSUDSZrrk, X86::VPDPWSUDSZrmbk, TB_BCAST_D},
+  {X86::VPDPWSUDSZrrkz, X86::VPDPWSUDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPWSUDZ128rrk, X86::VPDPWSUDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWSUDZ128rrkz, X86::VPDPWSUDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWSUDZ256rrk, X86::VPDPWSUDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWSUDZ256rrkz, X86::VPDPWSUDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWSUDZrrk, X86::VPDPWSUDZrmbk, TB_BCAST_D},
+  {X86::VPDPWSUDZrrkz, X86::VPDPWSUDZrmbkz, TB_BCAST_D},
+  {X86::VPDPWUSDSZ128rrk, X86::VPDPWUSDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWUSDSZ128rrkz, X86::VPDPWUSDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWUSDSZ256rrk, X86::VPDPWUSDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWUSDSZ256rrkz, X86::VPDPWUSDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWUSDSZrrk, X86::VPDPWUSDSZrmbk, TB_BCAST_D},
+  {X86::VPDPWUSDSZrrkz, X86::VPDPWUSDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPWUSDZ128rrk, X86::VPDPWUSDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWUSDZ128rrkz, X86::VPDPWUSDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWUSDZ256rrk, X86::VPDPWUSDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWUSDZ256rrkz, X86::VPDPWUSDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWUSDZrrk, X86::VPDPWUSDZrmbk, TB_BCAST_D},
+  {X86::VPDPWUSDZrrkz, X86::VPDPWUSDZrmbkz, TB_BCAST_D},
+  {X86::VPDPWUUDSZ128rrk, X86::VPDPWUUDSZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWUUDSZ128rrkz, X86::VPDPWUUDSZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWUUDSZ256rrk, X86::VPDPWUUDSZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWUUDSZ256rrkz, X86::VPDPWUUDSZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWUUDSZrrk, X86::VPDPWUUDSZrmbk, TB_BCAST_D},
+  {X86::VPDPWUUDSZrrkz, X86::VPDPWUUDSZrmbkz, TB_BCAST_D},
+  {X86::VPDPWUUDZ128rrk, X86::VPDPWUUDZ128rmbk, TB_BCAST_D},
+  {X86::VPDPWUUDZ128rrkz, X86::VPDPWUUDZ128rmbkz, TB_BCAST_D},
+  {X86::VPDPWUUDZ256rrk, X86::VPDPWUUDZ256rmbk, TB_BCAST_D},
+  {X86::VPDPWUUDZ256rrkz, X86::VPDPWUUDZ256rmbkz, TB_BCAST_D},
+  {X86::VPDPWUUDZrrk, X86::VPDPWUUDZrmbk, TB_BCAST_D},
+  {X86::VPDPWUUDZrrkz, X86::VPDPWUUDZrmbkz, TB_BCAST_D},
   {X86::VPERMDZ256rrk, X86::VPERMDZ256rmbk, TB_BCAST_D},
   {X86::VPERMDZrrk, X86::VPERMDZrmbk, TB_BCAST_D},
   {X86::VPERMI2DZ128rrk, X86::VPERMI2DZ128rmbk, TB_BCAST_D},
diff --git a/llvm/test/TableGen/x86-instr-mapping.inc b/llvm/test/TableGen/x86-instr-mapping.inc
index 1629e0eef93ec..5cf5417c0911d 100644
--- a/llvm/test/TableGen/x86-instr-mapping.inc
+++ b/llvm/test/TableGen/x86-instr-mapping.inc
@@ -952,70 +952,70 @@ static const X86TableEntry X86CompressEVEXTable[] = {
   { X86::VPCLMULQDQZ128rri, X86::VPCLMULQDQrri },
   { X86::VPCLMULQDQZ256rmi, X86::VPCLMULQDQYrmi },
   { X86::VPCLMULQDQZ256rri, X86::VPCLMULQDQYrri },
-  { X86::VPDPBSSDSZ128m, X86::VPDPBSSDSrm },
-  { X86::VPDPBSSDSZ128r, X86::VPDPBSSDSrr },
-  { X86::VPDPBSSDSZ256m, X86::VPDPBSSDSYrm },
-  { X86::VPDPBSSDSZ256r, X86::VPDPBSSDSYrr },
-  { X86::VPDPBSSDZ128m, X86::VPDPBSSDrm },
-  { X86::VPDPBSSDZ128r, X86::VPDPBSSDrr },
-  { X86::VPDPBSSDZ256m, X86::VPDPBSSDYrm },
-  { X86::VPDPBSSDZ256r, X86::VPDPBSSDYrr },
-  { X86::VPDPBSUDSZ128m, X86::VPDPBSUDSrm },
-  { X86::VPDPBSUDSZ128r, X86::VPDPBSUDSrr },
-  { X86::VPDPBSUDSZ256m, X86::VPDPBSUDSYrm },
-  { X86::VPDPBSUDSZ256r, X86::VPDPBSUDSYrr },
-  { X86::VPDPBSUDZ128m, X86::VPDPBSUDrm },
-  { X86::VPDPBSUDZ128r, X86::VPDPBSUDrr },
-  { X86::VPDPBSUDZ256m, X86::VPDPBSUDYrm },
-  { X86::VPDPBSUDZ256r, X86::VPDPBSUDYrr },
-  { X86::VPDPBUSDSZ128m, X86::VPDPBUSDSrm },
-  { X86::VPDPBUSDSZ128r, X86::VPDPBUSDSrr },
-  { X86::VPDPBUSDSZ256m, X86::VPDPBUSDSYrm },
-  { X86::VPDPBUSDSZ256r, X86::VPDPBUSDSYrr },
-  { X86::VPDPBUSDZ128m, X86::VPDPBUSDrm },
-  { X86::VPDPBUSDZ128r, X86::VPDPBUSDrr },
-  { X86::VPDPBUSDZ256m, X86::VPDPBUSDYrm },
-  { X86::VPDPBUSDZ256r, X86::VPDPBUSDYrr },
-  { X86::VPDPBUUDSZ128m, X86::VPDPBUUDSrm },
-  { X86::VPDPBUUDSZ128r, X86::VPDPBUUDSrr },
-  { X86::VPDPBUUDSZ256m, X86::VPDPBUUDSYrm },
-  { X86::VPDPBUUDSZ256r, X86::VPDPBUUDSYrr },
-  { X86::VPDPBUUDZ128m, X86::VPDPBUUDrm },
-  { X86::VPDPBUUDZ128r, X86::VPDPBUUDrr },
-  { X86::VPDPBUUDZ256m, X86::VPDPBUUDYrm },
-  { X86::VPDPBUUDZ256r, X86::VPDPBUUDYrr },
-  { X86::VPDPWSSDSZ128m, X86::VPDPWSSDSrm },
-  { X86::VPDPWSSDSZ128r, X86::VPDPWSSDSrr },
-  { X86::VPDPWSSDSZ256m, X86::VPDPWSSDSYrm },
-  { X86::VPDPWSSDSZ256r, X86::VPDPWSSDSYrr },
-  { X86::VPDPWSSDZ128m, X86::VPDPWSSDrm },
-  { X86::VPDPWSSDZ128r, X86::VPDPWSSDrr },
-  { X86::VPDPWSSDZ256m, X86::VPDPWSSDYrm },
-  { X86::VPDPWSSDZ256r, X86::VPDPWSSDYrr },
-  { X86::VPDPWSUDSZ128m, X86::VPDPWSUDSrm },
-  { X86::VPDPWSUDSZ128r, X86::VPDPWSUDSrr },
-  { X86::VPDPWSUDSZ256m, X86::VPDPWSUDSYrm },
-  { X86::VPDPWSUDSZ256r, X86::VPDPWSUDSYrr },
-  { X86::VPDPWSUDZ128m, X86::VPDPWSUDrm },
-  { X86::VPDPWSUDZ128r, X86::VPDPWSUDrr },
-  { X86::VPDPWSUDZ256m, X86::VPDPWSUDYrm },
-  { X86::VPDPWSUDZ256r, X86::VPDPWSUDYrr },
-  { X86::VPDPWUSDSZ128m, X86::VPDPWUSDSrm },
-  { X86::VPDPWUSDSZ128r, X86::VPDPWUSDSrr },
-  { X86::VPDPWUSDSZ256m, X86::VPDPWUSDSYrm },
-  { X86::VPDPWUSDSZ256r, X86::VPDPWUSDSYrr },
-  { X86::VPDPWUSDZ128m, X86::VPDPWUSDrm },
-  { X86::VPDPWUSDZ128r, X86::VPDPWUSDrr },
-  { X86::VPDPWUSDZ256m, X86::VPDPWUSDYrm },
-  { X86::VPDPWUSDZ256r, X86::VPDPWUSDYrr },
-  { X86::VPDPWUUDSZ128m, X86::VPDPWUUDSrm },
-  { X86::VPDPWUUDSZ128r, X86::VPDPWUUDSrr },
-  { X86::VPDPWUUDSZ256m, X86::VPDPWUUDSYrm },
-  { X86::VPDPWUUDSZ256r, X86::VPDPWUUDSYrr },
-  { X86::VPDPWUUDZ128m, X86::VPDPWUUDrm },
-  { X86::VPDPWUUDZ128r, X86::VPDPWUUDrr },
-  { X86::VPDPWUUDZ256m, X86::VPDPWUUDYrm },
-  { X86::VPDPWUUDZ256r, X86::VPDPWUUDYrr },
+  { X86::VPDPBSSDSZ128rm, X86::VPDPBSSDSrm },
+  { X86::VPDPBSSDSZ128rr, X86::VPDPBSSDSrr },
+  { X86::VPDPBSSDSZ256rm, X86::VPDPBSSDSYrm },
+  { X86::VPDPBSSDSZ256rr, X86::VPDPBSSDSYrr },
+  { X86::VPDPBSSDZ128rm, X86::VPDPBSSDrm },
+  { X86::VPDPBSSDZ128rr, X86::VPDPBSSDrr },
+  { X86::VPDPBSSDZ256rm, X86::VPDPBSSDYrm },
+  { X86::VPDPBSSDZ256rr, X86::VPDPBSSDYrr },
+  { X86::VPDPBSUDSZ128rm, X86::VPDPBSUDSrm },
+  { X86::VPDPBSUDSZ128rr, X86::VPDPBSUDSrr },
+  { X86::VPDPBSUDSZ256rm, X86::VPDPBSUDSYrm },
+  { X86::VPDPBSUDSZ256rr, X86::VPDPBSUDSYrr },
+  { X86::VPDPBSUDZ128rm, X86::VPDPBSUDrm },
+  { X86::VPDPBSUDZ128rr, X86::VPDPBSUDrr },
+  { X86::VPDPBSUDZ256rm, X86::VPDPBSUDYrm },
+  { X86::VPDPBSUDZ256rr, X86::VPDPBSUDYrr },
+  { X86::VPDPBUSDSZ128rm, X86::VPDPBUSDSrm },
+  { X86::VPDPBUSDSZ128rr, X86::VPDPBUSDSrr },
+  { X86::VPDPBUSDSZ256rm, X86::VPDPBUSDSYrm },
+  { X86::VPDPBUSDSZ256rr, X86::VPDPBUSDSYrr },
+  { X86::VPDPBUSDZ128rm, X86::VPDPBUSDrm },
+  { X86::VPDPBUSDZ128rr, X86::VPDPBUSDrr },
+  { X86::VPDPBUSDZ256rm, X86::VPDPBUSDYrm },
+  { X86::VPDPBUSDZ256rr, X86::VPDPBUSDYrr },
+  { X86::VPDPBUUDSZ128rm, X86::VPDPBUUDSrm },
+  { X86::VPDPBUUDSZ128rr, X86::VPDPBUUDSrr },
+  { X86::VPDPBUUDSZ256rm, X86::VPDPBUUDSYrm },
+  { X86::VPDPBUUDSZ256rr, X86::VPDPBUUDSYrr },
+  { X86::VPDPBUUDZ128rm, X86::VPDPBUUDrm },
+  { X86::VPDPBUUDZ128rr, X86::VPDPBUUDrr },
+  { X86::VPDPBUUDZ256rm, X86::VPDPBUUDYrm },
+  { X86::VPDPBUUDZ256rr, X86::VPDPBUUDYrr },
+  { X86::VPDPWSSDSZ128rm, X86::VPDPWSSDSrm },
+  { X86::VPDPWSSDSZ128rr, X86::VPDPWSSDSrr },
+  { X86::VPDPWSSDSZ256rm, X86::VPDPWSSDSYrm },
+  { X86::VPDPWSSDSZ256rr, X86::VPDPWSSDSYrr },
+  { X86::VPDPWSSDZ128rm, X86::VPDPWSSDrm },
+  { X86::VPDPWSSDZ128rr, X86::VPDPWSSDrr },
+  { X86::VPDPWSSDZ256rm, X86::VPDPWSSDYrm },
+  { X86::VPDPWSSDZ256rr, X86::VPDPWSSDYrr },
+  { X86::VPDPWSUDSZ128rm, X86::VPDPWSUDSrm },
+  { X86::VPDPWSUDSZ128rr, X86::VPDPWSUDSrr },
+  { X86::VPDPWSUDSZ256rm, X86::VPDPWSUDSYrm },
+  { X86::VPDPWSUDSZ256rr, X86::VPDPWSUDSYrr },
+  { X86::VPDPWSUDZ128rm, X86::VPDPWSUDrm },
+  { X86::VPDPWSUDZ128rr, X86::VPDPWSUDrr },
+  { X86::VPDPWSUDZ256rm, X86::VPDPWSUDYrm },
+  { X86::VPDPWSUDZ256rr, X86::VPDPWSUDYrr },
+  { X86::VPDPWUSDSZ128rm, X86::VPDPWUSDSrm },
+  { X86::VPDPWUSDSZ128rr, X86::VPDPWUSDSrr },
+  { X86::VPDPWUSDSZ256rm, X86::VPDPWUSDSYrm },
+  { X86::VPDPWUSDSZ256rr, X86::VPDPWUSDSYrr },
+  { X86::VPDPWUSDZ128rm, X86::VPDPWUSDrm },
+  { X86::VPDPWUSDZ128rr, X86::VPDPWUSDrr },
+  { X86::VPDPWUSDZ256rm, X86::VPDPWUSDYrm },
+  { X86::VPDPWUSDZ256rr, X86::VPDPWUSDYrr },
+  { X86::VPDPWUUDSZ128rm, X86::VPDPWUUDSrm },
+  { X86::VPDPWUUDSZ128rr, X86::VPDPWUUDSrr },
+  { X86::VPDPWUUDSZ256rm, X86::VPDPWUUDSYrm },
+  { X86::VPDPWUUDSZ256rr, X86::VPDPWUUDSYrr },
+  { X86::VPDPWUUDZ128rm, X86::VPDPWUUDrm },
+  { X86::VPDPWUUDZ128rr, X86::VPDPWUUDrr },
+  { X86::VPDPWUUDZ256rm, X86::VPDPWUUDYrm },
+  { X86::VPDPWUUDZ256rr, X86::VPDPWUUDYrr },
   { X86::VPERMDZ256rm, X86::VPERMDYrm },
   { X86::VPERMDZ256rr, X86::VPERMDYrr },
   { X86::VPERMILPDZ128mi, X86::VPERMILPDmi },
From fe000855c6d416e2e6a1bca94216874d1f5082fa Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:46:24 -0500
Subject: [PATCH 01/20] fix documentation reference

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index cc300548a50e6..384c7fc591490 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -15,7 +15,7 @@
 //===----------------------------------------------------------------------===//
 
 def Znver4Model : SchedMachineModel {
-  // AMD SOG Zen4, 2.9.6 Dispatch
+  // AMD SOG Zen4, 2.9.8 Dispatch
   // The processor may dispatch up to 6 macro ops per cycle
   // into the execution engine.
   let IssueWidth = 6;

From 092492a2ae49c392c122b076eaa913cddc4ae0f5 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:46:39 -0500
Subject: [PATCH 02/20] better HighLatency value

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 384c7fc591490..2a8e614d62512 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -46,8 +46,9 @@ def Znver4Model : SchedMachineModel {
   int VecLoadLatency = 7;
   // Latency of a simple store operation.
   int StoreLatency = 1;
-  // FIXME:
-  let HighLatency = 25; // FIXME: any better choice?
+  // Mean and median value for all instructions with latencies >6
+  // Source: Zen4 Instruction Latencies spreadsheet (included with SOG)
+  let HighLatency = 13;
   // AMD SOG Zen4, 2.8 Optimizing Branching
   // The branch misprediction penalty is in the range from 11 to 18 cycles,
   // <...>. The common case penalty is 13 cycles.

From bc45c699cd87b6fcfc040d99001caf580dc593ef Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:47:08 -0500
Subject: [PATCH 03/20] LEA metrics

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 2a8e614d62512..55a4c4a1388b7 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -586,10 +586,11 @@ def : InstRW<[Zn4WriteADC8mr_SBB8mr], (instrs ADC8mr, SBB8mr)>;
 defm : Zn4WriteResInt<WriteLEA, [Zn4AGU012], 1, [1], 1>;     // LEA instructions can't fold loads.
 
 // This write is used for slow LEA instructions.
+// values from uops.info
 def Zn4Write3OpsLEA : SchedWriteRes<[Zn4ALU0123]> {
-  let Latency = 2;
-  let ReleaseAtCycles = [1];
-  let NumMicroOps = 2;
+  let Latency = 3;
+  let ReleaseAtCycles = [1, 1, 1, 2];
+  let NumMicroOps = 4;
 }
 
 // On Znver4, a slow LEA is either a 3Ops LEA (base, index, offset),
@@ -613,9 +614,10 @@ def Zn4WriteLEA : SchedWriteVariant<[
 
 def : InstRW<[Zn4WriteLEA], (instrs LEA32r, LEA64r, LEA64_32r)>;
 
+// values from uops.info
 def Zn4SlowLEA16r : SchedWriteRes<[Zn4ALU0123]> {
-  let Latency = 2; // FIXME: not from llvm-exegesis
-  let ReleaseAtCycles = [4];
+  let Latency = 2;
+  let ReleaseAtCycles = [1, 1];
   let NumMicroOps = 2;
 }
 

From fd6f87f72413c97895846c9fa015dbbfa58a44c0 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:47:33 -0500
Subject: [PATCH 04/20] (CMP)XCHG uops

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 55a4c4a1388b7..8fec28cb34118 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -663,14 +663,14 @@ def : InstRW<[Zn4WriteCMPXCHG8rm_LCMPXCHG8], (instrs CMPXCHG8rm, LCMPXCHG8)>;
 def Zn4WriteCMPXCHG8B : SchedWriteRes<[Zn4ALU0123]> {
   let Latency = 3; // FIXME: not from llvm-exegesis
   let ReleaseAtCycles = [24];
-  let NumMicroOps = 19;
+  let NumMicroOps = 15;
 }
 def : InstRW<[Zn4WriteCMPXCHG8B], (instrs CMPXCHG8B)>;
 
 def Zn4WriteCMPXCHG16B_LCMPXCHG16B : SchedWriteRes<[Zn4ALU0123]> {
   let Latency = 4; // FIXME: not from llvm-exegesis
   let ReleaseAtCycles = [59];
-  let NumMicroOps = 28;
+  let NumMicroOps = 26;
 }
 def : InstRW<[Zn4WriteCMPXCHG16B_LCMPXCHG16B], (instrs CMPXCHG16B, LCMPXCHG16B)>;
 
@@ -684,7 +684,7 @@ def : InstRW<[Zn4WriteWriteXCHGUnrenameable], (instrs XCHG8rr, XCHG16rr, XCHG16a
 def Zn4WriteXCHG8rm_XCHG16rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4ALU0123]> {
   let Latency = !add(Znver4Model.LoadLatency, 3); // FIXME: not from llvm-exegesis
   let ReleaseAtCycles = [1, 1, 2];
-  let NumMicroOps = 5;
+  let NumMicroOps = 2;
 }
 def : InstRW<[Zn4WriteXCHG8rm_XCHG16rm], (instrs XCHG8rm, XCHG16rm)>;
 

From a67c2522f3d25c572d122687dbc476dad80a0193 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:47:53 -0500
Subject: [PATCH 05/20] (I)DIV values from docs/uops.info

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 18 ++++++++----------
 1 file changed, 8 insertions(+), 10 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 8fec28cb34118..3352a9beb516a 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -696,16 +696,14 @@ def Zn4WriteXCHG32rm_XCHG64rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4ALU0123]>
 def : InstRW<[Zn4WriteXCHG32rm_XCHG64rm], (instrs XCHG32rm, XCHG64rm)>;
 
 // Integer division.
-// FIXME: uops for 8-bit division measures as 2. for others it's a guess.
-// FIXME: latency for 8-bit division measures as 10. for others it's a guess.
-defm : Zn4WriteResIntPair<WriteDiv8, [Zn4Divider], 10, [10], 2>;
-defm : Zn4WriteResIntPair<WriteDiv16, [Zn4Divider], 11, [11], 2>;
-defm : Zn4WriteResIntPair<WriteDiv32, [Zn4Divider], 13, [13], 2>;
-defm : Zn4WriteResIntPair<WriteDiv64, [Zn4Divider], 17, [17], 2>;
-defm : Zn4WriteResIntPair<WriteIDiv8, [Zn4Divider], 10, [10], 2>;
-defm : Zn4WriteResIntPair<WriteIDiv16, [Zn4Divider], 11, [11], 2>;
-defm : Zn4WriteResIntPair<WriteIDiv32, [Zn4Divider], 13, [13], 2>;
-defm : Zn4WriteResIntPair<WriteIDiv64, [Zn4Divider], 17, [17], 2>;
+defm : Zn4WriteResIntPair<WriteDiv8, [Zn4Divider], 9, [9], 2>;
+defm : Zn4WriteResIntPair<WriteDiv16, [Zn4Divider], 10, [10], 2>;
+defm : Zn4WriteResIntPair<WriteDiv32, [Zn4Divider], 12, [12], 2>;
+defm : Zn4WriteResIntPair<WriteDiv64, [Zn4Divider], 18, [18], 2>;
+defm : Zn4WriteResIntPair<WriteIDiv8, [Zn4Divider], 9, [9], 2>;
+defm : Zn4WriteResIntPair<WriteIDiv16, [Zn4Divider], 10, [10], 2>;
+defm : Zn4WriteResIntPair<WriteIDiv32, [Zn4Divider], 12, [12], 2>;
+defm : Zn4WriteResIntPair<WriteIDiv64, [Zn4Divider], 18, [18], 2>;
 
 defm : Zn4WriteResIntPair<WriteBSF, [Zn4ALU1], 1, [1], 6, /*LoadUOps=*/1>; // Bit scan forward.
 defm : Zn4WriteResIntPair<WriteBSR, [Zn4ALU1], 1, [1], 6, /*LoadUOps=*/1>; // Bit scan reverse.

From cc5fc0dc2e153e42db16a858d3b7775db38df674 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:48:13 -0500
Subject: [PATCH 06/20] use zen4 BSF/BSR uops count

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 3352a9beb516a..9aa31b31a992c 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -705,8 +705,8 @@ defm : Zn4WriteResIntPair<WriteIDiv16, [Zn4Divider], 10, [10], 2>;
 defm : Zn4WriteResIntPair<WriteIDiv32, [Zn4Divider], 12, [12], 2>;
 defm : Zn4WriteResIntPair<WriteIDiv64, [Zn4Divider], 18, [18], 2>;
 
-defm : Zn4WriteResIntPair<WriteBSF, [Zn4ALU1], 1, [1], 6, /*LoadUOps=*/1>; // Bit scan forward.
-defm : Zn4WriteResIntPair<WriteBSR, [Zn4ALU1], 1, [1], 6, /*LoadUOps=*/1>; // Bit scan reverse.
+defm : Zn4WriteResIntPair<WriteBSF, [Zn4ALU1], 1, [1], 1, /*LoadUOps=*/1>; // Bit scan forward.
+defm : Zn4WriteResIntPair<WriteBSR, [Zn4ALU1], 1, [1], 1, /*LoadUOps=*/1>; // Bit scan reverse.
 
 defm : Zn4WriteResIntPair<WritePOPCNT, [Zn4ALU0123], 1, [1], 1>; // Bit population count.
 

From 3555807bcc1b8966968f1412341bfbee0f7322b9 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:49:10 -0500
Subject: [PATCH 07/20] TZCNT in 1 uop

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 9aa31b31a992c..fc454eb5ddee0 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -726,12 +726,12 @@ def Zn4WriteLZCNT16rr : SchedWriteRes<[Zn4ALU0123]> {
 }
 def : InstRW<[Zn4WriteLZCNT16rr], (instrs LZCNT16rr)>;
 
-defm : Zn4WriteResIntPair<WriteTZCNT, [Zn4ALU12], 2, [1], 2>; // Trailing zero count.
+defm : Zn4WriteResIntPair<WriteTZCNT, [Zn4ALU12], 1, [1], 1>; // Trailing zero count.
 
 def Zn4WriteTZCNT16rr : SchedWriteRes<[Zn4ALU0123]> {
-  let Latency = 2;
-  let ReleaseAtCycles = [4];
-  let NumMicroOps = 2;
+  let Latency = 1;
+  let ReleaseAtCycles = [1];
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteTZCNT16rr], (instrs TZCNT16rr)>;
 

From 48d84d299357444d890d27795d81f1540124b42e Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:49:52 -0500
Subject: [PATCH 08/20] some higher latency string instructions

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index fc454eb5ddee0..86793f4de1dd0 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1327,9 +1327,9 @@ def : InstRW<[Zn4WriteSHA256RNDS2rr], (instrs SHA256RNDS2rr)>;
 
 // Strings instructions.
 // Packed Compare Implicit Length Strings, Return Mask
-defm : Zn4WriteResXMMPair<WritePCmpIStrM, [Zn4FPVAdd0123], 6, [8], 3, /*LoadUOps=*/1>;
+defm : Zn4WriteResXMMPair<WritePCmpIStrM, [Zn4FPVAdd0123], 7, [8], 3, /*LoadUOps=*/1>;
 // Packed Compare Explicit Length Strings, Return Mask
-defm : Zn4WriteResXMMPair<WritePCmpEStrM, [Zn4FPVAdd0123], 6, [12], 7, /*LoadUOps=*/5>;
+defm : Zn4WriteResXMMPair<WritePCmpEStrM, [Zn4FPVAdd0123], 7, [12], 7, /*LoadUOps=*/5>;
 // Packed Compare Implicit Length Strings, Return Index
 defm : Zn4WriteResXMMPair<WritePCmpIStrI, [Zn4FPVAdd0123], 2, [8], 4>;
 // Packed Compare Explicit Length Strings, Return Index

From 8d345ddfec6ae30a9bd006503c8fbc0ba93ee54e Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 11:55:18 -0500
Subject: [PATCH 09/20] use Zen4 CLMUL/VPERM(S/D) values

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 86793f4de1dd0..405c0a2e9fbd1 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1341,7 +1341,7 @@ defm : Zn4WriteResXMMPair<WriteAESIMC, [Zn4FPAES01], 4, [1], 1>; // InvMixColumn
 defm : Zn4WriteResXMMPair<WriteAESKeyGen, [Zn4FPAES01], 4, [1], 1>; // Key Generation.
 
 // Carry-less multiplication instructions.
-defm : Zn4WriteResXMMPair<WriteCLMul, [Zn4FPCLM01], 4, [4], 4>;
+defm : Zn4WriteResXMMPair<WriteCLMul, [Zn4FPCLM01], 4, [3], 4>;
 
 // EMMS/FEMMS
 defm : Zn4WriteResInt<WriteEMMS, [Zn4ALU0123], 2, [1], 1>; // FIXME: latency not from llvm-exegesis
@@ -1387,23 +1387,23 @@ def Zn4WriteVPERM2F128rm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
 def : InstRW<[Zn4WriteVPERM2F128rm], (instrs VPERM2F128rmi)>;
 
 def Zn4WriteVPERMPSYrr : SchedWriteRes<[Zn4FPVShuf]> {
-  let Latency = 7;
+  let Latency = 4;
   let ReleaseAtCycles = [1];
-  let NumMicroOps = 2;
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMPSYrr], (instrs VPERMPSYrr)>;
 
 def Zn4WriteVPERMPSYrm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
   let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMPSYrr.Latency);
-  let ReleaseAtCycles = [1, 1, 2];
-  let NumMicroOps = !add(Zn4WriteVPERMPSYrr.NumMicroOps, 1);
+  let ReleaseAtCycles = [1];
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMPSYrm], (instrs VPERMPSYrm)>;
 
 def Zn4WriteVPERMYri : SchedWriteRes<[Zn4FPVShuf]> {
-  let Latency = 6;
+  let Latency = 4;
   let ReleaseAtCycles = [1];
-  let NumMicroOps = 2;
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMYri], (instrs VPERMPDYri, VPERMQYri)>;
 
@@ -1415,9 +1415,9 @@ def Zn4WriteVPERMPDYmi : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
 def : InstRW<[Zn4WriteVPERMPDYmi], (instrs VPERMPDYmi)>;
 
 def Zn4WriteVPERMDYrr : SchedWriteRes<[Zn4FPVShuf]> {
-  let Latency = 5;
+  let Latency = 4;
   let ReleaseAtCycles = [1];
-  let NumMicroOps = 2;
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMDYrr], (instrs VPERMDYrr)>;
 

From d1bf965cfd2ab0ac7fb4c678a5d538c08abf0185 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 12:03:31 -0500
Subject: [PATCH 10/20] replace FIXME for latency

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 405c0a2e9fbd1..421c6eb6bf0b9 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -616,7 +616,7 @@ def : InstRW<[Zn4WriteLEA], (instrs LEA32r, LEA64r, LEA64_32r)>;
 
 // values from uops.info
 def Zn4SlowLEA16r : SchedWriteRes<[Zn4ALU0123]> {
-  let Latency = 2;
+  let Latency = 2; // FIXME: not from llvm-exegesis
   let ReleaseAtCycles = [1, 1];
   let NumMicroOps = 2;
 }

From de77a33cf2f78c6d1f8e18a30e120fa56f04c076 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 14:22:16 -0500
Subject: [PATCH 11/20] revert multiop ReleaseAtCycles value

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 421c6eb6bf0b9..9d6b57d51808a 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -617,7 +617,7 @@ def : InstRW<[Zn4WriteLEA], (instrs LEA32r, LEA64r, LEA64_32r)>;
 // values from uops.info
 def Zn4SlowLEA16r : SchedWriteRes<[Zn4ALU0123]> {
   let Latency = 2; // FIXME: not from llvm-exegesis
-  let ReleaseAtCycles = [1, 1];
+  let ReleaseAtCycles = [4];
   let NumMicroOps = 2;
 }
 

From de0daad87f44107bd37d6bfca0dc07c66da61f71 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 14:40:19 -0500
Subject: [PATCH 12/20] fix RAC for Zn4WriteVPERMPSYrm

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 9d6b57d51808a..1346ac8bfad91 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1395,7 +1395,7 @@ def : InstRW<[Zn4WriteVPERMPSYrr], (instrs VPERMPSYrr)>;
 
 def Zn4WriteVPERMPSYrm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
   let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMPSYrr.Latency);
-  let ReleaseAtCycles = [1];
+  let ReleaseAtCycles = [1, 1, 1];
   let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMPSYrm], (instrs VPERMPSYrm)>;

From a6621ca591882056694cfcf98e981d351f1a181a Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Tue, 30 Sep 2025 14:41:04 -0500
Subject: [PATCH 13/20] fix RAC for Zn4Write3OpsLEA

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 1346ac8bfad91..9e3939b60408f 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -589,7 +589,7 @@ defm : Zn4WriteResInt<WriteLEA, [Zn4AGU012], 1, [1], 1>;     // LEA instructions
 // values from uops.info
 def Zn4Write3OpsLEA : SchedWriteRes<[Zn4ALU0123]> {
   let Latency = 3;
-  let ReleaseAtCycles = [1, 1, 1, 2];
+  let ReleaseAtCycles = [1];
   let NumMicroOps = 4;
 }
 

From 603d9b8998310cb051183e4599d34f4e18b5ff7a Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 12:13:48 -0500
Subject: [PATCH 14/20] regenerate resource files

---
 .../llvm-mca/X86/Znver4/resources-avx1.s      | 18 ++--
 .../llvm-mca/X86/Znver4/resources-avx2.s      | 20 ++--
 .../X86/Znver4/resources-avx512vpclmulqdq.s   | 10 +-
 .../X86/Znver4/resources-avx512vpclmulqdqvl.s | 18 ++--
 .../llvm-mca/X86/Znver4/resources-bmi1.s      | 16 +--
 .../llvm-mca/X86/Znver4/resources-cmpxchg.s   |  8 +-
 .../tools/llvm-mca/X86/Znver4/resources-lea.s | 80 +++++++--------
 .../llvm-mca/X86/Znver4/resources-pclmul.s    | 10 +-
 .../llvm-mca/X86/Znver4/resources-sse42.s     |  8 +-
 .../X86/Znver4/resources-vpclmulqdq.s         | 10 +-
 .../llvm-mca/X86/Znver4/resources-x86_64.s    | 98 +++++++++----------
 11 files changed, 148 insertions(+), 148 deletions(-)

diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
index 1ffe53366fdb0..d1df30497325b 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx1.s
@@ -1403,8 +1403,8 @@ vzeroupper
 # CHECK-NEXT:  1      8     0.50    *                   vpblendvb	%xmm3, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpblendw	$11, %xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpblendw	$11, (%rax), %xmm1, %xmm2
-# CHECK-NEXT:  4      4     2.00                        vpclmulqdq	$11, %xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  4      11    2.00    *                   vpclmulqdq	$11, (%rax), %xmm1, %xmm2
+# CHECK-NEXT:  4      4     1.50                        vpclmulqdq	$11, %xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  4      11    1.50    *                   vpclmulqdq	$11, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpcmpeqb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpcmpeqb	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpcmpeqd	%xmm0, %xmm1, %xmm2
@@ -1415,8 +1415,8 @@ vzeroupper
 # CHECK-NEXT:  1      8     0.50    *                   vpcmpeqw	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  8      6     3.00                        vpcmpestri	$1, %xmm0, %xmm2
 # CHECK-NEXT:  12     13    3.00    *                   vpcmpestri	$1, (%rax), %xmm2
-# CHECK-NEXT:  7      6     3.00                        vpcmpestrm	$1, %xmm0, %xmm2
-# CHECK-NEXT:  12     13    3.00    *                   vpcmpestrm	$1, (%rax), %xmm2
+# CHECK-NEXT:  7      7     3.00                        vpcmpestrm	$1, %xmm0, %xmm2
+# CHECK-NEXT:  12     14    3.00    *                   vpcmpestrm	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpcmpgtb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   vpcmpgtb	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  1      1     0.25                        vpcmpgtd	%xmm0, %xmm1, %xmm2
@@ -1427,8 +1427,8 @@ vzeroupper
 # CHECK-NEXT:  1      8     0.50    *                   vpcmpgtw	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  4      2     2.00                        vpcmpistri	$1, %xmm0, %xmm2
 # CHECK-NEXT:  4      9     2.00    *                   vpcmpistri	$1, (%rax), %xmm2
-# CHECK-NEXT:  3      6     2.00                        vpcmpistrm	$1, %xmm0, %xmm2
-# CHECK-NEXT:  4      13    2.00    *                   vpcmpistrm	$1, (%rax), %xmm2
+# CHECK-NEXT:  3      7     2.00                        vpcmpistrm	$1, %xmm0, %xmm2
+# CHECK-NEXT:  4      14    2.00    *                   vpcmpistrm	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      3     1.00                        vperm2f128	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      10    1.00    *                   vperm2f128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      1     0.50                        vpermilpd	$1, %xmm0, %xmm2
@@ -1749,7 +1749,7 @@ vzeroupper
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 1.33   1.33   1.33   16.50  16.50  16.50  16.50   -     205.25 393.58 268.08 158.08 208.50 208.50 65.00  119.67 119.67 119.67 107.00 107.00 107.00 19.00  19.00
+# CHECK-NEXT: 1.33   1.33   1.33   16.50  16.50  16.50  16.50   -     204.25 392.58 268.08 158.08 208.50 208.50 65.00  119.67 119.67 119.67 107.00 107.00 107.00 19.00  19.00
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -2126,8 +2126,8 @@ vzeroupper
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.50    -      -     0.50   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpblendvb	%xmm3, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpblendw	$11, %xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpblendw	$11, (%rax), %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %xmm0, %xmm1, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %xmm0, %xmm1, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpcmpeqb	%xmm0, %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25   0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpcmpeqb	(%rax), %xmm1, %xmm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -     vpcmpeqd	%xmm0, %xmm1, %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
index 6dc5bacde9059..2851632869865 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
@@ -560,14 +560,14 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      8     0.50    *                   vpcmpgtw	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      3     1.00                        vperm2i128	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     1.00    *                   vperm2i128	$1, (%rax), %ymm1, %ymm2
-# CHECK-NEXT:  2      5     1.00                        vpermd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  2      12    2.00    *                   vpermd	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  2      6     1.00                        vpermpd	$1, %ymm0, %ymm2
-# CHECK-NEXT:  3      13    2.00    *                   vpermpd	$1, (%rax), %ymm2
-# CHECK-NEXT:  2      7     1.00                        vpermps	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  3      14    2.00    *                   vpermps	(%rax), %ymm1, %ymm2
-# CHECK-NEXT:  2      6     1.00                        vpermq	$1, %ymm0, %ymm2
-# CHECK-NEXT:  2      12    2.00    *                   vpermq	$1, (%rax), %ymm2
+# CHECK-NEXT:  1      4     1.00                        vpermd	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      11    2.00    *                   vpermd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     1.00                        vpermpd	$1, %ymm0, %ymm2
+# CHECK-NEXT:  2      11    2.00    *                   vpermpd	$1, (%rax), %ymm2
+# CHECK-NEXT:  1      4     1.00                        vpermps	%ymm0, %ymm1, %ymm2
+# CHECK-NEXT:  1      11    1.00    *                   vpermps	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      4     1.00                        vpermq	$1, %ymm0, %ymm2
+# CHECK-NEXT:  1      11    2.00    *                   vpermq	$1, (%rax), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%ymm0, (%rax,%ymm1,2), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdq	%xmm0, (%rax,%xmm1,2), %xmm2
@@ -789,7 +789,7 @@ vpxor           (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 6.67   6.67   6.67    -      -      -      -      -     93.75  132.75 92.25  36.25  80.50  80.50  29.00  52.33  52.33  52.33  50.67  50.67  50.67  2.50   2.50
+# CHECK-NEXT: 6.67   6.67   6.67    -      -      -      -      -     93.75  131.75 92.25  36.25  80.50  80.50  29.00  52.33  52.33  52.33  50.67  50.67  50.67  2.50   2.50
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -898,7 +898,7 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermpd	$1, %ymm0, %ymm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     2.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermpd	$1, (%rax), %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermps	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     2.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermps	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     1.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermq	$1, %ymm0, %ymm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     2.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermq	$1, (%rax), %ymm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpgatherdd	%xmm0, (%rax,%xmm1,2), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdq.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdq.s
index 87ba0607e71d1..d1f2a980ee444 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdq.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdq.s
@@ -13,8 +13,8 @@ vpclmulqdq    $11, (%rax), %zmm17, %zmm19
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  4      4     2.00                        vpclmulqdq	$11, %zmm16, %zmm17, %zmm19
-# CHECK-NEXT:  4      11    2.00    *                   vpclmulqdq	$11, (%rax), %zmm17, %zmm19
+# CHECK-NEXT:  4      4     1.50                        vpclmulqdq	$11, %zmm16, %zmm17, %zmm19
+# CHECK-NEXT:  4      11    1.50    *                   vpclmulqdq	$11, (%rax), %zmm17, %zmm19
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -43,9 +43,9 @@ vpclmulqdq    $11, (%rax), %zmm17, %zmm19
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     4.00   4.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     3.00   3.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %zmm16, %zmm17, %zmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %zmm17, %zmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %zmm16, %zmm17, %zmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %zmm17, %zmm19
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdqvl.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdqvl.s
index 3c80c567227c5..ea7a28027a782 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdqvl.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vpclmulqdqvl.s
@@ -16,10 +16,10 @@ vpclmulqdq    $11, (%rax), %ymm17, %ymm19
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  4      4     2.00                        vpclmulqdq	$11, %xmm16, %xmm17, %xmm19
-# CHECK-NEXT:  4      11    2.00    *                   vpclmulqdq	$11, (%rax), %xmm17, %xmm19
-# CHECK-NEXT:  4      4     2.00                        vpclmulqdq	$11, %ymm16, %ymm17, %ymm19
-# CHECK-NEXT:  4      11    2.00    *                   vpclmulqdq	$11, (%rax), %ymm17, %ymm19
+# CHECK-NEXT:  4      4     1.50                        vpclmulqdq	$11, %xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  4      11    1.50    *                   vpclmulqdq	$11, (%rax), %xmm17, %xmm19
+# CHECK-NEXT:  4      4     1.50                        vpclmulqdq	$11, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  4      11    1.50    *                   vpclmulqdq	$11, (%rax), %ymm17, %ymm19
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -48,11 +48,11 @@ vpclmulqdq    $11, (%rax), %ymm17, %ymm19
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     8.00   8.00    -      -     1.00   1.00    -     0.67   0.67   0.67   0.67   0.67   0.67    -      -
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     6.00   6.00    -      -     1.00   1.00    -     0.67   0.67   0.67   0.67   0.67   0.67    -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %xmm16, %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %xmm17, %xmm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %ymm16, %ymm17, %ymm19
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %xmm17, %xmm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %ymm17, %ymm19
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-bmi1.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-bmi1.s
index f4888cf81523f..afbd566751c95 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-bmi1.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-bmi1.s
@@ -69,12 +69,12 @@ tzcnt       (%rax), %rcx
 # CHECK-NEXT:  2      5     0.33    *                   blsrl	(%rax), %ecx
 # CHECK-NEXT:  1      1     0.25                        blsrq	%rax, %rcx
 # CHECK-NEXT:  2      5     0.33    *                   blsrq	(%rax), %rcx
-# CHECK-NEXT:  2      2     1.00                        tzcntw	%ax, %cx
-# CHECK-NEXT:  2      6     0.50    *                   tzcntw	(%rax), %cx
-# CHECK-NEXT:  2      2     0.50                        tzcntl	%eax, %ecx
-# CHECK-NEXT:  2      6     0.50    *                   tzcntl	(%rax), %ecx
-# CHECK-NEXT:  2      2     0.50                        tzcntq	%rax, %rcx
-# CHECK-NEXT:  2      6     0.50    *                   tzcntq	(%rax), %rcx
+# CHECK-NEXT:  1      1     0.25                        tzcntw	%ax, %cx
+# CHECK-NEXT:  1      5     0.50    *                   tzcntw	(%rax), %cx
+# CHECK-NEXT:  1      1     0.50                        tzcntl	%eax, %ecx
+# CHECK-NEXT:  1      5     0.50    *                   tzcntl	(%rax), %ecx
+# CHECK-NEXT:  1      1     0.50                        tzcntq	%rax, %rcx
+# CHECK-NEXT:  1      5     0.50    *                   tzcntq	(%rax), %rcx
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -103,7 +103,7 @@ tzcnt       (%rax), %rcx
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 4.33   4.33   4.33   5.00   9.50   9.50   5.00    -      -      -      -      -      -      -      -     4.33   4.33   4.33   4.33   4.33   4.33    -      -
+# CHECK-NEXT: 4.33   4.33   4.33   4.25   8.75   8.75   4.25    -      -      -      -      -      -      -      -     4.33   4.33   4.33   4.33   4.33   4.33    -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -127,7 +127,7 @@ tzcnt       (%rax), %rcx
 # CHECK-NEXT: 0.33   0.33   0.33   0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     blsrl	(%rax), %ecx
 # CHECK-NEXT:  -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     blsrq	%rax, %rcx
 # CHECK-NEXT: 0.33   0.33   0.33   0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     blsrq	(%rax), %rcx
-# CHECK-NEXT:  -      -      -     1.00   1.00   1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     tzcntw	%ax, %cx
+# CHECK-NEXT:  -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     tzcntw	%ax, %cx
 # CHECK-NEXT: 0.33   0.33   0.33    -     0.50   0.50    -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     tzcntw	(%rax), %cx
 # CHECK-NEXT:  -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     tzcntl	%eax, %ecx
 # CHECK-NEXT: 0.33   0.33   0.33    -     0.50   0.50    -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     tzcntl	(%rax), %ecx
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s
index 64feeaf6d4ad8..903cca3b913b5 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s
@@ -15,10 +15,10 @@ lock cmpxchg16b (%rax)
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  19     3     6.00    *      *            cmpxchg8b	(%rax)
-# CHECK-NEXT:  28     4     14.75   *      *            cmpxchg16b	(%rax)
-# CHECK-NEXT:  19     3     6.00    *      *            lock		cmpxchg8b	(%rax)
-# CHECK-NEXT:  28     4     14.75   *      *            lock		cmpxchg16b	(%rax)
+# CHECK-NEXT:  15     3     6.00    *      *            cmpxchg8b	(%rax)
+# CHECK-NEXT:  26     4     14.75   *      *            cmpxchg16b	(%rax)
+# CHECK-NEXT:  15     3     6.00    *      *            lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  26     4     14.75   *      *            lock		cmpxchg16b	(%rax)
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s
index d259949af3846..809b1bed70f08 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s
@@ -170,11 +170,11 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	(,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	(,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(,%ebx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	(,%ebx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	(,%ebx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	(,%ebx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	(,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(,%rbx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	(,%rbx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	(,%rbx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	(,%rbx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	(,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(%eax,%ebx), %cx
 # CHECK-NEXT:  1      1     0.33                        leal	(%eax,%ebx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	(%eax,%ebx), %rcx
@@ -188,11 +188,11 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	(%rax,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(%eax,%ebx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	(%eax,%ebx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	(%eax,%ebx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	(%eax,%ebx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	(%eax,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(%rax,%rbx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	(%rax,%rbx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	(%rax,%rbx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	(%rax,%rbx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	(%rax,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16, %cx
 # CHECK-NEXT:  1      1     0.33                        leal	-16, %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	-16, %rcx
@@ -215,29 +215,29 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	-16(,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	-16(,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(,%ebx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(,%ebx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(,%ebx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(,%ebx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(,%rbx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(,%rbx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(,%rbx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(,%rbx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%eax,%ebx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(%eax,%ebx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(%eax,%ebx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(%eax,%ebx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%rax,%rbx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(%rax,%rbx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(%rax,%rbx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(%rax,%rbx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%eax,%ebx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(%eax,%ebx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(%eax,%ebx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(%eax,%ebx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%rax,%rbx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(%rax,%rbx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(%rax,%rbx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(%rax,%rbx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%eax,%ebx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(%eax,%ebx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(%eax,%ebx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(%eax,%ebx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(%eax,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%rax,%rbx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	-16(%rax,%rbx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	-16(%rax,%rbx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	-16(%rax,%rbx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	-16(%rax,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024, %cx
 # CHECK-NEXT:  1      1     0.33                        leal	1024, %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	1024, %rcx
@@ -260,29 +260,29 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	1024(,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	1024(,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(,%ebx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(,%ebx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(,%ebx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(,%ebx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(,%rbx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(,%rbx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(,%rbx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(,%rbx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%eax,%ebx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(%eax,%ebx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(%eax,%ebx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(%eax,%ebx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%rax,%rbx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(%rax,%rbx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(%rax,%rbx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(%rax,%rbx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%eax,%ebx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(%eax,%ebx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(%eax,%ebx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(%eax,%ebx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%rax,%rbx), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(%rax,%rbx), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(%rax,%rbx), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(%rax,%rbx), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%eax,%ebx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(%eax,%ebx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(%eax,%ebx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(%eax,%ebx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(%eax,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%rax,%rbx,2), %cx
-# CHECK-NEXT:  2      2     0.25                        leal	1024(%rax,%rbx,2), %ecx
-# CHECK-NEXT:  2      2     0.25                        leaq	1024(%rax,%rbx,2), %rcx
+# CHECK-NEXT:  4      3     0.25                        leal	1024(%rax,%rbx,2), %ecx
+# CHECK-NEXT:  4      3     0.25                        leaq	1024(%rax,%rbx,2), %rcx
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-pclmul.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-pclmul.s
index a36fb2aabe486..fc2bc8e21bf14 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-pclmul.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-pclmul.s
@@ -13,8 +13,8 @@ pclmulqdq     $11, (%rax), %xmm2
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  4      4     2.00                        pclmulqdq	$11, %xmm0, %xmm2
-# CHECK-NEXT:  4      11    2.00    *                   pclmulqdq	$11, (%rax), %xmm2
+# CHECK-NEXT:  4      4     1.50                        pclmulqdq	$11, %xmm0, %xmm2
+# CHECK-NEXT:  4      11    1.50    *                   pclmulqdq	$11, (%rax), %xmm2
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -43,9 +43,9 @@ pclmulqdq     $11, (%rax), %xmm2
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     4.00   4.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     3.00   3.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     pclmulqdq	$11, %xmm0, %xmm2
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     pclmulqdq	$11, (%rax), %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -      -      -      -      -      -      -      -      -      -      -      -     pclmulqdq	$11, %xmm0, %xmm2
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     pclmulqdq	$11, (%rax), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse42.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse42.s
index 015d37e3e6296..ae608354e2a6f 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse42.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-sse42.s
@@ -52,12 +52,12 @@ pcmpgtq     (%rax), %xmm2
 # CHECK-NEXT:  1      7     1.00    *                   crc32q	(%rax), %rcx
 # CHECK-NEXT:  8      6     3.00                        pcmpestri	$1, %xmm0, %xmm2
 # CHECK-NEXT:  12     13    3.00    *                   pcmpestri	$1, (%rax), %xmm2
-# CHECK-NEXT:  7      6     3.00                        pcmpestrm	$1, %xmm0, %xmm2
-# CHECK-NEXT:  12     13    3.00    *                   pcmpestrm	$1, (%rax), %xmm2
+# CHECK-NEXT:  7      7     3.00                        pcmpestrm	$1, %xmm0, %xmm2
+# CHECK-NEXT:  12     14    3.00    *                   pcmpestrm	$1, (%rax), %xmm2
 # CHECK-NEXT:  4      2     2.00                        pcmpistri	$1, %xmm0, %xmm2
 # CHECK-NEXT:  4      9     2.00    *                   pcmpistri	$1, (%rax), %xmm2
-# CHECK-NEXT:  3      6     2.00                        pcmpistrm	$1, %xmm0, %xmm2
-# CHECK-NEXT:  4      13    2.00    *                   pcmpistrm	$1, (%rax), %xmm2
+# CHECK-NEXT:  3      7     2.00                        pcmpistrm	$1, %xmm0, %xmm2
+# CHECK-NEXT:  4      14    2.00    *                   pcmpistrm	$1, (%rax), %xmm2
 # CHECK-NEXT:  1      1     0.25                        pcmpgtq	%xmm0, %xmm2
 # CHECK-NEXT:  1      8     0.50    *                   pcmpgtq	(%rax), %xmm2
 
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-vpclmulqdq.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-vpclmulqdq.s
index 55a36d0f1ea09..dca470338b5a4 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-vpclmulqdq.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-vpclmulqdq.s
@@ -13,8 +13,8 @@ vpclmulqdq    $11, (%rax), %ymm1, %ymm3
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  4      4     2.00                        vpclmulqdq	$11, %ymm0, %ymm1, %ymm3
-# CHECK-NEXT:  4      11    2.00    *                   vpclmulqdq	$11, (%rax), %ymm1, %ymm3
+# CHECK-NEXT:  4      4     1.50                        vpclmulqdq	$11, %ymm0, %ymm1, %ymm3
+# CHECK-NEXT:  4      11    1.50    *                   vpclmulqdq	$11, (%rax), %ymm1, %ymm3
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -43,9 +43,9 @@ vpclmulqdq    $11, (%rax), %ymm1, %ymm3
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     4.00   4.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     3.00   3.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %ymm0, %ymm1, %ymm3
-# CHECK-NEXT:  -      -      -      -      -      -      -      -     2.00   2.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %ymm1, %ymm3
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -      -      -      -      -      -      -      -      -      -      -      -     vpclmulqdq	$11, %ymm0, %ymm1, %ymm3
+# CHECK-NEXT:  -      -      -      -      -      -      -      -     1.50   1.50    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpclmulqdq	$11, (%rax), %ymm1, %ymm3
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-x86_64.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-x86_64.s
index 9c5b4e45896de..886d9c6930418 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-x86_64.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-x86_64.s
@@ -1173,18 +1173,18 @@ xorq (%rax), %rdi
 # CHECK-NEXT:  1      6     0.67    *      *            andq	%rsi, (%rax)
 # CHECK-NEXT:  1      6     0.67    *      *            lock		andq	%rsi, (%rax)
 # CHECK-NEXT:  1      5     0.33    *                   andq	(%rax), %rdi
-# CHECK-NEXT:  6      1     1.00                        bsfw	%si, %di
-# CHECK-NEXT:  6      1     1.00                        bsrw	%si, %di
-# CHECK-NEXT:  7      5     1.00    *                   bsfw	(%rax), %di
-# CHECK-NEXT:  7      5     1.00    *                   bsrw	(%rax), %di
-# CHECK-NEXT:  6      1     1.00                        bsfl	%esi, %edi
-# CHECK-NEXT:  6      1     1.00                        bsrl	%esi, %edi
-# CHECK-NEXT:  7      5     1.00    *                   bsfl	(%rax), %edi
-# CHECK-NEXT:  7      5     1.00    *                   bsrl	(%rax), %edi
-# CHECK-NEXT:  6      1     1.00                        bsfq	%rsi, %rdi
-# CHECK-NEXT:  6      1     1.00                        bsrq	%rsi, %rdi
-# CHECK-NEXT:  7      5     1.00    *                   bsfq	(%rax), %rdi
-# CHECK-NEXT:  7      5     1.00    *                   bsrq	(%rax), %rdi
+# CHECK-NEXT:  1      1     1.00                        bsfw	%si, %di
+# CHECK-NEXT:  1      1     1.00                        bsrw	%si, %di
+# CHECK-NEXT:  2      5     1.00    *                   bsfw	(%rax), %di
+# CHECK-NEXT:  2      5     1.00    *                   bsrw	(%rax), %di
+# CHECK-NEXT:  1      1     1.00                        bsfl	%esi, %edi
+# CHECK-NEXT:  1      1     1.00                        bsrl	%esi, %edi
+# CHECK-NEXT:  2      5     1.00    *                   bsfl	(%rax), %edi
+# CHECK-NEXT:  2      5     1.00    *                   bsrl	(%rax), %edi
+# CHECK-NEXT:  1      1     1.00                        bsfq	%rsi, %rdi
+# CHECK-NEXT:  1      1     1.00                        bsrq	%rsi, %rdi
+# CHECK-NEXT:  2      5     1.00    *                   bsfq	(%rax), %rdi
+# CHECK-NEXT:  2      5     1.00    *                   bsrq	(%rax), %rdi
 # CHECK-NEXT:  1      1     0.25                        bswapl	%eax
 # CHECK-NEXT:  1      1     0.25                        bswapq	%rax
 # CHECK-NEXT:  1      1     0.50                        btw	%si, %di
@@ -1321,23 +1321,23 @@ xorq (%rax), %rdi
 # CHECK-NEXT:  1      1     0.25                        decq	%rdi
 # CHECK-NEXT:  1      6     0.67    *      *            decq	(%rax)
 # CHECK-NEXT:  1      6     0.67    *      *            lock		decq	(%rax)
-# CHECK-NEXT:  2      10    10.00                 U     divb	%dil
-# CHECK-NEXT:  2      14    10.00   *             U     divb	(%rax)
-# CHECK-NEXT:  2      11    11.00                 U     divw	%si
-# CHECK-NEXT:  2      15    11.00   *             U     divw	(%rax)
-# CHECK-NEXT:  2      13    13.00                 U     divl	%edx
-# CHECK-NEXT:  2      17    13.00   *             U     divl	(%rax)
-# CHECK-NEXT:  2      17    17.00                 U     divq	%rcx
-# CHECK-NEXT:  2      21    17.00   *             U     divq	(%rax)
+# CHECK-NEXT:  2      9     9.00                  U     divb	%dil
+# CHECK-NEXT:  2      13    9.00    *             U     divb	(%rax)
+# CHECK-NEXT:  2      10    10.00                 U     divw	%si
+# CHECK-NEXT:  2      14    10.00   *             U     divw	(%rax)
+# CHECK-NEXT:  2      12    12.00                 U     divl	%edx
+# CHECK-NEXT:  2      16    12.00   *             U     divl	(%rax)
+# CHECK-NEXT:  2      18    18.00                 U     divq	%rcx
+# CHECK-NEXT:  2      22    18.00   *             U     divq	(%rax)
 # CHECK-NEXT:  100    100   25.00                 U     enter	$7, $4095
-# CHECK-NEXT:  2      10    10.00                 U     idivb	%dil
-# CHECK-NEXT:  2      14    10.00   *             U     idivb	(%rax)
-# CHECK-NEXT:  2      11    11.00                 U     idivw	%si
-# CHECK-NEXT:  2      15    11.00   *             U     idivw	(%rax)
-# CHECK-NEXT:  2      13    13.00                 U     idivl	%edx
-# CHECK-NEXT:  2      17    13.00   *             U     idivl	(%rax)
-# CHECK-NEXT:  2      17    17.00                 U     idivq	%rcx
-# CHECK-NEXT:  2      21    17.00   *             U     idivq	(%rax)
+# CHECK-NEXT:  2      9     9.00                  U     idivb	%dil
+# CHECK-NEXT:  2      13    9.00    *             U     idivb	(%rax)
+# CHECK-NEXT:  2      10    10.00                 U     idivw	%si
+# CHECK-NEXT:  2      14    10.00   *             U     idivw	(%rax)
+# CHECK-NEXT:  2      12    12.00                 U     idivl	%edx
+# CHECK-NEXT:  2      16    12.00   *             U     idivl	(%rax)
+# CHECK-NEXT:  2      18    18.00                 U     idivq	%rcx
+# CHECK-NEXT:  2      22    18.00   *             U     idivq	(%rax)
 # CHECK-NEXT:  1      3     3.00                        imulb	%dil
 # CHECK-NEXT:  1      7     3.00    *                   imulb	(%rax)
 # CHECK-NEXT:  3      3     3.00                        imulw	%di
@@ -1891,12 +1891,12 @@ xorq (%rax), %rdi
 # CHECK-NEXT:  1      5     0.67    *      *            xaddq	%rax, (%rbx)
 # CHECK-NEXT:  1      5     0.67    *      *            lock		xaddq	%rax, (%rbx)
 # CHECK-NEXT:  2      1     0.50                        xchgb	%bl, %cl
-# CHECK-NEXT:  5      7     0.50    *      *            xchgb	%bl, (%rbx)
-# CHECK-NEXT:  5      7     0.50    *      *            lock		xchgb	%bl, (%rbx)
+# CHECK-NEXT:  2      7     0.50    *      *            xchgb	%bl, (%rbx)
+# CHECK-NEXT:  2      7     0.50    *      *            lock		xchgb	%bl, (%rbx)
 # CHECK-NEXT:  2      1     0.50                        xchgw	%bx, %ax
 # CHECK-NEXT:  2      1     0.50                        xchgw	%bx, %cx
-# CHECK-NEXT:  5      7     0.50    *      *            xchgw	%ax, (%rbx)
-# CHECK-NEXT:  5      7     0.50    *      *            lock		xchgw	%ax, (%rbx)
+# CHECK-NEXT:  2      7     0.50    *      *            xchgw	%ax, (%rbx)
+# CHECK-NEXT:  2      7     0.50    *      *            lock		xchgw	%ax, (%rbx)
 # CHECK-NEXT:  2      0     0.33                        xchgl	%ebx, %eax
 # CHECK-NEXT:  2      0     0.33                        xchgl	%ebx, %ecx
 # CHECK-NEXT:  2      6     0.50    *      *            xchgl	%eax, (%rbx)
@@ -1975,7 +1975,7 @@ xorq (%rax), %rdi
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 259.00 259.00 259.00 1733.00 1865.50 1775.50 1529.50 1.50  -    -      -      -      -      -      -     259.00 259.00 259.00 151.67 151.67 151.67 161.00 161.00
+# CHECK-NEXT: 259.00 259.00 259.00 1725.00 1865.50 1775.50 1529.50 1.50  -    -      -      -      -      -      -     259.00 259.00 259.00 151.67 151.67 151.67 161.00 161.00
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -2266,23 +2266,23 @@ xorq (%rax), %rdi
 # CHECK-NEXT:  -      -      -     0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     decq	%rdi
 # CHECK-NEXT: 0.67   0.67   0.67   0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -     0.67   0.67   0.67   0.33   0.33   0.33   0.50   0.50   decq	(%rax)
 # CHECK-NEXT: 0.67   0.67   0.67   0.25   0.25   0.25   0.25    -      -      -      -      -      -      -      -     0.67   0.67   0.67   0.33   0.33   0.33   0.50   0.50   lock		decq	(%rax)
-# CHECK-NEXT:  -      -      -     10.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divb	%dil
-# CHECK-NEXT: 0.33   0.33   0.33   10.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divb	(%rax)
-# CHECK-NEXT:  -      -      -     11.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divw	%si
-# CHECK-NEXT: 0.33   0.33   0.33   11.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divw	(%rax)
-# CHECK-NEXT:  -      -      -     13.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divl	%edx
-# CHECK-NEXT: 0.33   0.33   0.33   13.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divl	(%rax)
-# CHECK-NEXT:  -      -      -     17.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divq	%rcx
-# CHECK-NEXT: 0.33   0.33   0.33   17.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divq	(%rax)
+# CHECK-NEXT:  -      -      -     9.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divb	%dil
+# CHECK-NEXT: 0.33   0.33   0.33   9.00    -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divb	(%rax)
+# CHECK-NEXT:  -      -      -     10.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divw	%si
+# CHECK-NEXT: 0.33   0.33   0.33   10.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divw	(%rax)
+# CHECK-NEXT:  -      -      -     12.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divl	%edx
+# CHECK-NEXT: 0.33   0.33   0.33   12.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divl	(%rax)
+# CHECK-NEXT:  -      -      -     18.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     divq	%rcx
+# CHECK-NEXT: 0.33   0.33   0.33   18.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     divq	(%rax)
 # CHECK-NEXT:  -      -      -     25.00  25.00  25.00  25.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     enter	$7, $4095
-# CHECK-NEXT:  -      -      -     10.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivb	%dil
-# CHECK-NEXT: 0.33   0.33   0.33   10.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivb	(%rax)
-# CHECK-NEXT:  -      -      -     11.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivw	%si
-# CHECK-NEXT: 0.33   0.33   0.33   11.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivw	(%rax)
-# CHECK-NEXT:  -      -      -     13.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivl	%edx
-# CHECK-NEXT: 0.33   0.33   0.33   13.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivl	(%rax)
-# CHECK-NEXT:  -      -      -     17.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivq	%rcx
-# CHECK-NEXT: 0.33   0.33   0.33   17.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivq	(%rax)
+# CHECK-NEXT:  -      -      -     9.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivb	%dil
+# CHECK-NEXT: 0.33   0.33   0.33   9.00    -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivb	(%rax)
+# CHECK-NEXT:  -      -      -     10.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivw	%si
+# CHECK-NEXT: 0.33   0.33   0.33   10.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivw	(%rax)
+# CHECK-NEXT:  -      -      -     12.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivl	%edx
+# CHECK-NEXT: 0.33   0.33   0.33   12.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivl	(%rax)
+# CHECK-NEXT:  -      -      -     18.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     idivq	%rcx
+# CHECK-NEXT: 0.33   0.33   0.33   18.00   -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     idivq	(%rax)
 # CHECK-NEXT:  -      -      -      -     3.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     imulb	%dil
 # CHECK-NEXT: 0.33   0.33   0.33    -     3.00    -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     imulb	(%rax)
 # CHECK-NEXT:  -      -      -      -     3.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     imulw	%di

From de26eec10021d441980eed7bb8be6878bc5086e5 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 13:40:34 -0500
Subject: [PATCH 15/20] revert LEA changes

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 9e3939b60408f..3d6121ff1655f 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -586,11 +586,10 @@ def : InstRW<[Zn4WriteADC8mr_SBB8mr], (instrs ADC8mr, SBB8mr)>;
 defm : Zn4WriteResInt<WriteLEA, [Zn4AGU012], 1, [1], 1>;     // LEA instructions can't fold loads.
 
 // This write is used for slow LEA instructions.
-// values from uops.info
 def Zn4Write3OpsLEA : SchedWriteRes<[Zn4ALU0123]> {
-  let Latency = 3;
+  let Latency = 2;
   let ReleaseAtCycles = [1];
-  let NumMicroOps = 4;
+  let NumMicroOps = 2;
 }
 
 // On Znver4, a slow LEA is either a 3Ops LEA (base, index, offset),

From ceec220213d7df57e1645d095f0f36fba40be6ff Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 13:41:06 -0500
Subject: [PATCH 16/20] CMPXCHG8B better TP

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 3d6121ff1655f..c0698135fce6a 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -661,7 +661,7 @@ def : InstRW<[Zn4WriteCMPXCHG8rm_LCMPXCHG8], (instrs CMPXCHG8rm, LCMPXCHG8)>;
 
 def Zn4WriteCMPXCHG8B : SchedWriteRes<[Zn4ALU0123]> {
   let Latency = 3; // FIXME: not from llvm-exegesis
-  let ReleaseAtCycles = [24];
+  let ReleaseAtCycles = [20];
   let NumMicroOps = 15;
 }
 def : InstRW<[Zn4WriteCMPXCHG8B], (instrs CMPXCHG8B)>;

From 3f10cb456d9efe098c509f56d8414013af10d127 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 14:04:02 -0500
Subject: [PATCH 17/20] VPERMD uops

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index c0698135fce6a..4b136f22b44ca 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1408,8 +1408,8 @@ def : InstRW<[Zn4WriteVPERMYri], (instrs VPERMPDYri, VPERMQYri)>;
 
 def Zn4WriteVPERMPDYmi : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
   let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMYri.Latency);
-  let ReleaseAtCycles = [1, 1, 2];
-  let NumMicroOps = !add(Zn4WriteVPERMYri.NumMicroOps, 1);
+  let ReleaseAtCycles = [1, 1, 1];
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMPDYmi], (instrs VPERMPDYmi)>;
 
@@ -1422,8 +1422,8 @@ def : InstRW<[Zn4WriteVPERMDYrr], (instrs VPERMDYrr)>;
 
 def Zn4WriteVPERMYm : SchedWriteRes<[Zn4AGU012, Zn4Load, Zn4FPVShuf]> {
   let Latency = !add(Znver4Model.VecLoadLatency, Zn4WriteVPERMDYrr.Latency);
-  let ReleaseAtCycles = [1, 1, 2];
-  let NumMicroOps = !add(Zn4WriteVPERMDYrr.NumMicroOps, 0);
+  let ReleaseAtCycles = [1, 1, 1];
+  let NumMicroOps = 1;
 }
 def : InstRW<[Zn4WriteVPERMYm], (instrs VPERMQYmi, VPERMDYrm)>;
 

From 02d554c5256b11776b18eef663e3acd1ccb203e8 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 14:08:52 -0500
Subject: [PATCH 18/20] fix CMPXCHG16B

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 4b136f22b44ca..3c97f5bec52b7 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -667,8 +667,8 @@ def Zn4WriteCMPXCHG8B : SchedWriteRes<[Zn4ALU0123]> {
 def : InstRW<[Zn4WriteCMPXCHG8B], (instrs CMPXCHG8B)>;
 
 def Zn4WriteCMPXCHG16B_LCMPXCHG16B : SchedWriteRes<[Zn4ALU0123]> {
-  let Latency = 4; // FIXME: not from llvm-exegesis
-  let ReleaseAtCycles = [59];
+  let Latency = 2; // FIXME: not from llvm-exegesis
+  let ReleaseAtCycles = [40];
   let NumMicroOps = 26;
 }
 def : InstRW<[Zn4WriteCMPXCHG16B_LCMPXCHG16B], (instrs CMPXCHG16B, LCMPXCHG16B)>;

From e4c785294443d0abbff57712bbe2007429eed2c1 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 14:13:21 -0500
Subject: [PATCH 19/20] VALIGN has different latency depending on width

---
 llvm/lib/Target/X86/X86ScheduleZnver4.td | 28 +++++++++++++++++++-----
 1 file changed, 22 insertions(+), 6 deletions(-)

diff --git a/llvm/lib/Target/X86/X86ScheduleZnver4.td b/llvm/lib/Target/X86/X86ScheduleZnver4.td
index 3c97f5bec52b7..ac4d31de8dbfe 100644
--- a/llvm/lib/Target/X86/X86ScheduleZnver4.td
+++ b/llvm/lib/Target/X86/X86ScheduleZnver4.td
@@ -1109,15 +1109,31 @@ def Zn4WriteVecOpMaskKRMov : SchedWriteRes<[Zn4FPOpMask4]> {
 }
 def : InstRW<[Zn4WriteVecOpMaskKRMov], (instrs KMOVBkr, KMOVDkr, KMOVQkr, KMOVWkr)>;
 
-def Zn4WriteVecALU2Slow : SchedWriteRes<[Zn4FPVAdd12]> {
-  // TODO: All align instructions are expected to be of 4 cycle latency
-  let Latency = 4;
+// 128-bit VALIGN
+def Zn4WriteXMMVecALU2Slow : SchedWriteRes<[Zn4FPVAdd12]> {
+  let Latency = 2;
+  let ReleaseAtCycles = [1];
+  let NumMicroOps = 1;
+}
+
+// 256-bit VALIGN
+def Zn4WriteYMMVecALU2Slow : SchedWriteRes<[Zn4FPVAdd12]> {
+  let Latency = 3;
   let ReleaseAtCycles = [1];
   let NumMicroOps = 1;
 }
-def : InstRW<[Zn4WriteVecALU2Slow], (instrs VALIGNDZrri, VALIGNDZ128rri, VALIGNDZ256rri,
-                                            VALIGNQZrri, VALIGNQZ128rri, VALIGNQZ256rri)
-                                            >;
+
+// 512-bit VALIGN
+def Zn4WriteZMMVecALU2Slow : SchedWriteRes<[Zn4FPVAdd12]> {
+  let Latency = 4;
+  let ReleaseAtCycles = [2];
+  let NumMicroOps = 1;
+}
+
+def : InstRW<[Zn4WriteXMMVecALU2Slow], (instrs VALIGNDZrri, VALIGNQZrri)>;
+def : InstRW<[Zn4WriteYMMVecALU2Slow], (instrs VALIGNDZ128rri, VALIGNQZ128rri)>;
+def : InstRW<[Zn4WriteZMMVecALU2Slow], (instrs VALIGNDZ256rri, VALIGNQZ256rri)>;
+
 defm : Zn4WriteResYMMPair<WriteVecALUY, [Zn4FPVAdd0123], 1, [1], 1>; // Vector integer ALU op, no logicals (YMM).
 
 def Zn4WriteVecALUYSlow : SchedWriteRes<[Zn4FPVAdd01]> {

From d300f5ee38bd0fa242533fa5407b890a0bbba2a2 Mon Sep 17 00:00:00 2001
From: NexusXe <andastrike@gmail.com>
Date: Wed, 1 Oct 2025 14:15:38 -0500
Subject: [PATCH 20/20] update resource files

---
 .../llvm-mca/X86/Znver4/resources-avx2.s      | 14 ++--
 .../llvm-mca/X86/Znver4/resources-avx512.s    |  4 +-
 .../llvm-mca/X86/Znver4/resources-avx512vl.s  | 14 ++--
 .../llvm-mca/X86/Znver4/resources-cmpxchg.s   | 18 ++---
 .../tools/llvm-mca/X86/Znver4/resources-lea.s | 80 +++++++++----------
 5 files changed, 65 insertions(+), 65 deletions(-)

diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
index 2851632869865..6c8fac4566498 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx2.s
@@ -561,13 +561,13 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      3     1.00                        vperm2i128	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      8     1.00    *                   vperm2i128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      4     1.00                        vpermd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT:  1      11    2.00    *                   vpermd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT:  1      11    1.00    *                   vpermd	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      4     1.00                        vpermpd	$1, %ymm0, %ymm2
-# CHECK-NEXT:  2      11    2.00    *                   vpermpd	$1, (%rax), %ymm2
+# CHECK-NEXT:  1      11    1.00    *                   vpermpd	$1, (%rax), %ymm2
 # CHECK-NEXT:  1      4     1.00                        vpermps	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  1      11    1.00    *                   vpermps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  1      4     1.00                        vpermq	$1, %ymm0, %ymm2
-# CHECK-NEXT:  1      11    2.00    *                   vpermq	$1, (%rax), %ymm2
+# CHECK-NEXT:  1      11    1.00    *                   vpermq	$1, (%rax), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdd	%ymm0, (%rax,%ymm1,2), %ymm2
 # CHECK-NEXT:  1      5     0.33    *                   vpgatherdq	%xmm0, (%rax,%xmm1,2), %xmm2
@@ -789,7 +789,7 @@ vpxor           (%rax), %ymm1, %ymm2
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 6.67   6.67   6.67    -      -      -      -      -     93.75  131.75 92.25  36.25  80.50  80.50  29.00  52.33  52.33  52.33  50.67  50.67  50.67  2.50   2.50
+# CHECK-NEXT: 6.67   6.67   6.67    -      -      -      -      -     93.75  128.75 92.25  36.25  80.50  80.50  29.00  52.33  52.33  52.33  50.67  50.67  50.67  2.50   2.50
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -894,13 +894,13 @@ vpxor           (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vperm2i128	$1, %ymm0, %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vperm2i128	$1, (%rax), %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermd	%ymm0, %ymm1, %ymm2
-# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     2.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermd	(%rax), %ymm1, %ymm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     1.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermd	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermpd	$1, %ymm0, %ymm2
-# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     2.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermpd	$1, (%rax), %ymm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     1.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermpd	$1, (%rax), %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermps	%ymm0, %ymm1, %ymm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     1.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermps	(%rax), %ymm1, %ymm2
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00    -      -      -      -      -      -      -      -      -      -      -      -      -     vpermq	$1, %ymm0, %ymm2
-# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     2.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermq	$1, (%rax), %ymm2
+# CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -     1.00    -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpermq	$1, (%rax), %ymm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpgatherdd	%xmm0, (%rax,%xmm1,2), %xmm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpgatherdd	%ymm0, (%rax,%ymm1,2), %ymm2
 # CHECK-NEXT: 0.33   0.33   0.33    -      -      -      -      -      -      -      -      -      -      -      -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     vpgatherdq	%xmm0, (%rax,%xmm1,2), %xmm2
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512.s
index 72d7de3353346..14b8e5f36c666 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512.s
@@ -1207,7 +1207,7 @@ vunpcklps         (%rax){1to16}, %zmm17, %zmm19 {z}{k1}
 # CHECK-NEXT:  1      3     1.00                        vaddps	%zmm16, %zmm17, %zmm19 {%k1} {z}
 # CHECK-NEXT:  1      10    1.00    *                   vaddps	(%rax), %zmm17, %zmm19 {%k1} {z}
 # CHECK-NEXT:  1      10    1.00    *                   vaddps	(%rax){1to16}, %zmm17, %zmm19 {%k1} {z}
-# CHECK-NEXT:  1      4     0.50                        valignd	$1, %zmm16, %zmm17, %zmm19
+# CHECK-NEXT:  1      2     0.50                        valignd	$1, %zmm16, %zmm17, %zmm19
 # CHECK-NEXT:  1      8     1.00    *                   valignd	$1, (%rax), %zmm17, %zmm19
 # CHECK-NEXT:  1      8     1.00    *                   valignd	$1, (%rax){1to16}, %zmm17, %zmm19
 # CHECK-NEXT:  1      1     1.00                        valignd	$1, %zmm16, %zmm17, %zmm19 {%k1}
@@ -1216,7 +1216,7 @@ vunpcklps         (%rax){1to16}, %zmm17, %zmm19 {z}{k1}
 # CHECK-NEXT:  1      1     1.00                        valignd	$1, %zmm16, %zmm17, %zmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     1.00    *                   valignd	$1, (%rax), %zmm17, %zmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     1.00    *                   valignd	$1, (%rax){1to16}, %zmm17, %zmm19 {%k1} {z}
-# CHECK-NEXT:  1      4     0.50                        valignq	$1, %zmm16, %zmm17, %zmm19
+# CHECK-NEXT:  1      2     0.50                        valignq	$1, %zmm16, %zmm17, %zmm19
 # CHECK-NEXT:  1      8     1.00    *                   valignq	$1, (%rax), %zmm17, %zmm19
 # CHECK-NEXT:  1      8     1.00    *                   valignq	$1, (%rax){1to8}, %zmm17, %zmm19
 # CHECK-NEXT:  1      1     1.00                        valignq	$1, %zmm16, %zmm17, %zmm19 {%k1}
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vl.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vl.s
index 552b3e40284b9..ead609e33da4d 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vl.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-avx512vl.s
@@ -1948,7 +1948,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  1      3     0.50                        vaddps	%ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      10    0.50    *                   vaddps	(%rax), %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      10    0.50    *                   vaddps	(%rax){1to8}, %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      4     0.50                        valignd	$1, %xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      3     0.50                        valignd	$1, %xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax), %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax){1to4}, %xmm17, %xmm19
 # CHECK-NEXT:  1      1     0.50                        valignd	$1, %xmm16, %xmm17, %xmm19 {%k1}
@@ -1957,7 +1957,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  1      1     0.50                        valignd	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax), %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax){1to4}, %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      4     0.50                        valignd	$1, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      4     1.00                        valignd	$1, %ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax), %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax){1to8}, %ymm17, %ymm19
 # CHECK-NEXT:  1      1     0.50                        valignd	$1, %ymm16, %ymm17, %ymm19 {%k1}
@@ -1966,7 +1966,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  1      1     0.50                        valignd	$1, %ymm16, %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax), %ymm17, %ymm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   valignd	$1, (%rax){1to8}, %ymm17, %ymm19 {%k1} {z}
-# CHECK-NEXT:  1      4     0.50                        valignq	$1, %xmm16, %xmm17, %xmm19
+# CHECK-NEXT:  1      3     0.50                        valignq	$1, %xmm16, %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   valignq	$1, (%rax), %xmm17, %xmm19
 # CHECK-NEXT:  1      8     0.50    *                   valignq	$1, (%rax){1to2}, %xmm17, %xmm19
 # CHECK-NEXT:  1      1     0.50                        valignq	$1, %xmm16, %xmm17, %xmm19 {%k1}
@@ -1975,7 +1975,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  1      1     0.50                        valignq	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   valignq	$1, (%rax), %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  1      8     0.50    *                   valignq	$1, (%rax){1to2}, %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  1      4     0.50                        valignq	$1, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  1      4     1.00                        valignq	$1, %ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   valignq	$1, (%rax), %ymm17, %ymm19
 # CHECK-NEXT:  1      8     0.50    *                   valignq	$1, (%rax){1to4}, %ymm17, %ymm19
 # CHECK-NEXT:  1      1     0.50                        valignq	$1, %ymm16, %ymm17, %ymm19 {%k1}
@@ -3614,7 +3614,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT: 10.67  10.67  10.67   -      -      -      -      -     208.00 1083.00 636.50 261.50 509.50 509.50 32.00 355.67 355.67 355.67 334.33 334.33 334.33 32.00  32.00
+# CHECK-NEXT: 10.67  10.67  10.67   -      -      -      -      -     208.00 1084.00 637.50 261.50 509.50 509.50 32.00 355.67 355.67 355.67 334.33 334.33 334.33 32.00  32.00
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
@@ -3663,7 +3663,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     valignd	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignd	$1, (%rax), %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignd	$1, (%rax){1to4}, %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     valignd	$1, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     valignd	$1, %ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignd	$1, (%rax), %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignd	$1, (%rax){1to8}, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     valignd	$1, %ymm16, %ymm17, %ymm19 {%k1}
@@ -3681,7 +3681,7 @@ vunpcklps         (%rax){1to8}, %ymm17, %ymm19 {z}{k1}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     valignq	$1, %xmm16, %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignq	$1, (%rax), %xmm17, %xmm19 {%k1} {z}
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignq	$1, (%rax){1to2}, %xmm17, %xmm19 {%k1} {z}
-# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     valignq	$1, %ymm16, %ymm17, %ymm19
+# CHECK-NEXT:  -      -      -      -      -      -      -      -      -     1.00   1.00    -      -      -      -      -      -      -      -      -      -      -      -     valignq	$1, %ymm16, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignq	$1, (%rax), %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -     0.50   0.50    -     0.33   0.33   0.33   0.33   0.33   0.33    -      -     valignq	$1, (%rax){1to4}, %ymm17, %ymm19
 # CHECK-NEXT:  -      -      -      -      -      -      -      -      -     0.50   0.50    -      -      -      -      -      -      -      -      -      -      -      -     valignq	$1, %ymm16, %ymm17, %ymm19 {%k1}
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s
index 903cca3b913b5..26a42fd9964b5 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-cmpxchg.s
@@ -15,10 +15,10 @@ lock cmpxchg16b (%rax)
 # CHECK-NEXT: [6]: HasSideEffects (U)
 
 # CHECK:      [1]    [2]    [3]    [4]    [5]    [6]    Instructions:
-# CHECK-NEXT:  15     3     6.00    *      *            cmpxchg8b	(%rax)
-# CHECK-NEXT:  26     4     14.75   *      *            cmpxchg16b	(%rax)
-# CHECK-NEXT:  15     3     6.00    *      *            lock		cmpxchg8b	(%rax)
-# CHECK-NEXT:  26     4     14.75   *      *            lock		cmpxchg16b	(%rax)
+# CHECK-NEXT:  15     3     5.00    *      *            cmpxchg8b	(%rax)
+# CHECK-NEXT:  26     2     10.00   *      *            cmpxchg16b	(%rax)
+# CHECK-NEXT:  15     3     5.00    *      *            lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  26     2     10.00   *      *            lock		cmpxchg16b	(%rax)
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
@@ -47,11 +47,11 @@ lock cmpxchg16b (%rax)
 
 # CHECK:      Resource pressure per iteration:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1]
-# CHECK-NEXT:  -      -      -     41.50  41.50  41.50  41.50   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -
+# CHECK-NEXT:  -      -      -     30.00  30.00  30.00  30.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -
 
 # CHECK:      Resource pressure by instruction:
 # CHECK-NEXT: [0]    [1]    [2]    [3]    [4]    [5]    [6]    [7]    [8]    [9]    [10]   [11]   [12.0] [12.1] [13]   [14.0] [14.1] [14.2] [15.0] [15.1] [15.2] [16.0] [16.1] Instructions:
-# CHECK-NEXT:  -      -      -     6.00   6.00   6.00   6.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg8b	(%rax)
-# CHECK-NEXT:  -      -      -     14.75  14.75  14.75  14.75   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg16b	(%rax)
-# CHECK-NEXT:  -      -      -     6.00   6.00   6.00   6.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg8b	(%rax)
-# CHECK-NEXT:  -      -      -     14.75  14.75  14.75  14.75   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg16b	(%rax)
+# CHECK-NEXT:  -      -      -     5.00   5.00   5.00   5.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg8b	(%rax)
+# CHECK-NEXT:  -      -      -     10.00  10.00  10.00  10.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     cmpxchg16b	(%rax)
+# CHECK-NEXT:  -      -      -     5.00   5.00   5.00   5.00    -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg8b	(%rax)
+# CHECK-NEXT:  -      -      -     10.00  10.00  10.00  10.00   -      -      -      -      -      -      -      -      -      -      -      -      -      -      -      -     lock		cmpxchg16b	(%rax)
diff --git a/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s b/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s
index 809b1bed70f08..d259949af3846 100644
--- a/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s
+++ b/llvm/test/tools/llvm-mca/X86/Znver4/resources-lea.s
@@ -170,11 +170,11 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	(,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	(,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(,%ebx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	(,%ebx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	(,%ebx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	(,%ebx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	(,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(,%rbx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	(,%rbx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	(,%rbx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	(,%rbx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	(,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(%eax,%ebx), %cx
 # CHECK-NEXT:  1      1     0.33                        leal	(%eax,%ebx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	(%eax,%ebx), %rcx
@@ -188,11 +188,11 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	(%rax,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(%eax,%ebx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	(%eax,%ebx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	(%eax,%ebx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	(%eax,%ebx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	(%eax,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	(%rax,%rbx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	(%rax,%rbx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	(%rax,%rbx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	(%rax,%rbx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	(%rax,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16, %cx
 # CHECK-NEXT:  1      1     0.33                        leal	-16, %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	-16, %rcx
@@ -215,29 +215,29 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	-16(,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	-16(,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(,%ebx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(,%ebx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(,%ebx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(,%ebx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(,%rbx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(,%rbx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(,%rbx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(,%rbx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%eax,%ebx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(%eax,%ebx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(%eax,%ebx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(%eax,%ebx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%rax,%rbx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(%rax,%rbx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(%rax,%rbx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(%rax,%rbx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%eax,%ebx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(%eax,%ebx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(%eax,%ebx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(%eax,%ebx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%rax,%rbx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(%rax,%rbx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(%rax,%rbx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(%rax,%rbx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%eax,%ebx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(%eax,%ebx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(%eax,%ebx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(%eax,%ebx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(%eax,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	-16(%rax,%rbx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	-16(%rax,%rbx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	-16(%rax,%rbx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	-16(%rax,%rbx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	-16(%rax,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024, %cx
 # CHECK-NEXT:  1      1     0.33                        leal	1024, %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	1024, %rcx
@@ -260,29 +260,29 @@ lea 1024(%rax, %rbx, 2), %rcx
 # CHECK-NEXT:  1      1     0.33                        leal	1024(,%rbx), %ecx
 # CHECK-NEXT:  1      1     0.33                        leaq	1024(,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(,%ebx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(,%ebx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(,%ebx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(,%ebx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(,%rbx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(,%rbx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(,%rbx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(,%rbx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(,%rbx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%eax,%ebx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(%eax,%ebx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(%eax,%ebx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(%eax,%ebx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%rax,%rbx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(%rax,%rbx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(%rax,%rbx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(%rax,%rbx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%eax,%ebx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(%eax,%ebx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(%eax,%ebx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(%eax,%ebx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(%eax,%ebx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%rax,%rbx), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(%rax,%rbx), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(%rax,%rbx), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(%rax,%rbx), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(%rax,%rbx), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%eax,%ebx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(%eax,%ebx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(%eax,%ebx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(%eax,%ebx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(%eax,%ebx,2), %rcx
 # CHECK-NEXT:  2      2     1.00                        leaw	1024(%rax,%rbx,2), %cx
-# CHECK-NEXT:  4      3     0.25                        leal	1024(%rax,%rbx,2), %ecx
-# CHECK-NEXT:  4      3     0.25                        leaq	1024(%rax,%rbx,2), %rcx
+# CHECK-NEXT:  2      2     0.25                        leal	1024(%rax,%rbx,2), %ecx
+# CHECK-NEXT:  2      2     0.25                        leaq	1024(%rax,%rbx,2), %rcx
 
 # CHECK:      Resources:
 # CHECK-NEXT: [0]   - Zn4AGU0
